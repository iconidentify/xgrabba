# XGrabba - Complete Crossplane Installation
# Apply with: kubectl apply -f https://raw.githubusercontent.com/iconidentify/xgrabba/main/deployments/crossplane/install.yaml
#
# Prerequisites:
# 1. Crossplane installed
# 2. provider-helm installed with ProviderConfig named "helm-provider"
# 3. GHCR credentials for pulling charts (see below)
# 4. Create secrets first (see below)
#
# Step 1: Create GHCR credentials for Helm chart pulls:
#   kubectl create secret generic ghcr-helm-credentials \
#     --namespace crossplane-system \
#     --from-file=credentials=<(echo '{"auths":{"ghcr.io":{"auth":"'$(echo -n "USERNAME:GITHUB_TOKEN" | base64)'"}}}')
#
# Step 2: Create the namespace and secrets:
#   kubectl create namespace xgrabba
#
#   # Create image pull secret (for Docker images)
#   kubectl create secret docker-registry ghcr-secret \
#     --namespace xgrabba \
#     --docker-server=ghcr.io \
#     --docker-username=USERNAME \
#     --docker-password=GITHUB_TOKEN
#
#   # Create app secrets
#   kubectl create secret generic xgrabba-secrets \
#     --namespace xgrabba \
#     --from-literal=api-key="$(openssl rand -hex 32)" \
#     --from-literal=grok-api-key="YOUR_GROK_API_KEY" \
#     --from-literal=samba-password="YOUR_SAMBA_PASSWORD"
#
# Step 3: Apply this file
#
# To enable Samba file sharing (for Mac/Windows), download this file and uncomment
# the samba section in the values, then add the samba-password secret reference.
#
---
apiVersion: v1
kind: Namespace
metadata:
  name: xgrabba
  labels:
    app.kubernetes.io/name: xgrabba
    app.kubernetes.io/managed-by: crossplane
---
apiVersion: helm.crossplane.io/v1beta1
kind: Release
metadata:
  name: xgrabba
spec:
  forProvider:
    chart:
      name: xgrabba
      repository: oci://ghcr.io/iconidentify/charts
      # Omit version for auto-updates, or pin: version: "0.1.0"
      pullSecretRef:
        name: ghcr-helm-credentials
        namespace: crossplane-system
    namespace: xgrabba
    wait: true
    waitTimeout: 5m0s
    values:
      replicaCount: 1
      image:
        repository: ghcr.io/iconidentify/xgrabba
        pullPolicy: IfNotPresent
      imagePullSecrets:
        - name: ghcr-secret
      config:
        server:
          host: "0.0.0.0"
          port: 9847
        storage:
          basePath: "/data/videos"
          tempPath: "/data/temp"
        worker:
          count: 2
        grok:
          model: "grok-3"
      persistence:
        enabled: true
        size: 100Gi
      resources:
        requests:
          cpu: 200m
          memory: 256Mi
        limits:
          cpu: "1"
          memory: 4Gi
      # Uncomment to enable Samba file sharing (browse archives from Mac/Windows)
      # samba:
      #   enabled: true
      #   username: xgrabba
      #   shareName: archives
      #   service:
      #     type: LoadBalancer
    set:
      - name: secrets.apiKey
        valueFrom:
          secretKeyRef:
            name: xgrabba-secrets
            key: api-key
            namespace: xgrabba
      - name: secrets.grokApiKey
        valueFrom:
          secretKeyRef:
            name: xgrabba-secrets
            key: grok-api-key
            namespace: xgrabba
      # Uncomment for Samba file sharing:
      # - name: samba.password
      #   valueFrom:
      #     secretKeyRef:
      #       name: xgrabba-secrets
      #       key: samba-password
      #       namespace: xgrabba
  providerConfigRef:
    name: helm-provider
