<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xgrabba</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2314b8a6'/%3E%3Cstop offset='100%25' stop-color='%230891b2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M20 8 L8 8 L8 40' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M108 8 L120 8 L120 40' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M20 120 L8 120 L8 88' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M108 120 L120 120 L120 88' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M40 40 L88 88 M88 40 L40 88' stroke='%23e7e9ea' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Brand colors */
            --brand-start: #14b8a6;
            --brand-end: #0891b2;
            --brand-gradient: linear-gradient(135deg, #14b8a6, #0891b2);
            /* Refined neutral color palette - sophisticated and minimal */
            --bg-primary: #0f1419;
            --bg-secondary: #16181c;
            --bg-hover: #1d1f23;
            --bg-elevated: #202327;
            --border-color: #2f3336;
            --border-subtle: #252829;
            --text-primary: #e7e9ea;
            --text-secondary: #71767b;
            --text-muted: #536471;
            --accent-primary: #1d9bf0;
            --accent-hover: #1a8cd8;
            --accent-subtle: rgba(29, 155, 240, 0.1);
            --danger: #f4212e;
            --danger-muted: #67070f;
            --success: #00ba7c;
            --retweet: #00ba7c;
            --like: #f91880;
            --reply: #1d9bf0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.4;
            font-size: 13px;
        }

        /* Header - Compact */
        .header {
            background: rgba(15, 20, 25, 0.85);
            border-bottom: 1px solid var(--border-subtle);
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(12px);
        }

        .header h1 {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header h1 svg {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }

        .stats {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .stats span {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Container - Tighter */
        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 12px;
        }

        /* Search Bar - Compact */
        .search-container {
            position: relative;
            margin-bottom: 12px;
        }

        .search-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .search-bar:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px var(--accent-subtle);
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
        }

        .search-bar input::placeholder {
            color: var(--text-muted);
        }

        .search-bar svg {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .search-bar:focus-within svg {
            color: var(--accent-primary);
        }

        .search-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .search-clear:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        .search-clear.visible {
            display: flex;
        }

        .search-results-info {
            font-size: 11px;
            color: var(--text-muted);
            padding: 6px 12px;
            display: none;
        }

        .search-results-info.visible {
            display: block;
        }

        .search-results-info strong {
            color: var(--text-secondary);
        }

        /* Tweet List - Timeline Style */
        .tweet-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Tweet Card - Compact Timeline Item */
        .tweet-card {
            background: var(--bg-secondary);
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tweet-card:last-child {
            border-bottom: none;
        }

        .tweet-card:hover {
            background: var(--bg-hover);
        }

        .tweet-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 6px;
        }

        .tweet-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-elevated);
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .tweet-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tweet-author {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: baseline;
            gap: 4px;
            flex-wrap: wrap;
        }

        .tweet-author-name {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 3px;
            color: var(--text-primary);
        }

        .verified-badge {
            width: 14px;
            height: 14px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .tweet-author-username {
            color: var(--text-muted);
            font-size: 12px;
        }

        .tweet-author-followers {
            color: var(--text-muted);
            font-size: 11px;
            margin-left: 6px;
            opacity: 0.7;
        }

        .tweet-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 6px 0;
        }

        .tweet-tag {
            background: var(--bg-primary);
            color: var(--accent-primary);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .tweet-tag-more {
            background: var(--bg-elevated);
            color: var(--text-muted);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .tweet-meta-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 1px;
        }

        .tweet-date {
            color: var(--text-muted);
            font-size: 11px;
        }

        .tweet-text {
            font-size: 12px;
            line-height: 1.45;
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tweet-text .highlight {
            background: var(--accent-subtle);
            border-radius: 2px;
            padding: 0 2px;
        }

        /* Media Thumbnails - Compact Grid */
        .tweet-media-preview {
            display: grid;
            gap: 2px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
            max-width: 280px;
        }

        .tweet-media-preview.single { grid-template-columns: 1fr; max-width: 220px; }
        .tweet-media-preview.double { grid-template-columns: 1fr 1fr; max-width: 280px; }
        .tweet-media-preview.triple { grid-template-columns: 1fr 1fr; max-width: 280px; }
        .tweet-media-preview.quad { grid-template-columns: 1fr 1fr; max-width: 280px; }

        .tweet-media-preview .media-thumb {
            position: relative;
            background: var(--bg-elevated);
            aspect-ratio: 16/10;
            overflow: hidden;
        }

        .tweet-media-preview.single .media-thumb {
            aspect-ratio: 16/9;
        }

        .tweet-media-preview .media-thumb img,
        .tweet-media-preview .media-thumb video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tweet-media-preview .video-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.75);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .tweet-media-preview .video-indicator svg {
            width: 12px;
            height: 12px;
            fill: white;
            margin-left: 2px;
        }

        .tweet-media-preview .more-media {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .tweet-media-preview .media-thumb.no-thumb {
            background: var(--bg-elevated);
        }

        .tweet-media-preview .thumb-placeholder {
            width: 100%;
            height: 100%;
            background: var(--bg-elevated);
        }

        /* Tweet Footer - Compact */
        .tweet-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tweet-metrics {
            display: flex;
            gap: 12px;
            color: var(--text-muted);
            font-size: 11px;
        }

        .tweet-metrics .metric {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-metrics .metric svg {
            width: 12px;
            height: 12px;
        }

        .tweet-metrics .metric.likes svg { color: var(--text-muted); }
        .tweet-metrics .metric.views svg { color: var(--text-muted); }

        .media-badge {
            background: var(--bg-elevated);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .media-badge svg {
            width: 10px;
            height: 10px;
        }

        .tweet-actions {
            display: flex;
            gap: 4px;
        }

        /* Buttons - Refined */
        .btn {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .btn svg {
            width: 12px;
            height: 12px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger-muted);
        }

        .btn-danger:hover {
            background: rgba(244, 33, 46, 0.1);
        }

        .btn-success {
            background: transparent;
            color: #00ba7c;
            border: 1px solid rgba(0, 186, 124, 0.3);
        }

        .btn-success:hover {
            background: rgba(0, 186, 124, 0.1);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .btn-processing {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-processing:hover {
            background: transparent;
        }

        .ai-progress-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-size: 11px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .ai-progress-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        /* Phase progress badges */
        .phase-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .phase-badge.fetching {
            background: rgba(29, 155, 240, 0.15);
            color: #1d9bf0;
        }

        .phase-badge.downloading {
            background: rgba(255, 180, 0, 0.15);
            color: #ffb400;
        }

        .phase-badge.analyzing {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .phase-badge.completed {
            background: rgba(0, 186, 124, 0.15);
            color: #00ba7c;
        }

        .phase-badge.failed {
            background: rgba(244, 33, 46, 0.15);
            color: #f4212e;
        }

        .phase-badge.fade-out {
            opacity: 0;
            transform: scale(0.8);
        }

        .phase-badge .phase-spinner {
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 5px;
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .btn-browse-media {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--brand-start), var(--brand-end));
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            border-radius: 20px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
        }

        .btn-browse-media:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
        }

        .btn-browse-media svg {
            opacity: 0.9;
        }

        .btn-browse-media .btn-text-short {
            display: none;
        }

        /* Empty State - Minimal */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .empty-state svg {
            width: 40px;
            height: 40px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .empty-state h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .empty-state p {
            font-size: 12px;
        }

        /* Modal Base - Clean */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 10px;
            max-width: 520px;
            width: 100%;
            margin: auto;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-subtle);
        }

        .modal-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            border-radius: 10px 10px 0 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 14px;
        }

        .modal-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Tweet Detail Modal - Refined */
        .tweet-detail-modal {
            max-width: 560px;
        }

        .tweet-detail-content {
            padding: 0;
        }

        .tweet-detail-header {
            padding: 14px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tweet-detail-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .tweet-detail-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tweet-detail-author {
            flex: 1;
        }

        .tweet-detail-author-name {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-detail-author-username {
            color: var(--text-muted);
            font-size: 12px;
        }

        .tweet-detail-author-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .tweet-detail-author-stats span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .tweet-detail-author-bio {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.4;
            max-width: 400px;
        }

        /* Author tooltip */
        .author-tooltip-trigger {
            position: relative;
            cursor: pointer;
        }

        .author-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            min-width: 240px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: none;
            animation: tooltipFadeIn 0.15s ease-out;
        }

        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .author-tooltip-trigger:hover .author-tooltip {
            display: block;
        }

        .author-tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .author-tooltip-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-primary);
            overflow: hidden;
            flex-shrink: 0;
        }

        .author-tooltip-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .author-tooltip-names {
            flex: 1;
            min-width: 0;
        }

        .author-tooltip-displayname {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .author-tooltip-username {
            color: var(--text-muted);
            font-size: 12px;
        }

        .author-tooltip-bio {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .author-tooltip-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }

        .author-tooltip-stat {
            display: flex;
            gap: 4px;
        }

        .author-tooltip-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .author-tooltip-stat-label {
            color: var(--text-muted);
        }

        .tweet-detail-body {
            padding: 14px;
        }

        .tweet-detail-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* AI Analysis Section */
        .ai-analysis {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent-primary);
        }

        .ai-summary {
            font-size: 13px;
            line-height: 1.4;
            color: var(--text-secondary);
            font-style: italic;
        }

        .ai-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .ai-tag {
            background: var(--bg-primary);
            color: var(--accent-primary);
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .ai-tag:hover {
            background: var(--bg-elevated);
        }

        /* Media Stats */
        .media-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .media-stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .media-stat-type {
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .media-stat-detail {
            padding: 2px 6px;
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        .tweet-detail-date {
            color: var(--text-muted);
            font-size: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tweet-detail-date a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .tweet-detail-date a:hover {
            text-decoration: underline;
        }

        /* Tweet Detail Metrics - Compact */
        .tweet-detail-metrics {
            display: flex;
            gap: 16px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
            flex-wrap: wrap;
        }

        .tweet-detail-metrics .metric {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-detail-metrics .metric-value {
            font-weight: 600;
            font-size: 13px;
        }

        .tweet-detail-metrics .metric-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Tweet Detail Media Grid - Constrained */
        .tweet-detail-media {
            margin-top: 12px;
        }

        .tweet-detail-media h4 {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .tweet-detail-media h4 svg {
            width: 14px;
            height: 14px;
        }

        .media-grid {
            display: grid;
            gap: 4px;
            border-radius: 8px;
            overflow: hidden;
        }

        .media-grid.single { grid-template-columns: 1fr; }
        .media-grid.double { grid-template-columns: 1fr 1fr; }
        .media-grid.triple {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        .media-grid.triple .media-item:first-child {
            grid-row: span 2;
        }
        .media-grid.quad {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        .media-item {
            position: relative;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }

        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            min-height: 120px;
            max-height: 280px;
            transition: transform 0.2s;
        }

        .media-grid.single .media-item img {
            max-height: 320px;
        }

        .media-item:hover img {
            transform: scale(1.01);
        }

        .media-download-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s, background 0.15s;
            text-decoration: none;
        }

        .media-item:hover .media-download-btn {
            opacity: 1;
        }

        .media-download-btn:hover {
            background: var(--accent-primary);
        }

        .media-download-btn svg {
            width: 14px;
            height: 14px;
        }

        .media-download-btn.video-download {
            bottom: auto;
            top: 8px;
        }

        .media-item.video {
            background: #000;
            border-radius: 6px;
            overflow: hidden;
        }

        .media-item video {
            width: 100%;
            max-height: 320px;
            display: block;
            background: #000;
        }

        /* Archive Metadata - Minimal */
        .archive-metadata {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
        }

        .archive-metadata h4 {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .archive-metadata h4 svg {
            width: 12px;
            height: 12px;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 6px 0;
            font-size: 12px;
        }

        .metadata-row:not(:last-child) {
            border-bottom: 1px solid var(--border-subtle);
        }

        .metadata-label {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .metadata-value {
            text-align: right;
            word-break: break-all;
            margin-left: 12px;
            color: var(--text-secondary);
        }

        .metadata-value a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .metadata-value a:hover {
            text-decoration: underline;
        }

        /* Tweet Detail Actions - Compact */
        .tweet-detail-actions {
            padding: 12px 14px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
        }

        .tweet-detail-actions .action-group {
            display: flex;
            gap: 6px;
        }

        /* Image Lightbox - Clean */
        .lightbox-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lightbox-overlay.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 4px;
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav.prev { left: -50px; }
        .lightbox-nav.next { right: -50px; }

        .lightbox-counter {
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Premium Media Theater */
        .media-theater {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 400;
            background: #000;
        }

        .media-theater.active {
            display: flex;
            flex-direction: column;
        }

        .theater-backdrop {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000 100%);
        }

        .theater-header {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .media-theater:hover .theater-header,
        .media-theater.controls-visible .theater-header {
            opacity: 1;
            transform: translateY(0);
        }

        .theater-title {
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .theater-subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin-top: 2px;
        }

        .theater-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theater-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }

        .theater-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .theater-btn svg {
            width: 18px;
            height: 18px;
        }

        .theater-btn.icon-only {
            padding: 10px;
            border-radius: 50%;
        }

        .theater-btn.close-btn {
            background: rgba(255,255,255,0.05);
        }

        .theater-btn.close-btn:hover {
            background: rgba(255,77,77,0.2);
        }

        .theater-stage {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            min-width: 0;
        }

        .theater-media-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-media-container img {
            max-width: 100%;
            max-height: calc(100vh - 140px);
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.6);
            transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-media-container video {
            max-width: 100%;
            max-height: calc(100vh - 140px);
            border-radius: 4px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.6);
            background: #000;
            transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s, background 0.2s;
            backdrop-filter: blur(10px);
        }

        .media-theater:hover .theater-nav,
        .media-theater.controls-visible .theater-nav {
            opacity: 1;
        }

        .theater-nav:hover {
            background: rgba(255,255,255,0.2);
        }

        .theater-nav.prev { left: 24px; }
        .theater-nav.next { right: 24px; }

        .theater-nav svg {
            width: 28px;
            height: 28px;
        }

        .theater-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 24px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .media-theater:hover .theater-footer,
        .media-theater.controls-visible .theater-footer {
            opacity: 1;
            transform: translateY(0);
        }

        .theater-counter {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-variant-numeric: tabular-nums;
        }

        /* AI Notes Panel - Sidebar Layout */
        .theater-main {
            display: flex;
            flex: 1;
            min-height: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-stage {
            flex: 1;
            min-width: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-ai-panel {
            width: 0;
            min-width: 0;
            background: rgba(15, 20, 25, 0.98);
            border-left: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .theater-ai-panel.active {
            width: 380px;
            min-width: 380px;
        }

        .ai-panel-inner {
            width: 380px;
            min-width: 380px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ai-panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .ai-panel-header h3 {
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-panel-header h3 svg {
            width: 18px;
            height: 18px;
            color: var(--brand-start);
        }

        .ai-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .ai-panel-section {
            margin-bottom: 24px;
        }

        .ai-panel-section:last-child {
            margin-bottom: 0;
        }

        .ai-panel-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 8px;
        }

        .ai-panel-text {
            font-size: 14px;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
        }

        .ai-panel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ai-panel-tag {
            padding: 6px 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .ai-panel-transcript {
            font-size: 13px;
            line-height: 1.7;
            color: rgba(255,255,255,0.8);
            white-space: pre-wrap;
            max-height: none;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        /* Info Panel - Author Section */
        .info-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .info-avatar-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
        }

        .info-author-text {
            flex: 1;
            min-width: 0;
        }

        .info-author-name {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .info-author-handle {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            text-decoration: none;
        }

        .info-author-handle:hover {
            color: var(--brand-start);
        }

        /* Info Panel - Meta Grid */
        .info-meta-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .info-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .info-meta-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        /* Info Panel - Media Details */
        .info-media-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-media-type {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-media-type.video {
            background: rgba(249, 24, 128, 0.15);
            color: #f91880;
        }

        .info-media-type.image {
            background: rgba(29, 155, 240, 0.15);
            color: #1d9bf0;
        }

        .info-media-count {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }

        /* Autoplay Toggle */
        .autoplay-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
        }

        .autoplay-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        .autoplay-toggle input {
            width: 16px;
            height: 16px;
            accent-color: var(--brand-start);
        }

        .autoplay-toggle span {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }

        /* Gallery Mode - Browse All Media */
        .media-theater.gallery-mode .theater-header {
            opacity: 1;
            transform: none;
            background: rgba(0,0,0,0.9);
        }

        .media-theater.gallery-mode .theater-footer {
            opacity: 1;
            transform: none;
            background: rgba(0,0,0,0.9);
        }

        .gallery-nav-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
        }

        .gallery-nav-info .nav-hint {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gallery-nav-info kbd {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
        }

        /* ============================================
           SYSTEM STATS BAR - Terminal/Dashboard Style
           ============================================ */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 16px;
            background: linear-gradient(180deg, rgba(20, 184, 166, 0.08) 0%, transparent 100%);
            border-bottom: 1px solid rgba(20, 184, 166, 0.15);
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .stats-bar::-webkit-scrollbar { display: none; }

        .stat-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .stat-pill:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .stat-pill svg {
            width: 12px;
            height: 12px;
            opacity: 0.6;
        }

        .stat-label {
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 9px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .stat-value.good { color: #00ba7c; }
        .stat-value.warn { color: #ffd400; }
        .stat-value.critical { color: #f4212e; }

        .stat-bar {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease-out;
        }

        .stat-bar-fill.good { background: linear-gradient(90deg, #00ba7c, #14b8a6); }
        .stat-bar-fill.warn { background: linear-gradient(90deg, #ffd400, #ff9500); }
        .stat-bar-fill.critical { background: linear-gradient(90deg, #f4212e, #ff6b6b); }

        .stat-separator {
            width: 1px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
        }

        .stat-divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.15);
            margin: 0 4px;
        }

        .stat-pill.archive-stat {
            background: rgba(29, 155, 240, 0.1);
            border-color: rgba(29, 155, 240, 0.2);
        }

        .stat-pill.archive-stat .stat-label {
            color: rgba(29, 155, 240, 0.8);
        }

        /* ============================================
           DETAIL PANEL - Multi-Column Magazine Layout
           ============================================ */
        .detail-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 200;
            padding: 24px;
            overflow-y: auto;
        }

        .detail-panel-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .detail-panel {
            width: 100%;
            max-width: 1200px;
            background: var(--bg-primary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: detailSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes detailSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(180deg, rgba(20, 184, 166, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .detail-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-elevated);
            overflow: hidden;
            border: 2px solid rgba(20, 184, 166, 0.3);
        }

        .detail-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-author-info h2 {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
        }

        .detail-author-info .username {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .detail-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .detail-close:hover {
            background: rgba(244, 33, 46, 0.15);
            color: #f4212e;
        }

        .detail-body {
            display: grid;
            grid-template-columns: 1fr 340px;
            min-height: 400px;
        }

        /* Left Column - Content */
        .detail-content {
            padding: 20px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-section {
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }

        .detail-section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-section-label svg {
            width: 12px;
            height: 12px;
            opacity: 0.7;
        }

        .detail-tweet-text {
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .detail-ai-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .detail-ai-summary {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .detail-tag {
            padding: 5px 12px;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.15), rgba(8, 145, 178, 0.15));
            border: 1px solid rgba(20, 184, 166, 0.2);
            border-radius: 20px;
            font-size: 11px;
            color: var(--brand-start);
            font-weight: 500;
        }

        /* Media Preview in Detail */
        .detail-media-preview {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .detail-media-thumb {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .detail-media-thumb:hover {
            transform: scale(1.02);
        }

        .detail-media-thumb img,
        .detail-media-thumb video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-media-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            padding: 3px 8px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            color: white;
        }

        /* Right Column - Metadata */
        .detail-meta {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 16px;
            font-size: 13px;
        }

        .detail-meta-group {
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-meta-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .detail-meta-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-meta-title svg {
            width: 12px;
            height: 12px;
        }

        .detail-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .detail-meta-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .detail-meta-key {
            color: var(--text-muted);
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 11px;
        }

        .detail-meta-value {
            color: var(--text-primary);
            font-weight: 500;
            text-align: right;
        }

        .detail-meta-value.mono {
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 11px;
        }

        /* Metrics Row */
        .detail-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .detail-metric {
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            text-align: center;
        }

        .detail-metric-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Transcript Section */
        .detail-transcript {
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Menlo', monospace;
        }

        .detail-transcript::-webkit-scrollbar {
            width: 4px;
        }

        .detail-transcript::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* Detail Actions */
        .detail-actions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-color);
        }

        .detail-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            text-decoration: none;
        }

        .detail-action-btn.primary {
            background: linear-gradient(135deg, var(--brand-start), var(--brand-end));
            color: white;
        }

        .detail-action-btn.primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .detail-action-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .detail-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .detail-action-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Detail Panel Header */
        .detail-close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .detail-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .detail-close-btn svg {
            width: 20px;
            height: 20px;
        }

        .detail-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .detail-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-header-actions .detail-action-btn {
            flex: none;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            font-size: 12px;
        }

        .detail-header-actions .detail-action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .detail-header-actions .detail-action-btn.danger:hover {
            background: rgba(244, 33, 46, 0.15);
            color: var(--danger);
            border-color: rgba(244, 33, 46, 0.3);
        }

        .detail-header-actions .detail-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Detail Section Headers */
        .detail-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .detail-section-header svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .detail-section-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: rgba(20, 184, 166, 0.15);
            border-radius: 10px;
            font-size: 10px;
            color: var(--brand-start);
        }

        /* Detail Media Grid */
        .detail-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .detail-media-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        .detail-media-item {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .detail-media-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .detail-media-item img,
        .detail-media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-media-play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .detail-media-item:hover .detail-media-play {
            opacity: 1;
        }

        .detail-media-play svg {
            width: 36px;
            height: 36px;
            color: white;
        }

        .detail-media-duration {
            position: absolute;
            bottom: 6px;
            right: 6px;
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            color: white;
        }

        /* Detail Tweet Text */
        .detail-tweet-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Detail Transcript */
        .detail-transcript-text {
            max-height: 180px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
        }

        .detail-transcript-text::-webkit-scrollbar {
            width: 4px;
        }

        .detail-transcript-text::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* Detail Diagnostics */
        .detail-diagnostics-code {
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.5;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 0;
        }

        /* Detail AI Section */
        .detail-ai-type {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px solid var(--border-subtle);
            margin-top: 12px;
        }

        .detail-ai-pending {
            color: var(--text-muted);
            font-style: italic;
            font-size: 13px;
        }

        /* Detail Author Card */
        .detail-author-card {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .detail-author-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-elevated);
            overflow: hidden;
            border: 2px solid rgba(20, 184, 166, 0.2);
            flex-shrink: 0;
        }

        .detail-author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-author-info {
            flex: 1;
            min-width: 0;
        }

        .detail-author-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .detail-author-name .verified-badge {
            width: 16px;
            height: 16px;
            color: var(--accent-primary);
        }

        .detail-author-handle {
            font-size: 13px;
            color: var(--text-muted);
        }

        .detail-author-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .detail-author-stat {
            text-align: center;
            padding: 8px 4px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .detail-stat-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-author-bio {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Detail Technical Grid */
        .detail-tech-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-tech-item {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            align-items: center;
        }

        .detail-tech-type {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
            min-width: 60px;
        }

        .detail-tech-detail {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .detail-tech-empty {
            color: var(--text-muted);
            font-size: 12px;
            padding: 12px;
            text-align: center;
        }

        .detail-tech-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        /* Detail Rows */
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 6px 0;
        }

        .detail-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .detail-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        .detail-value {
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }

        .detail-path {
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        .detail-status-completed { color: var(--success); }
        .detail-status-processing, .detail-status-downloading { color: var(--accent-primary); }
        .detail-status-failed { color: var(--danger); }

        /* Small button variant */
        .btn-sm {
            padding: 6px 12px !important;
            font-size: 11px !important;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            /* Detail Panel Mobile */
            .detail-panel-overlay {
                padding: 0;
            }

            .detail-panel {
                border-radius: 0;
                min-height: 100vh;
            }

            .detail-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: var(--bg-primary);
            }

            .detail-header-actions {
                flex-wrap: wrap;
                gap: 4px;
            }

            .detail-header-actions .detail-action-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .detail-header-actions .detail-action-btn span {
                display: none;
            }

            .detail-body {
                grid-template-columns: 1fr;
            }

            .detail-content {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .detail-meta {
                padding: 16px;
            }

            .detail-section {
                padding: 12px;
            }

            .detail-author-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .detail-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .detail-media-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Stats Bar Mobile */
            .stats-bar {
                padding: 8px 12px;
                gap: 8px;
            }

            .stat-pill {
                padding: 6px 10px;
                font-size: 10px;
            }

            .stat-label {
                display: none;
            }

            .theater-ai-panel {
                position: fixed;
                top: auto;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100% !important;
                min-width: 100% !important;
                max-height: 60vh;
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
            }

            .theater-ai-panel.active {
                transform: translateY(0);
            }

            .ai-panel-inner {
                width: 100%;
                min-width: 100%;
            }

            .ai-panel-header {
                padding: 16px 20px;
            }

            .ai-panel-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: rgba(255,255,255,0.3);
                border-radius: 2px;
            }

            .theater-nav {
                width: 44px;
                height: 44px;
            }

            .theater-nav.prev { left: 12px; }
            .theater-nav.next { right: 12px; }

            .theater-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .theater-btn svg {
                width: 16px;
                height: 16px;
            }

            .theater-header {
                padding: 12px 16px;
            }

            .theater-title {
                font-size: 14px;
            }

            .theater-media-container video,
            .theater-media-container img {
                max-height: calc(100vh - 200px);
            }

            .media-theater.ai-panel-open .theater-media-container video,
            .media-theater.ai-panel-open .theater-media-container img {
                max-height: calc(40vh - 80px);
            }
        }

        /* Touch-friendly hit areas */
        @media (pointer: coarse) {
            .theater-nav {
                width: 60px;
                height: 60px;
            }

            .theater-btn {
                min-height: 44px;
            }

            .theater-btn.icon-only {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* More button for tweets */
        .tweet-more-btn {
            background: none;
            border: none;
            color: var(--brand-start);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 0;
            margin-top: 4px;
        }

        .tweet-more-btn:hover {
            color: var(--brand-end);
            text-decoration: underline;
        }

        .tweet-text.expanded {
            -webkit-line-clamp: unset;
            max-height: none;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Keyboard shortcuts hint - Subtle */
        .keyboard-hint {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s;
            pointer-events: none;
        }

        .keyboard-hint.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .keyboard-hint kbd {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: inherit;
            margin: 0 3px;
            font-size: 10px;
        }

        /* Scroll to top button - Minimal */
        .scroll-top {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(16px);
            transition: all 0.2s;
            pointer-events: none;
        }

        .scroll-top.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .scroll-top:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .scroll-top svg {
            width: 16px;
            height: 16px;
        }

        /* Responsive - Compact Mobile */
        @media (max-width: 768px) {
            .header {
                flex-direction: row;
                gap: 8px;
                padding: 8px 12px;
            }

            .stats {
                font-size: 10px;
                gap: 10px;
            }

            .btn-browse-media {
                padding: 6px 12px;
                font-size: 11px;
            }

            .btn-browse-media .btn-text-full {
                display: none;
            }

            .btn-browse-media .btn-text-short {
                display: inline;
            }

            .container {
                padding: 8px;
            }

            .tweet-card {
                padding: 10px 12px;
            }

            .tweet-detail-text {
                font-size: 14px;
            }

            .tweet-detail-metrics {
                gap: 10px;
            }

            .tweet-detail-actions {
                flex-direction: column;
                gap: 8px;
            }

            .tweet-detail-actions .action-group {
                width: 100%;
                justify-content: center;
            }

            .lightbox-nav {
                display: none;
            }

            .tweet-media-preview {
                max-width: 100%;
            }

            .tweet-media-preview.single,
            .tweet-media-preview.double,
            .tweet-media-preview.triple,
            .tweet-media-preview.quad {
                max-width: 240px;
            }
        }

        /* Focus states for accessibility */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            <svg viewBox="0 0 128 128" width="28" height="28">
                <defs>
                    <linearGradient id="header-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#14b8a6"/>
                        <stop offset="100%" stop-color="#0891b2"/>
                    </linearGradient>
                </defs>
                <path d="M20 8 L8 8 L8 40" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M108 8 L120 8 L120 40" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M20 120 L8 120 L8 88" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M108 120 L120 120 L120 88" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M40 40 L88 88 M88 40 L40 88" stroke="#e7e9ea" stroke-width="12" stroke-linecap="round"/>
            </svg>
            <span style="background: linear-gradient(135deg, #14b8a6, #0891b2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">xgrabba</span>
        </h1>
        <div class="stats">
            <div>Tweets: <span id="totalTweets">0</span></div>
            <div>Media: <span id="totalMedia">0</span></div>
        </div>
        <button class="btn btn-browse-media" onclick="openGalleryMode()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
            </svg>
            <span class="btn-text-full">Browse Media</span>
            <span class="btn-text-short">Media</span>
        </button>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-ghost" id="connectBookmarksBtn" onclick="openBookmarksConnect(event)">Connect X Bookmarks</button>
            <button class="btn btn-ghost" id="disconnectBookmarksBtn" style="display:none;" onclick="disconnectBookmarks(event)">Disconnect</button>
            <span id="bookmarksAuthStatus" style="font-size:12px; color: var(--text-muted);"></span>
        </div>
    </header>

    <!-- System Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-pill">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <span class="stat-label">Uptime</span>
            <span class="stat-value" id="statUptime">--</span>
        </div>
        <div class="stat-pill">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M2 20h20v-4H2v4zm2-3h2v2H4v-2zM2 4v4h20V4H2zm4 3H4V5h2v2zm-4 7h20v-4H2v4zm2-3h2v2H4v-2z"/>
            </svg>
            <span class="stat-label">Disk</span>
            <span class="stat-value" id="statDisk">--</span>
            <div class="stat-bar">
                <div class="stat-bar-fill" id="statDiskBar" style="width: 0%"></div>
            </div>
        </div>
        <div class="stat-pill">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M15 9H9v6h6V9zm-2 4h-2v-2h2v2zm8-2V9h-2V7c0-1.1-.9-2-2-2h-2V3h-2v2h-2V3H9v2H7c-1.1 0-2 .9-2 2v2H3v2h2v2H3v2h2v2c0 1.1.9 2 2 2h2v2h2v-2h2v2h2v-2h2c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2zm-4 6H7V7h10v10z"/>
            </svg>
            <span class="stat-label">Mem</span>
            <span class="stat-value" id="statMem">--</span>
        </div>
        <div class="stat-pill">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            <span class="stat-label">Goroutines</span>
            <span class="stat-value" id="statGoroutines">--</span>
        </div>
        <div class="stat-pill">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"/>
            </svg>
            <span class="stat-label">CPU</span>
            <span class="stat-value" id="statCPU">--</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
            </svg>
            <span class="stat-label">Tweets</span>
            <span class="stat-value" id="statTweets">--</span>
        </div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
            </svg>
            <span class="stat-label">Videos</span>
            <span class="stat-value" id="statVideos">--</span>
        </div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span class="stat-label">Images</span>
            <span class="stat-value" id="statImages">--</span>
        </div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
            </svg>
            <span class="stat-label">Archive</span>
            <span class="stat-value" id="statArchive">--</span>
        </div>
    </div>

    <div class="container">
        <div class="search-container">
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10.25 3.75a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zm-8.5 6.5a8.5 8.5 0 1 1 15.176 5.262l4.781 4.781-1.414 1.414-4.781-4.781A8.5 8.5 0 0 1 1.75 10.25z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Search by author, text, AI, or transcript..." aria-label="Search tweets">
                <button class="search-clear" id="searchClear" aria-label="Clear search">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="search-results-info" id="searchResultsInfo">
                Showing <strong id="searchResultCount">0</strong> results for "<span id="searchQuery"></span>"
            </div>
        </div>

        <div id="tweetList" class="tweet-list">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="deleteModalTitle">Delete Archive</h2>
                <button class="modal-close" onclick="closeDeleteModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); line-height: 1.6;">Are you sure you want to delete this archived tweet? This will permanently remove all associated media files and cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Tweet Detail Panel (Redesigned) -->
    <div class="detail-panel-overlay" id="detailPanelOverlay" role="dialog" aria-modal="true" aria-labelledby="detailPanelTitle">
        <div class="detail-panel" id="detailPanel">
            <div class="detail-header">
                <div class="detail-header-left">
                    <button class="detail-close-btn" onclick="closeDetailPanel()" aria-label="Close">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                    </button>
                    <h2 id="detailPanelTitle">Archive Details</h2>
                </div>
                <div class="detail-header-actions">
                    <a class="detail-action-btn" id="detailViewOriginal" href="#" target="_blank" rel="noopener">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        View on X
                    </a>
                    <button class="detail-action-btn" id="detailRegenAI" onclick="regenerateAI(currentTweetDetail?.tweet_id)">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Regen AI
                    </button>
                    <button class="detail-action-btn" id="detailResync" onclick="resyncTweet(currentTweetDetail?.tweet_id)">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        Resync
                    </button>
                    <button class="detail-action-btn danger" onclick="closeDetailPanel(); showDeleteModal(currentTweetDetail?.tweet_id)">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
            <div class="detail-body" id="detailBody">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Legacy Tweet Detail Modal (hidden, for backwards compat) -->
    <div class="modal-overlay" id="tweetDetailModal" role="dialog" aria-modal="true" aria-labelledby="tweetDetailTitle" style="display:none;">
        <div class="modal tweet-detail-modal">
            <div class="modal-header">
                <h2 id="tweetDetailTitle">Tweet</h2>
                <button class="modal-close" onclick="closeTweetDetailModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="tweet-detail-content" id="tweetDetailContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox (legacy - kept for compatibility) -->
    <div class="lightbox-overlay" id="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()" aria-label="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                </svg>
            </button>
            <button class="lightbox-nav prev" onclick="navigateLightbox(-1)" aria-label="Previous image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <img id="lightboxImage" src="" alt="Full size image">
            <button class="lightbox-nav next" onclick="navigateLightbox(1)" aria-label="Next image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
            <div class="lightbox-counter" id="lightboxCounter"></div>
        </div>
    </div>

    <!-- Premium Media Theater -->
    <div class="media-theater" id="mediaTheater" role="dialog" aria-modal="true" aria-label="Media viewer">
        <div class="theater-backdrop" onclick="closeTheater()"></div>

        <header class="theater-header">
            <div>
                <div class="theater-title" id="theaterTitle"></div>
                <div class="theater-subtitle" id="theaterSubtitle"></div>
            </div>
            <div class="theater-actions">
                <button class="theater-btn" id="theaterAiToggle" onclick="toggleTheaterAI()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    AI Notes
                </button>
                <a class="theater-btn" id="theaterDownload" href="#" download>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                    </svg>
                    Download
                </a>
                <button class="theater-btn icon-only close-btn" onclick="closeTheater()" aria-label="Close">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main content area with sidebar layout -->
        <div class="theater-main">
            <div class="theater-stage">
                <button class="theater-nav prev" onclick="navigateTheater(-1)" aria-label="Previous">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>

                <div class="theater-media-container" id="theaterMediaContainer">
                    <!-- Media (image or video) inserted here dynamically -->
                </div>

                <button class="theater-nav next" onclick="navigateTheater(1)" aria-label="Next">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </button>

                <footer class="theater-footer">
                    <div class="theater-counter" id="theaterCounter"></div>
                    <label class="autoplay-toggle" title="Auto-advance through all media">
                        <input type="checkbox" id="autoplayCheckbox" onchange="toggleAutoplay()">
                        <span>Autoplay</span>
                    </label>
                </footer>
            </div>

            <!-- Media Info Side Panel -->
            <aside class="theater-ai-panel" id="theaterAiPanel">
                <div class="ai-panel-inner">
                    <div class="ai-panel-header">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                            </svg>
                            Media Info
                        </h3>
                        <button class="theater-btn icon-only" onclick="toggleTheaterAI()" aria-label="Close panel">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="ai-panel-content" id="theaterAiContent">
                        <!-- Media info inserted dynamically -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Scroll to top -->
    <button class="scroll-top" id="scrollTop" aria-label="Scroll to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>

    <!-- Keyboard hint -->
    <div class="keyboard-hint" id="keyboardHint">
        Press <kbd>Esc</kbd> to close, <kbd>/</kbd> to search
    </div>

    <script>
        // Get API key from URL params first, then localStorage
        const params = new URLSearchParams(window.location.search);
        let API_KEY = params.get('key') || localStorage.getItem('xgrabba_api_key') || '';

        // Store API key if provided in URL
        if (params.get('key')) {
            localStorage.setItem('xgrabba_api_key', params.get('key'));
            window.history.replaceState({}, '', window.location.pathname);
        }

        // State
        let tweets = [];
        let deleteTarget = null;
        let currentTweetDetail = null;
        let lightboxImages = [];
        let lightboxIndex = 0;
        let searchTimeout = null;

        // DOM Elements
        const tweetList = document.getElementById('tweetList');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const searchResultCount = document.getElementById('searchResultCount');
        const searchQuerySpan = document.getElementById('searchQuery');
        const scrollTopBtn = document.getElementById('scrollTop');
        const keyboardHint = document.getElementById('keyboardHint');

        // Fetch tweets from API (data only)
        async function fetchTweetsRaw() {
            try {
                const response = await fetch('/api/v1/tweets?limit=100', {
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.status === 401) {
                    const key = prompt('Enter your xgrabba API key:');
                    if (key) {
                        localStorage.setItem('xgrabba_api_key', key);
                        location.reload();
                    }
                    return;
                }

                const data = await response.json();
                tweets = data.tweets || [];
                return true;
            } catch (error) {
                console.error('Failed to fetch tweets:', error);
                tweetList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        <h3>Connection Error</h3>
                        <p>Failed to load tweets. Make sure the server is running.</p>
                    </div>
                `;
                return false;
            }
        }

        // Load + render tweets, preserving search & scroll by default.
        async function loadTweets({ preserveScroll = true, keepSearch = true } = {}) {
            const scrollY = preserveScroll ? window.scrollY : 0;
            const query = keepSearch ? (searchInput.value || '').trim() : '';

            const ok = await fetchTweetsRaw();
            if (!ok) return;

            if (query) {
                performSearch(query);
            } else {
                renderTweets(tweets);
                updateStats();
            }

            if (preserveScroll) {
                window.scrollTo({ top: scrollY });
            }

            // Ensure polling keeps the list UI up to date.
            startAIPolling();
        }

        // Backwards compatibility: existing code calls fetchTweets().
        async function fetchTweets() {
            await loadTweets({ preserveScroll: false, keepSearch: false });
        }

        // Smart polling for phased processing status
        // Uses batch-status endpoint for efficient polling of multiple tweets
        let statusPollTimer = null;
        const activeTweets = new Map(); // tweetId -> { status, media_downloaded, media_total, ai_in_progress }
        const TERMINAL_STATUSES = ['completed', 'failed'];

        // Phase badge configuration
        const phaseBadges = {
            pending:     { text: 'Pending...', class: 'fetching', spinner: true },
            fetching:    { text: 'Fetching...', class: 'fetching', spinner: true },
            fetched:     { text: 'Fetched', class: 'fetching', spinner: false },
            downloading: { text: 'Downloading', class: 'downloading', spinner: true }, // Will show percentage
            downloaded:  { text: 'Downloaded', class: 'downloading', spinner: false },
            analyzing:   { text: 'Analyzing...', class: 'analyzing', spinner: true },
            completed:   { text: '', class: 'completed', spinner: false }, // Checkmark shows briefly
            failed:      { text: 'Failed', class: 'failed', spinner: false }
        };

        function updateTweetCardStatus(tweetId, state) {
            const card = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
            if (!card) return;
            const dateEl = card.querySelector('.tweet-date');
            if (!dateEl) return;

            // Remove any existing badges
            const existingPhase = dateEl.querySelector('.phase-badge');
            const existingAI = dateEl.querySelector('.ai-progress-badge');
            if (existingPhase) existingPhase.remove();
            if (existingAI) existingAI.remove();

            const status = state.status;
            const config = phaseBadges[status] || phaseBadges.pending;

            // Don't show badge for completed tweets (just fade out)
            if (status === 'completed') {
                // Show brief checkmark then fade out
                const badge = document.createElement('span');
                badge.className = `phase-badge ${config.class}`;
                badge.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                dateEl.insertBefore(badge, dateEl.firstChild);
                setTimeout(() => badge.classList.add('fade-out'), 2000);
                setTimeout(() => badge.remove(), 2300);
                return;
            }

            if (status === 'failed') {
                return; // Failed status shown differently
            }

            // Build badge text
            let text = config.text;
            if (status === 'downloading' && state.media_total > 0) {
                const pct = Math.round((state.media_downloaded / state.media_total) * 100);
                text = `Downloading ${pct}%`;
            }

            const badge = document.createElement('span');
            badge.className = `phase-badge ${config.class}`;
            badge.innerHTML = config.spinner
                ? `<span class="phase-spinner"></span> ${text}`
                : text;
            dateEl.insertBefore(badge, dateEl.firstChild);
        }

        async function pollBatchStatus() {
            // Always re-scan for new active tweets on every poll
            scanForActiveTweets();

            const ids = Array.from(activeTweets.keys());
            if (ids.length === 0) return;

            try {
                const resp = await fetch('/api/v1/tweets/batch-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({ tweet_ids: ids })
                });

                if (!resp.ok) return;
                const data = await resp.json();
                const statuses = data.statuses || {};

                let anyCompleted = false;
                let anyProgressChanged = false;

                for (const [id, state] of Object.entries(statuses)) {
                    const oldState = activeTweets.get(id);
                    const statusChanged = !oldState || oldState.status !== state.status;
                    const progressChanged = oldState && (
                        oldState.media_downloaded !== state.media_downloaded
                    );

                    if (statusChanged || progressChanged) {
                        anyProgressChanged = true;
                        updateTweetCardStatus(id, state);
                    }

                    // Check if tweet completed or failed
                    if (TERMINAL_STATUSES.includes(state.status)) {
                        activeTweets.delete(id);
                        if (state.status === 'completed' && oldState && !TERMINAL_STATUSES.includes(oldState.status)) {
                            anyCompleted = true;
                            // Refresh detail view if open for this tweet
                            if (document.getElementById('tweetDetailModal').classList.contains('active') &&
                                currentTweetDetail && currentTweetDetail.tweet_id === id) {
                                openTweetDetail(id);
                            }
                        }
                    } else {
                        activeTweets.set(id, state);
                    }
                }

                // Refresh card content when phases advance (media appears, AI completes)
                if (anyCompleted) {
                    await loadTweets({ preserveScroll: true, keepSearch: true });
                }
            } catch (e) {
                // Silent fail
            }
        }

        // Scan tweets for any in non-terminal status and add to activeTweets
        function scanForActiveTweets() {
            // Check tweets data for non-completed status
            for (const tweet of tweets) {
                const id = tweet.tweet_id;

                // Skip tweets we don't have IDs for
                if (!id) continue;

                // Add tweets with non-terminal status
                if (tweet.status && !TERMINAL_STATUSES.includes(tweet.status)) {
                    activeTweets.set(id, {
                        status: tweet.status,
                        media_downloaded: 0,
                        media_total: tweet.media_count || 0
                    });
                }
                // Also track tweets with AI in progress
                else if (tweet.ai_in_progress) {
                    activeTweets.set(id, { status: 'analyzing' });
                }
            }

            // Also check DOM for badges that might indicate in-progress state
            const cards = document.querySelectorAll('.tweet-card[data-tweet-id]');
            for (const card of cards) {
                const id = card.getAttribute('data-tweet-id');
                const hasBadge = card.querySelector('.phase-badge:not(.completed)');
                if (hasBadge && !activeTweets.has(id)) {
                    activeTweets.set(id, { status: 'unknown' });
                }
            }
        }

        function startStatusPolling() {
            // Always re-scan for active tweets when called
            scanForActiveTweets();

            // Only start timer once
            if (statusPollTimer) return;

            // Poll every 2 seconds
            statusPollTimer = setInterval(pollBatchStatus, 2000);
            // Initial poll
            pollBatchStatus();
        }

        // Backwards compat alias
        function startAIPolling() {
            startStatusPolling();
        }

        // Legacy function for AI-only status updates
        function updateTweetCardAIStatus(tweetId, inProgress) {
            if (inProgress) {
                activeTweets.set(tweetId, { status: 'analyzing' });
            }
            updateTweetCardStatus(tweetId, { status: inProgress ? 'analyzing' : 'completed' });
        }

        function updateStats() {
            document.getElementById('totalTweets').textContent = tweets.length;
            const totalMedia = tweets.reduce((sum, t) => sum + (t.media_count || 0), 0);
            document.getElementById('totalMedia').textContent = totalMedia;
        }

        // System stats fetching
        let statsInterval = null;
        async function fetchSystemStats() {
            try {
                const response = await fetch('/api/v1/stats', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) return;
                const stats = await response.json();

                // Update uptime
                document.getElementById('statUptime').textContent = stats.uptime_human || '--';

                // Update disk usage
                const diskUsedGB = (stats.disk_used_bytes / (1024 * 1024 * 1024)).toFixed(1);
                const diskTotalGB = (stats.disk_total_bytes / (1024 * 1024 * 1024)).toFixed(1);
                const diskPct = stats.disk_used_pct || 0;
                document.getElementById('statDisk').textContent = `${diskUsedGB}/${diskTotalGB} GB`;
                const diskBar = document.getElementById('statDiskBar');
                diskBar.style.width = `${Math.min(diskPct, 100)}%`;
                // Color code disk usage
                if (diskPct >= 90) {
                    diskBar.style.background = 'var(--danger)';
                } else if (diskPct >= 75) {
                    diskBar.style.background = '#f59e0b';
                } else {
                    diskBar.style.background = 'var(--brand-gradient)';
                }

                // Update memory
                document.getElementById('statMem').textContent = `${stats.mem_alloc_mb} MB`;

                // Update goroutines
                document.getElementById('statGoroutines').textContent = stats.num_goroutines;

                // Update CPU cores
                document.getElementById('statCPU').textContent = `${stats.num_cpu} cores`;

                // Update archive stats
                document.getElementById('statTweets').textContent = stats.tweet_count || 0;
                document.getElementById('statVideos').textContent = `${stats.video_mb || 0} MB`;
                document.getElementById('statImages').textContent = `${stats.image_mb || 0} MB`;
                document.getElementById('statArchive').textContent = `${stats.archive_total_mb || 0} MB`;
            } catch (error) {
                console.error('Failed to fetch system stats:', error);
            }
        }

        function startSystemStatsPolling() {
            fetchSystemStats(); // Initial fetch
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(fetchSystemStats, 30000); // Every 30 seconds
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return diffMins <= 1 ? 'Just now' : `${diffMins}m ago`;
                }
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            }

            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function formatFullDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightText(text, query) {
            if (!query) return escapeHtml(text);
            const escaped = escapeHtml(text);
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return escaped.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function getInitials(author) {
            if (!author) return '?';
            // Handle both string and object (from /full endpoint)
            const username = typeof author === 'string' ? author : (author.username || author.display_name || '?');
            return username.charAt(0).toUpperCase();
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) {
                return mins + ':' + secs.toString().padStart(2, '0');
            }
            return '0:' + secs.toString().padStart(2, '0');
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + ' GB';
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
            if (bytes >= 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return bytes + ' B';
        }

        // Render status badge for a tweet based on its processing phase
        function renderStatusBadge(tweet) {
            const status = tweet.status;

            // Skip completed tweets - no badge needed
            if (!status || status === 'completed') {
                // But still show AI analyzing if that's in progress
                if (tweet.ai_in_progress) {
                    return `<span class="phase-badge analyzing"><span class="phase-spinner"></span> Analyzing...</span>`;
                }
                return '';
            }

            const badges = {
                pending:     { text: 'Pending...', class: 'fetching', spinner: true },
                fetching:    { text: 'Fetching...', class: 'fetching', spinner: true },
                fetched:     { text: 'Fetched', class: 'fetching', spinner: false },
                downloading: { text: 'Downloading...', class: 'downloading', spinner: true },
                downloaded:  { text: 'Downloaded', class: 'downloading', spinner: false },
                analyzing:   { text: 'Analyzing...', class: 'analyzing', spinner: true },
                failed:      { text: 'Failed', class: 'failed', spinner: false }
            };

            const config = badges[status] || badges.pending;

            if (config.spinner) {
                return `<span class="phase-badge ${config.class}"><span class="phase-spinner"></span> ${config.text}</span>`;
            }
            return `<span class="phase-badge ${config.class}">${config.text}</span>`;
        }

        // Render tweet list
        function renderTweets(tweetsToRender, searchQuery = '') {
            if (tweetsToRender.length === 0) {
                tweetList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3v10.586l3.293-3.293 1.414 1.414L12 16.414l-4.707-4.707 1.414-1.414L12 13.586V3h2z"/>
                            <path d="M5 17v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/>
                        </svg>
                        <h3>${searchQuery ? 'No results found' : 'No archived tweets yet'}</h3>
                        <p>${searchQuery ? `No tweets match "${escapeHtml(searchQuery)}"` : 'Use the browser extension to archive tweets from X.com'}</p>
                    </div>
                `;
                return;
            }

            tweetList.innerHTML = tweetsToRender.map(tweet => {
                const mediaPreview = renderMediaPreview(tweet);
                const displayName = tweet.author_display_name || tweet.author || 'Unknown';

                return `
                    <div class="tweet-card" data-tweet-id="${tweet.tweet_id}" onclick="openTweetDetail('${tweet.tweet_id}')">
                        <div class="tweet-header">
                            <div class="tweet-avatar">
                                ${tweet.author_avatar
                                    ? `<img src="${addApiKey(tweet.author_avatar)}" alt="${escapeHtml(displayName)}" onerror="this.parentElement.innerHTML='${getInitials(tweet.author)}'">`
                                    : getInitials(tweet.author)
                                }
                            </div>
                            <div class="tweet-author">
                                <div class="tweet-author-name">
                                    ${escapeHtml(displayName)}
                                    ${tweet.verified ? `
                                        <svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/>
                                        </svg>
                                    ` : ''}
                                </div>
                                <span class="tweet-author-username">@${escapeHtml(tweet.author || 'unknown')}</span>
                                ${tweet.follower_count ? `<span class="tweet-author-followers">${formatNumber(tweet.follower_count)} followers</span>` : ''}
                            </div>
                            <div class="tweet-date">
                                ${renderStatusBadge(tweet)}
                                ${formatDate(tweet.created_at)}
                            </div>
                        </div>
                        <div class="tweet-text">${highlightText(tweet.text || '', searchQuery)}</div>
                        ${(tweet.text || '').length > 200 ? `<button class="tweet-more-btn" onclick="event.stopPropagation(); toggleTweetExpand('${tweet.tweet_id}', this)">More</button>` : ''}
                        ${tweet.ai_tags && tweet.ai_tags.length > 0 ? `
                            <div class="tweet-tags">
                                ${tweet.ai_tags.slice(0, 5).map(tag => `<span class="tweet-tag">${escapeHtml(tag)}</span>`).join('')}
                                ${tweet.ai_tags.length > 5 ? `<span class="tweet-tag-more">+${tweet.ai_tags.length - 5}</span>` : ''}
                            </div>
                        ` : ''}
                        ${mediaPreview}
                        <div class="tweet-footer">
                            <div class="tweet-metrics">
                                ${tweet.like_count !== undefined ? `
                                    <span class="metric likes">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"/>
                                        </svg>
                                        ${formatNumber(tweet.like_count)}
                                    </span>
                                ` : ''}
                                ${tweet.view_count ? `
                                    <span class="metric views">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 4C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                        </svg>
                                        ${formatNumber(tweet.view_count)}
                                    </span>
                                ` : ''}
                                <span class="media-badge">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"/>
                                    </svg>
                                    ${tweet.media_count || 0}
                                </span>
                            </div>
                            <div class="tweet-actions">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); openTweetDetail('${tweet.tweet_id}')">View</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMediaPreview(tweet) {
            if (!tweet.media || tweet.media.length === 0) return '';

            const mediaCount = tweet.media.length;
            const gridClass = mediaCount === 1 ? 'single' : mediaCount === 2 ? 'double' : mediaCount === 3 ? 'triple' : 'quad';
            const displayMedia = tweet.media.slice(0, 4);

            return `
                <div class="tweet-media-preview ${gridClass}">
                    ${displayMedia.map((media, idx) => {
                        const isVideo = media.type === 'video' || media.type === 'gif';
                        const showMore = idx === 3 && mediaCount > 4;

                        // For videos: prefer thumbnail_url, fallback to generating from video
                        // For images: use url directly
                        let thumbUrl = '';
                        if (isVideo) {
                            // Use thumbnail if available, otherwise we'll generate one
                            thumbUrl = media.thumbnail_url || '';
                        } else {
                            thumbUrl = media.url || '';
                        }

                        // Add API key for our URLs
                        const isOurUrl = thumbUrl.startsWith('/api/');
                        const finalThumbUrl = isOurUrl ? addApiKey(thumbUrl) : thumbUrl;

                        // For videos without thumbnails, create a placeholder with video element
                        const videoUrl = isVideo && !thumbUrl ? addApiKey(media.url || '') : '';

                        return `
                            <div class="media-thumb" ${isVideo && videoUrl ? `data-video-src="${videoUrl}"` : ''} onclick="event.stopPropagation(); openTheater('${tweet.tweet_id}', ${idx})" style="cursor:pointer;">
                                ${finalThumbUrl
                                    ? `<img src="${finalThumbUrl}" alt="${isVideo ? 'Video thumbnail' : 'Tweet media'}" onerror="this.parentElement.classList.add('no-thumb')">`
                                    : isVideo && videoUrl
                                        ? `<video src="${videoUrl}" preload="metadata" muted playsinline onloadeddata="this.currentTime=0.5" style="pointer-events:none;"></video>`
                                        : `<div class="thumb-placeholder"></div>`
                                }
                                ${isVideo ? `
                                    <div class="video-indicator">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                ` : ''}
                                ${showMore ? `<div class="more-media">+${mediaCount - 4}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Helper to add API key to URLs
        function addApiKey(url) {
            if (!url || !API_KEY) return url;
            const separator = url.includes('?') ? '&' : '?';
            return url + separator + 'key=' + encodeURIComponent(API_KEY);
        }

        // Open tweet detail modal
        async function openTweetDetail(tweetId) {
            const overlay = document.getElementById('detailPanelOverlay');
            const body = document.getElementById('detailBody');
            const viewOriginalBtn = document.getElementById('detailViewOriginal');

            // Show loading state
            body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/full`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const tweet = await response.json();
                currentTweetDetail = tweet;

                // Update header URL
                if (tweet.url) {
                    viewOriginalBtn.href = tweet.url;
                    viewOriginalBtn.style.display = '';
                } else {
                    viewOriginalBtn.style.display = 'none';
                }

                // Handle author being an object (from /full endpoint) or string
                const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
                const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
                const displayName = authorObj ? (authorObj.display_name || authorObj.username) : (tweet.author_display_name || tweet.author || 'Unknown');
                const authorAvatar = authorObj ? authorObj.avatar_url : tweet.author_avatar;
                const verified = authorObj ? authorObj.verified : tweet.verified;
                const followerCount = authorObj ? authorObj.follower_count : tweet.follower_count;
                const followingCount = authorObj ? authorObj.following_count : tweet.following_count;
                const tweetCount = authorObj ? authorObj.tweet_count : tweet.tweet_count;
                const authorBio = authorObj ? authorObj.description : tweet.author_bio;

                // Build author tooltip if we have metadata
                const hasAuthorMeta = followerCount || followingCount || tweetCount || authorBio;
                const tooltipAvatarUrl = authorAvatar ? addApiKey(authorAvatar) : '';
                const authorTooltip = hasAuthorMeta ? `
                    <div class="author-tooltip">
                        <div class="author-tooltip-header">
                            <div class="author-tooltip-avatar">
                                ${tooltipAvatarUrl
                                    ? `<img src="${tooltipAvatarUrl}" alt="${escapeHtml(displayName)}">`
                                    : `<span style="display:flex;align-items:center;justify-content:center;height:100%;font-size:16px;font-weight:600;color:var(--text-muted);">${getInitials(authorUsername)}</span>`
                                }
                            </div>
                            <div class="author-tooltip-names">
                                <div class="author-tooltip-displayname">
                                    ${escapeHtml(displayName)}
                                    ${verified ? `<svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;"><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/></svg>` : ''}
                                </div>
                                <div class="author-tooltip-username">@${escapeHtml(authorUsername)}</div>
                            </div>
                        </div>
                        ${authorBio ? `<div class="author-tooltip-bio">${escapeHtml(authorBio)}</div>` : ''}
                        <div class="author-tooltip-stats">
                            ${followerCount !== undefined ? `
                                <div class="author-tooltip-stat">
                                    <span class="author-tooltip-stat-value">${formatNumber(followerCount)}</span>
                                    <span class="author-tooltip-stat-label">Followers</span>
                                </div>
                            ` : ''}
                            ${followingCount !== undefined ? `
                                <div class="author-tooltip-stat">
                                    <span class="author-tooltip-stat-value">${formatNumber(followingCount)}</span>
                                    <span class="author-tooltip-stat-label">Following</span>
                                </div>
                            ` : ''}
                            ${tweetCount !== undefined ? `
                                <div class="author-tooltip-stat">
                                    <span class="author-tooltip-stat-value">${formatNumber(tweetCount)}</span>
                                    <span class="author-tooltip-stat-label">Posts</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : '';

                // Build avatar URL with API key
                const avatarWithKey = authorAvatar ? addApiKey(authorAvatar) : '';

                // Calculate total storage size
                const totalSize = tweet.media?.reduce((sum, m) => sum + (m.size || 0), 0) || 0;

                // Build transcript HTML
                const hasTranscript = tweet.transcript && tweet.transcript.trim().length > 0;

                body.innerHTML = `
                    <!-- Left Column: Content -->
                    <div class="detail-content">
                        <!-- Media Preview -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                                Media
                                <span class="detail-section-badge">${tweet.media?.length || 0}</span>
                            </div>
                            <div class="detail-media-grid">
                                ${renderDetailMediaGrid(tweet)}
                            </div>
                        </div>

                        <!-- Tweet Text -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                                Original Post
                            </div>
                            <div class="detail-tweet-text">${escapeHtml(tweet.text || 'No text available')}</div>
                        </div>

                        <!-- Transcript -->
                        ${hasTranscript ? `
                            <div class="detail-section detail-transcript">
                                <div class="detail-section-header">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/></svg>
                                    Transcript
                                </div>
                                <div class="detail-transcript-text">${escapeHtml(tweet.transcript)}</div>
                            </div>
                        ` : ''}

                        <!-- Diagnostics (Collapsible) -->
                        <div class="detail-section" style="border-bottom: none;">
                            <div class="detail-section-header" style="cursor: pointer;" onclick="toggleDiagnostics()">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18zm1 13h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
                                Diagnostics
                                <svg id="diagToggleIcon" viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;margin-left:auto;transition:transform 0.2s;"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
                            </div>
                            <div id="tweetDiagnostics" style="display:none; margin-top: 8px;">
                                <div style="display:flex; gap:8px; margin-bottom: 8px;">
                                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); copyDiagnostics()">Copy JSON</button>
                                    <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); loadDiagnostics('${tweet.tweet_id}')">Refresh</button>
                                </div>
                                <pre class="detail-diagnostics-code">Loading...</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Metadata -->
                    <div class="detail-meta">
                        <!-- AI Analysis -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                AI Analysis
                            </div>
                            ${tweet.ai_title ? `
                                <div class="detail-ai-title">${escapeHtml(tweet.ai_title)}</div>
                            ` : ''}
                            ${tweet.ai_summary ? `
                                <div class="detail-ai-summary">${escapeHtml(tweet.ai_summary)}</div>
                            ` : ''}
                            ${tweet.ai_content_type ? `
                                <div class="detail-ai-type">
                                    <span class="detail-label">Type</span>
                                    <span class="detail-value">${escapeHtml(tweet.ai_content_type)}</span>
                                </div>
                            ` : ''}
                            ${tweet.ai_tags && tweet.ai_tags.length > 0 ? `
                                <div class="detail-tags">
                                    ${tweet.ai_tags.map(tag => `<span class="detail-tag">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                            ${!tweet.ai_title && !tweet.ai_summary && (!tweet.ai_tags || tweet.ai_tags.length === 0) ? `
                                <div class="detail-ai-pending">AI analysis pending...</div>
                            ` : ''}
                        </div>

                        <!-- Author -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                Author
                            </div>
                            <div class="detail-author-card">
                                <div class="detail-author-avatar">
                                    ${avatarWithKey
                                        ? `<img src="${avatarWithKey}" alt="${escapeHtml(displayName)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><span style="display:none;align-items:center;justify-content:center;width:100%;height:100%;font-weight:600;color:var(--text-muted);">${getInitials(authorUsername)}</span>`
                                        : `<span style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-weight:600;color:var(--text-muted);">${getInitials(authorUsername)}</span>`
                                    }
                                </div>
                                <div class="detail-author-info">
                                    <div class="detail-author-name">
                                        ${escapeHtml(displayName)}
                                        ${verified ? `<svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor"><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/></svg>` : ''}
                                    </div>
                                    <div class="detail-author-handle">@${escapeHtml(authorUsername)}</div>
                                </div>
                            </div>
                            ${hasAuthorMeta ? `
                                <div class="detail-author-stats">
                                    ${followerCount !== undefined ? `<div class="detail-author-stat"><span class="detail-stat-value">${formatNumber(followerCount)}</span><span class="detail-stat-label">Followers</span></div>` : ''}
                                    ${followingCount !== undefined ? `<div class="detail-author-stat"><span class="detail-stat-value">${formatNumber(followingCount)}</span><span class="detail-stat-label">Following</span></div>` : ''}
                                    ${tweetCount !== undefined ? `<div class="detail-author-stat"><span class="detail-stat-value">${formatNumber(tweetCount)}</span><span class="detail-stat-label">Posts</span></div>` : ''}
                                </div>
                            ` : ''}
                            ${authorBio ? `<div class="detail-author-bio">${escapeHtml(authorBio)}</div>` : ''}
                        </div>

                        <!-- Engagement Metrics -->
                        ${tweet.metrics && (tweet.metrics.likes || tweet.metrics.views || tweet.metrics.retweets || tweet.metrics.replies) ? `
                            <div class="detail-section">
                                <div class="detail-section-header">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                                    Engagement
                                </div>
                                <div class="detail-metrics">
                                    ${tweet.metrics.views ? `<div class="detail-metric"><span class="detail-metric-value">${formatNumber(tweet.metrics.views)}</span><span class="detail-metric-label">Views</span></div>` : ''}
                                    ${tweet.metrics.likes ? `<div class="detail-metric"><span class="detail-metric-value">${formatNumber(tweet.metrics.likes)}</span><span class="detail-metric-label">Likes</span></div>` : ''}
                                    ${tweet.metrics.retweets ? `<div class="detail-metric"><span class="detail-metric-value">${formatNumber(tweet.metrics.retweets)}</span><span class="detail-metric-label">Reposts</span></div>` : ''}
                                    ${tweet.metrics.replies ? `<div class="detail-metric"><span class="detail-metric-value">${formatNumber(tweet.metrics.replies)}</span><span class="detail-metric-label">Replies</span></div>` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Technical Details -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                Technical
                            </div>
                            <div class="detail-tech-grid">
                                ${tweet.media && tweet.media.length > 0 ? tweet.media.map((m, i) => `
                                    <div class="detail-tech-item">
                                        <span class="detail-tech-type">${m.type === 'video' ? 'Video' : 'Image'} ${tweet.media.length > 1 ? (i + 1) : ''}</span>
                                        ${m.width && m.height ? `<span class="detail-tech-detail">${m.width} x ${m.height}</span>` : ''}
                                        ${m.duration_seconds ? `<span class="detail-tech-detail">${formatDuration(m.duration_seconds)}</span>` : ''}
                                        ${m.size ? `<span class="detail-tech-detail">${formatFileSize(m.size)}</span>` : ''}
                                    </div>
                                `).join('') : '<div class="detail-tech-empty">No media files</div>'}
                            </div>
                            <div class="detail-tech-summary">
                                <div class="detail-row"><span class="detail-label">Total Size</span><span class="detail-value">${formatFileSize(totalSize)}</span></div>
                                <div class="detail-row"><span class="detail-label">Media Count</span><span class="detail-value">${tweet.media?.length || 0} files</span></div>
                            </div>
                        </div>

                        <!-- Archive Info -->
                        <div class="detail-section" style="border-bottom: none;">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.586l3.293-3.293 1.414 1.414L12 16.414l-4.707-4.707 1.414-1.414L12 13.586V3h2z"/><path d="M5 17v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/></svg>
                                Archive
                            </div>
                            <div class="detail-archive-info">
                                <div class="detail-row"><span class="detail-label">Posted</span><span class="detail-value">${formatFullDate(tweet.posted_at)}</span></div>
                                <div class="detail-row"><span class="detail-label">Archived</span><span class="detail-value">${formatFullDate(tweet.archived_at || tweet.created_at)}</span></div>
                                <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value detail-status-${tweet.status || 'completed'}">${tweet.status || 'Completed'}</span></div>
                                ${tweet.archive_path ? `<div class="detail-row"><span class="detail-label">Path</span><span class="detail-value detail-path">${escapeHtml(tweet.archive_path)}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Check AI analysis status and update button
                updateRegenerateButtonState(tweet.tweet_id);
                // Load diagnostics panel
                loadDiagnostics(tweet.tweet_id);

            } catch (error) {
                console.error('Failed to fetch tweet details:', error);
                body.innerHTML = `
                    <div class="empty-state" style="padding: 48px;">
                        <p>Failed to load tweet details.</p>
                    </div>
                `;
            }
        }

        function closeDetailPanel() {
            const overlay = document.getElementById('detailPanelOverlay');
            // Pause all videos before closing
            const videos = overlay.querySelectorAll('video');
            videos.forEach(video => {
                video.pause();
                video.currentTime = 0;
            });
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            currentTweetDetail = null;
        }

        // New helper function for the detail panel media grid
        function renderDetailMediaGrid(tweet) {
            if (!tweet.media || tweet.media.length === 0) {
                return '<div class="detail-media-empty">No media files</div>';
            }

            return tweet.media.map((m, index) => {
                const mediaUrl = addApiKey(m.url);
                const isVideo = m.type === 'video' || m.content_type?.startsWith('video/');

                if (isVideo) {
                    return `
                        <div class="detail-media-item video" onclick="openTheater(${index})">
                            <video src="${mediaUrl}" preload="metadata"></video>
                            <div class="detail-media-play">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            </div>
                            ${m.duration_seconds ? `<span class="detail-media-duration">${formatDuration(m.duration_seconds)}</span>` : ''}
                        </div>
                    `;
                } else {
                    return `
                        <div class="detail-media-item" onclick="openTheater(${index})">
                            <img src="${mediaUrl}" alt="Media ${index + 1}" loading="lazy">
                        </div>
                    `;
                }
            }).join('');
        }

        function renderDetailMedia(tweet) {
            if (!tweet.media || tweet.media.length === 0) return '';

            // Media URLs come from the /full endpoint in the format /api/v1/tweets/{id}/media/{filename}
            const images = tweet.media.filter(m => m.type === 'image' || m.content_type?.startsWith('image/'));
            const videos = tweet.media.filter(m => m.type === 'video' || m.content_type?.startsWith('video/'));

            // Build a descriptive base filename from author and tweet content
            const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
            const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
            const dateStr = tweet.posted_at ? new Date(tweet.posted_at).toISOString().split('T')[0] : 'archived';
            const titleSlug = (tweet.ai_title || tweet.text || '').slice(0, 40).replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+$/, '') || 'media';
            const baseFilename = `${authorUsername}_${dateStr}_${titleSlug}`;

            let html = '<div class="tweet-detail-media">';

            // Images
            if (images.length > 0) {
                html += `
                    <h4>
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13z"/>
                        </svg>
                        Images (${images.length})
                    </h4>
                `;

                const gridClass = images.length === 1 ? 'single' : images.length === 2 ? 'double' : images.length === 3 ? 'triple' : 'quad';

                html += `<div class="media-grid ${gridClass}">`;
                images.forEach((img, idx) => {
                    const imgUrl = addApiKey(img.url || '');
                    const ext = (img.filename || img.url || '').split('.').pop() || 'jpg';
                    const downloadName = images.length > 1 ? `${baseFilename}_${idx + 1}.${ext}` : `${baseFilename}.${ext}`;
                    html += `
                        <div class="media-item" onclick="openLightbox(${idx}, 'images')">
                            <img src="${imgUrl}" alt="Tweet image ${idx + 1}" loading="lazy" onerror="this.parentElement.style.display='none'">
                            <a class="media-download-btn" href="${imgUrl}" download="${escapeHtml(downloadName)}" onclick="event.stopPropagation()" title="Download image">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                                </svg>
                            </a>
                            ${(img.ai_caption || (img.ai_tags && img.ai_tags.length)) ? `
                                <div style="position:absolute; left:8px; bottom:8px; right:8px; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.55); color: white;"
                                     onclick="event.stopPropagation()">
                                    ${img.ai_caption ? `<div style="font-size: 12px; line-height: 1.35; max-height: 52px; overflow:hidden;">${escapeHtml(img.ai_caption)}</div>` : ''}
                                    ${(img.ai_tags && img.ai_tags.length) ? `<div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
                                        ${img.ai_tags.slice(0,6).map(t => `<span style="font-size:11px; padding:2px 6px; border-radius:999px; background: rgba(255,255,255,0.18);">${escapeHtml(t)}</span>`).join('')}
                                    </div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Videos
            if (videos.length > 0) {
                html += `
                    <h4 style="margin-top: 16px;">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 6.45V17.55c0 .48-.27.92-.7 1.12-.15.07-.31.1-.47.1-.29 0-.57-.1-.79-.3l-3.56-3.33c-.55-.52-.88-1.25-.88-2.02V10.87c0-.77.33-1.5.88-2.02l3.56-3.33c.35-.33.83-.45 1.26-.35.43.1.79.4.98.82.08.17.12.35.12.53v.53c0-.01 0 0 0 0zM14 18V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2z"/>
                        </svg>
                        Videos (${videos.length})
                    </h4>
                `;

                videos.forEach((video, idx) => {
                    const videoUrl = addApiKey(video.url || '');
                    const downloadName = videos.length > 1 ? `${baseFilename}_video${idx + 1}.mp4` : `${baseFilename}.mp4`;
                    const hasTranscript = !!(video.transcript && video.transcript.length > 0);
                    const transcriptId = `transcript-${tweet.tweet_id}-${idx}`;
                    const transcriptCopyId = `transcript-copy-${tweet.tweet_id}-${idx}`;

                    html += `
                        <div class="media-item video" data-video-idx="${idx}">
                            <video
                                src="${videoUrl}"
                                controls
                                preload="metadata"
                                playsinline
                            ></video>
                            <a class="media-download-btn video-download" href="${videoUrl}" download="${escapeHtml(downloadName)}" onclick="event.stopPropagation()" title="Download video">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                                </svg>
                            </a>
                            ${hasTranscript ? `
                                <button class="media-download-btn" style="right: 40px;" onclick="event.stopPropagation(); toggleTranscript('${transcriptId}')"
                                    title="Show transcript">T</button>
                                <div id="${transcriptId}" style="display:none; margin-top: 8px; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--bg-secondary);">
                                    <div style="display:flex; justify-content: space-between; align-items:center; gap:8px; margin-bottom:8px;">
                                        <div style="font-size: 12px; color: var(--text-muted);">
                                            Transcript ${video.transcript_language ? `(${escapeHtml(video.transcript_language)})` : ''}  ${video.transcript.length} chars
                                        </div>
                                        <button class="btn btn-ghost" id="${transcriptCopyId}" onclick="event.stopPropagation(); copyTranscript('${transcriptCopyId}', ${JSON.stringify(video.transcript)})">Copy</button>
                                    </div>
                                    <div style="font-size: 12px; white-space: pre-wrap; line-height: 1.4;">${escapeHtml(video.transcript)}</div>
                                </div>
                            ` : `
                                <button class="media-download-btn" style="right: 40px; opacity: 0.4; cursor: not-allowed;" onclick="event.stopPropagation()"
                                    title="No transcript yet">T</button>
                            `}

                            ${(video.ai_caption || (video.ai_tags && video.ai_tags.length)) ? `
                                <div style="margin-top: 8px; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--bg-secondary);">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Media AI</div>
                                    ${video.ai_caption ? `<div style="font-size: 12px; white-space: pre-wrap; line-height: 1.4;">${escapeHtml(video.ai_caption)}</div>` : ''}
                                    ${(video.ai_tags && video.ai_tags.length) ? `<div style="margin-top: 8px; display:flex; flex-wrap:wrap; gap:6px;">
                                        ${video.ai_tags.map(t => `<span class="tag-chip">${escapeHtml(t)}</span>`).join('')}
                                    </div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            html += '</div>';
            return html;
        }

        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Lightbox
        function openLightbox(index, type) {
            if (!currentTweetDetail || !currentTweetDetail.media) return;

            const images = currentTweetDetail.media.filter(m => m.type === 'image' || m.content_type?.startsWith('image/'));
            // Use the url field with API key
            lightboxImages = images.map(img => addApiKey(img.url || ''));
            lightboxIndex = index;

            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImage');
            const counter = document.getElementById('lightboxCounter');

            lightboxImg.src = lightboxImages[lightboxIndex];
            counter.textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;

            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            if (!document.getElementById('tweetDetailModal').classList.contains('active')) {
                document.body.style.overflow = '';
            }
        }

        function navigateLightbox(direction) {
            lightboxIndex = (lightboxIndex + direction + lightboxImages.length) % lightboxImages.length;
            document.getElementById('lightboxImage').src = lightboxImages[lightboxIndex];
            document.getElementById('lightboxCounter').textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;
        }

        // Premium Media Theater
        let theaterMedia = [];
        let theaterIndex = 0;
        let theaterTweet = null;

        // Autoplay mode state
        let autoplayEnabled = localStorage.getItem('xgrabba_autoplay') === 'true';

        function openTheater(tweetId, mediaIndex = 0) {
            const tweet = tweets.find(t => t.tweet_id === tweetId);
            if (!tweet || !tweet.media || tweet.media.length === 0) return;

            theaterTweet = tweet;
            theaterMedia = tweet.media;
            theaterIndex = mediaIndex;

            renderTheaterMedia();
            updateTheaterInfo();

            const theater = document.getElementById('mediaTheater');
            theater.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Auto-open info panel
            document.getElementById('theaterAiPanel').classList.add('active');

            // Initialize autoplay checkbox
            document.getElementById('autoplayCheckbox').checked = autoplayEnabled;

            // Show controls briefly then hide
            theater.classList.add('controls-visible');
            setTimeout(() => theater.classList.remove('controls-visible'), 2000);
        }

        function closeTheater() {
            const theater = document.getElementById('mediaTheater');
            const container = document.getElementById('theaterMediaContainer');

            // Clear autoplay timer
            if (autoplayTimer) {
                clearTimeout(autoplayTimer);
                autoplayTimer = null;
            }

            // Pause any playing video
            const video = container.querySelector('video');
            if (video) {
                video.pause();
                video.currentTime = 0;
            }

            theater.classList.remove('active');
            document.getElementById('theaterAiPanel').classList.remove('active');
            document.body.style.overflow = '';
            theaterTweet = null;
            theaterMedia = [];
        }

        function navigateTheater(direction) {
            if (theaterMedia.length <= 1) return;

            // Pause current video if any
            const container = document.getElementById('theaterMediaContainer');
            const video = container.querySelector('video');
            if (video) video.pause();

            theaterIndex = (theaterIndex + direction + theaterMedia.length) % theaterMedia.length;
            renderTheaterMedia();
            updateTheaterInfo();
        }

        let autoplayTimer = null;

        function renderTheaterMedia() {
            const container = document.getElementById('theaterMediaContainer');
            const media = theaterMedia[theaterIndex];
            const mediaUrl = addApiKey(media.url || '');
            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');

            // Clear any pending autoplay timer
            if (autoplayTimer) {
                clearTimeout(autoplayTimer);
                autoplayTimer = null;
            }

            if (isVideo) {
                container.innerHTML = `
                    <video
                        src="${mediaUrl}"
                        controls
                        autoplay
                        playsinline
                        style="outline: none;"
                    ></video>
                `;
                // Add ended event for autoplay
                const video = container.querySelector('video');
                video.addEventListener('ended', handleMediaEnded);
            } else {
                container.innerHTML = `<img src="${mediaUrl}" alt="Media">`;
                // For images in autoplay mode, advance after 5 seconds
                if (autoplayEnabled) {
                    autoplayTimer = setTimeout(handleMediaEnded, 5000);
                }
            }

            // Update counter
            document.getElementById('theaterCounter').textContent =
                theaterMedia.length > 1 ? `${theaterIndex + 1} / ${theaterMedia.length}` : '';

            // Update download link
            updateTheaterDownload();
        }

        function handleMediaEnded() {
            if (!autoplayEnabled) return;

            // Move to next media in current tweet
            if (theaterIndex < theaterMedia.length - 1) {
                navigateTheater(1);
            } else {
                // Move to next tweet with media
                const currentIdx = tweets.findIndex(t => t.tweet_id === theaterTweet.tweet_id);
                for (let i = currentIdx + 1; i < tweets.length; i++) {
                    if (tweets[i].media && tweets[i].media.length > 0) {
                        openTheater(tweets[i].tweet_id, 0);
                        return;
                    }
                }
                // Wrap to first tweet with media
                for (let i = 0; i < currentIdx; i++) {
                    if (tweets[i].media && tweets[i].media.length > 0) {
                        openTheater(tweets[i].tweet_id, 0);
                        return;
                    }
                }
            }
        }

        function toggleAutoplay() {
            autoplayEnabled = !autoplayEnabled;
            localStorage.setItem('xgrabba_autoplay', autoplayEnabled);
            document.getElementById('autoplayCheckbox').checked = autoplayEnabled;
        }

        function updateTheaterInfo() {
            if (!theaterTweet) return;

            const authorObj = typeof theaterTweet.author === 'object' ? theaterTweet.author : null;
            const authorName = authorObj ? (authorObj.name || authorObj.username) : (theaterTweet.author || 'Unknown');
            const authorUsername = authorObj ? authorObj.username : (theaterTweet.author || 'unknown');

            document.getElementById('theaterTitle').textContent = theaterTweet.ai_title || theaterTweet.text?.slice(0, 80) || 'Media';
            document.getElementById('theaterSubtitle').textContent = `@${authorUsername}`;

            // Update AI panel content
            updateTheaterAiContent();
        }

        function updateTheaterDownload() {
            const downloadBtn = document.getElementById('theaterDownload');
            const media = theaterMedia[theaterIndex];
            const mediaUrl = addApiKey(media.url || '');

            // Build smart filename
            const authorObj = typeof theaterTweet.author === 'object' ? theaterTweet.author : null;
            const authorUsername = authorObj ? authorObj.username : (theaterTweet.author || 'unknown');
            const dateStr = theaterTweet.posted_at ? new Date(theaterTweet.posted_at).toISOString().split('T')[0] : 'archived';
            const titleSlug = (theaterTweet.ai_title || theaterTweet.text || '').slice(0, 40).replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+$/, '') || 'media';

            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');
            const ext = isVideo ? 'mp4' : ((media.filename || media.url || '').split('.').pop() || 'jpg');
            const indexSuffix = theaterMedia.length > 1 ? `_${theaterIndex + 1}` : '';

            const filename = `${authorUsername}_${dateStr}_${titleSlug}${indexSuffix}.${ext}`;

            downloadBtn.href = mediaUrl;
            downloadBtn.download = filename;
        }

        function toggleTheaterAI() {
            const panel = document.getElementById('theaterAiPanel');
            panel.classList.toggle('active');
        }

        function updateTheaterAiContent() {
            const content = document.getElementById('theaterAiContent');
            const media = theaterMedia[theaterIndex];
            const tweet = theaterTweet;

            let html = '';

            // Author info
            const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
            const authorName = authorObj ? (authorObj.name || authorObj.username) : (tweet.author || 'Unknown');
            const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
            const avatarUrl = authorObj?.avatar_url ? addApiKey(authorObj.avatar_url) : null;

            html += `
                <div class="ai-panel-section author-section">
                    <div class="info-author">
                        ${avatarUrl ? `<img src="${avatarUrl}" class="info-avatar" alt="">` : '<div class="info-avatar-placeholder"></div>'}
                        <div class="info-author-text">
                            <div class="info-author-name">${escapeHtml(authorName)}</div>
                            <a href="https://x.com/${authorUsername}" target="_blank" class="info-author-handle">@${escapeHtml(authorUsername)}</a>
                        </div>
                    </div>
                </div>
            `;

            // Posted date & metrics
            const postedAt = tweet.posted_at ? new Date(tweet.posted_at) : null;
            const metrics = tweet.metrics || {};
            html += `
                <div class="ai-panel-section">
                    <div class="info-meta-grid">
                        ${postedAt ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                <span>${postedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${postedAt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</span>
                            </div>
                        ` : ''}
                        ${metrics.likes ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <span>${formatNumber(metrics.likes)}</span>
                            </div>
                        ` : ''}
                        ${metrics.retweets ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                                <span>${formatNumber(metrics.retweets)}</span>
                            </div>
                        ` : ''}
                        ${metrics.replies ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/></svg>
                                <span>${formatNumber(metrics.replies)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Media details
            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');
            const mediaType = isVideo ? 'Video' : 'Image';
            html += `
                <div class="ai-panel-section">
                    <div class="ai-panel-label">Media</div>
                    <div class="info-media-details">
                        <span class="info-media-type ${isVideo ? 'video' : 'image'}">${mediaType}</span>
                        ${theaterMedia.length > 1 ? `<span class="info-media-count">${theaterIndex + 1} of ${theaterMedia.length}</span>` : ''}
                    </div>
                </div>
            `;

            // Tweet text
            if (tweet.text) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">Tweet</div>
                        <div class="ai-panel-text">${escapeHtml(tweet.text)}</div>
                    </div>
                `;
            }

            // AI Summary
            if (tweet.ai_summary) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">AI Summary</div>
                        <div class="ai-panel-text">${escapeHtml(tweet.ai_summary)}</div>
                    </div>
                `;
            }

            // Media-specific AI caption
            if (media.ai_caption) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">AI Description</div>
                        <div class="ai-panel-text">${escapeHtml(media.ai_caption)}</div>
                    </div>
                `;
            }

            // Tags
            const tags = media.ai_tags || tweet.ai_tags || [];
            if (tags.length > 0) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">Tags</div>
                        <div class="ai-panel-tags">
                            ${tags.map(tag => `<span class="ai-panel-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Transcript (for videos)
            if (media.transcript) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">Transcript</div>
                        <div class="ai-panel-transcript">${escapeHtml(media.transcript)}</div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Toggle expanded tweet text
        function toggleTweetExpand(tweetId, btn) {
            const card = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
            const textEl = card.querySelector('.tweet-text');
            const isExpanded = textEl.classList.toggle('expanded');
            btn.textContent = isExpanded ? 'Less' : 'More';
        }

        // Gallery Mode - Browse All Media
        let galleryMode = false;
        let allGalleryMedia = [];
        let galleryTweetMap = new Map();

        function openGalleryMode() {
            // Collect all media from all tweets
            allGalleryMedia = [];
            galleryTweetMap = new Map();

            tweets.forEach(tweet => {
                if (tweet.media && tweet.media.length > 0) {
                    tweet.media.forEach((media, idx) => {
                        const globalIdx = allGalleryMedia.length;
                        allGalleryMedia.push({
                            ...media,
                            tweetId: tweet.tweet_id,
                            mediaIdx: idx
                        });
                        galleryTweetMap.set(globalIdx, tweet);
                    });
                }
            });

            if (allGalleryMedia.length === 0) {
                alert('No media found in archive');
                return;
            }

            // Set gallery mode flag and open theater
            galleryMode = true;
            theaterMedia = allGalleryMedia;
            theaterIndex = 0;
            theaterTweet = galleryTweetMap.get(0);

            renderTheaterMedia();
            updateTheaterInfo();
            updateGalleryCounter();

            const theater = document.getElementById('mediaTheater');
            theater.classList.add('active', 'gallery-mode');
            document.body.style.overflow = 'hidden';

            // Open AI panel by default in gallery mode
            document.getElementById('theaterAiPanel').classList.add('active');

            // Show controls briefly then hide
            theater.classList.add('controls-visible');
            setTimeout(() => theater.classList.remove('controls-visible'), 2000);
        }

        function closeGalleryMode() {
            galleryMode = false;
            allGalleryMedia = [];
            galleryTweetMap.clear();
            const theater = document.getElementById('mediaTheater');
            theater.classList.remove('gallery-mode');
        }

        function updateGalleryCounter() {
            document.getElementById('theaterCounter').textContent =
                `${theaterIndex + 1} / ${allGalleryMedia.length} media`;
        }

        // Override navigate to handle gallery mode
        const originalNavigateTheater = navigateTheater;
        navigateTheater = function(direction) {
            if (galleryMode) {
                // Pause current video if any
                const container = document.getElementById('theaterMediaContainer');
                const video = container.querySelector('video');
                if (video) video.pause();

                theaterIndex = (theaterIndex + direction + allGalleryMedia.length) % allGalleryMedia.length;
                theaterTweet = galleryTweetMap.get(theaterIndex);
                renderTheaterMedia();
                updateTheaterInfo();
                updateGalleryCounter();
            } else {
                originalNavigateTheater(direction);
            }
        };

        // Override close to handle gallery mode
        const originalCloseTheater = closeTheater;
        closeTheater = function() {
            if (galleryMode) {
                closeGalleryMode();
            }
            originalCloseTheater();
        };

        function closeTweetDetailModal() {
            // Redirect to new detail panel close function
            closeDetailPanel();
        }

        // Delete modal
        // Regenerate AI metadata for a tweet
        // Check if AI analysis is in progress for a tweet
        async function checkAIAnalysisStatus(tweetId) {
            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/ai-status`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (response.ok) {
                    const result = await response.json();
                    return result.in_progress || false;
                }
            } catch (error) {
                console.error('Failed to check AI status:', error);
            }
            return false;
        }

        // Update button state based on AI analysis status
        async function updateRegenerateButtonState(tweetId) {
            const btn = document.getElementById(`regenAiBtn-${tweetId}`);
            if (!btn) return;

            const inProgress = await checkAIAnalysisStatus(tweetId);
            if (inProgress) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Analyzing...';
                btn.classList.add('btn-processing');
                // Check again in 2 seconds
                setTimeout(() => updateRegenerateButtonState(tweetId), 2000);
            } else {
                btn.disabled = false;
                if (btn.classList.contains('btn-processing')) {
                    btn.classList.remove('btn-processing');
                    // Restore original button content
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Regenerate AI
                    `;

                    // Analysis finished - refresh the tweet details (and list) to show updated AI and transcripts.
                    // This is safe even if the user closed the modal; openTweetDetail will just re-open if needed.
                    loadTweets({ preserveScroll: true, keepSearch: true });
                    if (document.getElementById('tweetDetailModal').classList.contains('active')) {
                        openTweetDetail(tweetId);
                    }
                }
            }
        }

        let lastDiagnosticsJson = null;
        let diagnosticsExpanded = false;

        function toggleDiagnostics() {
            diagnosticsExpanded = !diagnosticsExpanded;
            const el = document.getElementById('tweetDiagnostics');
            const icon = document.getElementById('diagToggleIcon');
            if (el) el.style.display = diagnosticsExpanded ? 'block' : 'none';
            if (icon) icon.style.transform = diagnosticsExpanded ? 'rotate(180deg)' : 'rotate(0)';
        }

        async function loadDiagnostics(tweetId) {
            const container = document.getElementById('tweetDiagnostics');
            const codeEl = container?.querySelector('.detail-diagnostics-code') || container;
            if (!codeEl) return;
            codeEl.textContent = 'Loading diagnostics...';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/diagnostics`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) {
                    throw new Error(`Diagnostics failed: ${response.status}`);
                }
                const data = await response.json();
                lastDiagnosticsJson = data;

                // Pretty print with a small summary up top
                const summary = [
                    `AI in progress: ${data.ai_in_progress}`,
                    `Whisper enabled: ${data.pipeline?.whisper_enabled} (client init: ${data.pipeline?.whisper_client_initialized})`,
                    `FFmpeg: ${data.pipeline?.ffmpeg_available ? 'available' : 'missing'} ${data.pipeline?.ffmpeg_version ? '(' + data.pipeline.ffmpeg_version + ')' : ''}`,
                    `Video processor: ${data.pipeline?.video_processor_initialized}`,
                    `Has video: ${data.has_video} | Has images: ${data.has_images}`,
                    `Media items: ${data.media?.length || 0}`,
                ].join('\n');

                codeEl.textContent = summary + '\n\n' + JSON.stringify(data, null, 2);
            } catch (err) {
                lastDiagnosticsJson = null;
                codeEl.textContent = `Failed to load diagnostics: ${err}`;
            }
        }

        async function copyDiagnostics() {
            if (!lastDiagnosticsJson) {
                alert('No diagnostics loaded yet.');
                return;
            }
            try {
                await navigator.clipboard.writeText(JSON.stringify(lastDiagnosticsJson, null, 2));
            } catch {
                // Fallback: prompt
                prompt('Copy diagnostics JSON:', JSON.stringify(lastDiagnosticsJson, null, 2));
            }
        }

        function toggleTranscript(transcriptId) {
            const el = document.getElementById(transcriptId);
            if (!el) return;
            el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
        }

        async function copyTranscript(btnId, text) {
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.getElementById(btnId);
                if (btn) {
                    const old = btn.textContent;
                    btn.textContent = 'Copied';
                    setTimeout(() => { btn.textContent = old; }, 1000);
                }
            } catch {
                prompt('Copy transcript:', text);
            }
        }

        async function regenerateAI(tweetId) {
            const btn = document.getElementById(`regenAiBtn-${tweetId}`);
            if (!btn) return;

            // Check if already in progress
            const inProgress = await checkAIAnalysisStatus(tweetId);
            if (inProgress) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Already analyzing...';
                // Start polling for status
                setTimeout(() => updateRegenerateButtonState(tweetId), 2000);
                return;
            }

            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Analyzing...';
            btn.classList.add('btn-processing');

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/regenerate-ai`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.status === 409) {
                    // Already in progress
                    const result = await response.json();
                    if (result.in_progress) {
                        btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Already analyzing...';
                        // Start polling for status
                        setTimeout(() => updateRegenerateButtonState(tweetId), 2000);
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error('Failed to regenerate AI metadata');
                }

                // Accepted: regeneration runs asynchronously. Poll status until complete.
                setTimeout(() => updateRegenerateButtonState(tweetId), 1500);

            } catch (error) {
                console.error('Regenerate AI error:', error);
                btn.innerHTML = 'Failed - Retry';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                }, 3000);
            }
        }

        // Resync tweet - re-fetch from Twitter to get updated/full text
        async function resyncTweet(tweetId) {
            if (!tweetId) return;

            const btn = document.getElementById('detailResync');
            if (!btn) return;

            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Resyncing...';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/resync`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.status === 409) {
                    // Already in progress
                    const result = await response.json();
                    if (result.in_progress) {
                        btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Already syncing...';
                        // Poll for completion
                        pollResyncStatus(tweetId, originalContent);
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error('Failed to resync tweet');
                }

                // Accepted: resync runs asynchronously. Poll status until complete.
                pollResyncStatus(tweetId, originalContent);

            } catch (error) {
                console.error('Resync error:', error);
                btn.innerHTML = 'Failed - Retry';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                }, 3000);
            }
        }

        async function pollResyncStatus(tweetId, originalBtnContent) {
            const btn = document.getElementById('detailResync');

            try {
                const statusResponse = await fetch(`/api/v1/tweets/${tweetId}/ai-status`, {
                    headers: { 'X-API-Key': API_KEY }
                });

                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    if (status.in_progress) {
                        // Still processing, poll again
                        setTimeout(() => pollResyncStatus(tweetId, originalBtnContent), 2000);
                        return;
                    }
                }

                // Complete - refresh detail panel
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                }

                // Reload the detail panel to show updated data
                if (currentTweetDetail?.tweet_id === tweetId) {
                    await openTweetDetail(tweetId);
                }

                // Refresh the main list too
                await loadTweets();

            } catch (error) {
                console.error('Poll resync status error:', error);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                }
            }
        }

        function showDeleteModal(tweetId) {
            deleteTarget = tweetId;
            document.getElementById('deleteModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteModal() {
            deleteTarget = null;
            document.getElementById('deleteModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteTarget) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Deleting...';

            try {
                const response = await fetch(`/api/v1/tweets/${deleteTarget}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.ok) {
                    tweets = tweets.filter(t => t.tweet_id !== deleteTarget);
                    renderTweets(tweets);
                    updateStats();
                } else {
                    alert('Failed to delete tweet');
                }
            } catch (error) {
                console.error('Failed to delete:', error);
                alert('Failed to delete tweet');
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                    <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                </svg>
                Delete
            `;
            closeDeleteModal();
        });

        // Search functionality with debouncing
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            // Toggle clear button
            searchClear.classList.toggle('visible', query.length > 0);

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 150);
        });

        searchClear.addEventListener('click', () => {
            searchInput.value = '';
            searchClear.classList.remove('visible');
            searchResultsInfo.classList.remove('visible');
            renderTweets(tweets);
        });

        function performSearch(query) {
            if (!query) {
                searchResultsInfo.classList.remove('visible');
                renderTweets(tweets);
                return;
            }

            const lowerQuery = query.toLowerCase();
            const filtered = tweets.filter(t => {
                // Search through basic fields
                if (t.author && t.author.toLowerCase().includes(lowerQuery)) return true;
                if (t.author_display_name && t.author_display_name.toLowerCase().includes(lowerQuery)) return true;
                if (t.text && t.text.toLowerCase().includes(lowerQuery)) return true;
                if (t.ai_title && t.ai_title.toLowerCase().includes(lowerQuery)) return true;

                // Search through AI metadata
                if (t.ai_summary && t.ai_summary.toLowerCase().includes(lowerQuery)) return true;
                if (t.ai_content_type && t.ai_content_type.toLowerCase().includes(lowerQuery)) return true;

                // Search through AI tags array
                if (t.ai_tags && t.ai_tags.some(tag => tag.toLowerCase().includes(lowerQuery))) return true;

                // Search through AI topics array
                if (t.ai_topics && t.ai_topics.some(topic => topic.toLowerCase().includes(lowerQuery))) return true;

                // Search through video transcripts array
                if (t.transcripts && t.transcripts.some(transcript => transcript.toLowerCase().includes(lowerQuery))) return true;

                // Search through per-media AI tags (aggregated server-side)
                if (t.media_tags && t.media_tags.some(tag => tag.toLowerCase().includes(lowerQuery))) return true;

                // Search through per-media AI captions (aggregated server-side)
                if (t.media_captions && t.media_captions.some(caption => caption.toLowerCase().includes(lowerQuery))) return true;

                return false;
            });

            searchResultCount.textContent = filtered.length;
            searchQuerySpan.textContent = query;
            searchResultsInfo.classList.add('visible');

            renderTweets(filtered, query);
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    if (overlay.id === 'deleteModal') {
                        closeDeleteModal();
                    } else if (overlay.id === 'tweetDetailModal') {
                        closeTweetDetailModal();
                    } else {
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const theater = document.getElementById('mediaTheater');
            const lightbox = document.getElementById('lightbox');
            const detailPanel = document.getElementById('detailPanelOverlay');
            const deleteModal = document.getElementById('deleteModal');

            // Escape to close modals (priority: theater > lightbox > delete > detail panel)
            if (e.key === 'Escape') {
                if (theater.classList.contains('active')) {
                    closeTheater();
                } else if (lightbox.classList.contains('active')) {
                    closeLightbox();
                } else if (deleteModal.classList.contains('active')) {
                    closeDeleteModal();
                } else if (detailPanel.classList.contains('active')) {
                    closeDetailPanel();
                }
            }

            // Slash to focus search (when not in input)
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }

            // Arrow keys for theater navigation
            if (theater.classList.contains('active')) {
                if (e.key === 'ArrowLeft') navigateTheater(-1);
                if (e.key === 'ArrowRight') navigateTheater(1);
                if (e.key === 'i' || e.key === 'I') toggleTheaterAI();
            }

            // Arrow keys for lightbox navigation
            if (lightbox.classList.contains('active')) {
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
            }
        });

        // Touch gestures for theater
        (function initTouchGestures() {
            const theater = document.getElementById('mediaTheater');
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;

            theater.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            }, { passive: true });

            theater.addEventListener('touchend', (e) => {
                if (!theater.classList.contains('active')) return;

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const touchDuration = Date.now() - touchStartTime;

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const absX = Math.abs(deltaX);
                const absY = Math.abs(deltaY);

                // Minimum swipe distance and max time for swipe
                const minSwipeDistance = 50;
                const maxSwipeTime = 500;

                // Horizontal swipe for navigation
                if (absX > minSwipeDistance && absX > absY && touchDuration < maxSwipeTime) {
                    if (deltaX > 0) {
                        navigateTheater(-1); // Swipe right = previous
                    } else {
                        navigateTheater(1); // Swipe left = next
                    }
                }

                // Vertical swipe down to close (only if not interacting with video controls)
                if (absY > 100 && absY > absX * 2 && deltaY > 0 && touchDuration < maxSwipeTime) {
                    const target = e.target;
                    if (!target.closest('video') && !target.closest('.theater-ai-panel')) {
                        closeTheater();
                    }
                }

                // Tap to toggle controls (quick tap with minimal movement)
                if (absX < 10 && absY < 10 && touchDuration < 200) {
                    const target = e.target;
                    if (!target.closest('button') && !target.closest('a') && !target.closest('video') && !target.closest('.theater-ai-panel')) {
                        theater.classList.toggle('controls-visible');
                    }
                }
            }, { passive: true });
        })();

        // Scroll to top button
        window.addEventListener('scroll', () => {
            scrollTopBtn.classList.toggle('visible', window.scrollY > 400);
        });

        scrollTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Show keyboard hint briefly on load
        setTimeout(() => {
            keyboardHint.classList.add('visible');
            setTimeout(() => {
                keyboardHint.classList.remove('visible');
            }, 3000);
        }, 1000);

        // Initialize
        fetchTweets().then(() => {
            // Check if we should auto-open a specific tweet (from extension popup link)
            const tweetParam = params.get('tweet');
            if (tweetParam) {
                // Clean URL and open detail
                window.history.replaceState({}, '', window.location.pathname + (API_KEY && !params.get('key') ? '' : ''));
                openTweetDetail(tweetParam);
            }
        });

        // Keep the list responsive: update AI progress badges without requiring a full reload.
        startAIPolling();

        // Start system stats polling
        startSystemStatsPolling();

        async function refreshBookmarksAuthStatus() {
            const el = document.getElementById('bookmarksAuthStatus');
            const connectBtn = document.getElementById('connectBookmarksBtn');
            const disconnectBtn = document.getElementById('disconnectBookmarksBtn');
            if (!el || !connectBtn || !disconnectBtn) return;

            try {
                const resp = await fetch('/api/v1/bookmarks/oauth/status', { headers: { 'X-API-Key': API_KEY } });
                if (!resp.ok) {
                    el.textContent = '';
                    return;
                }
                const data = await resp.json();
                if (data.connected) {
                    el.textContent = `Bookmarks connected (user ${data.user_id})`;
                    disconnectBtn.style.display = 'inline-flex';
                } else {
                    el.textContent = 'Bookmarks not connected';
                    disconnectBtn.style.display = 'none';
                }
            } catch {
                el.textContent = '';
            }
        }

        function openBookmarksConnect(e) {
            if (e) e.preventDefault();
            if (!API_KEY) {
                alert('Set your xgrabba API key first.');
                return;
            }
            const userId = prompt('Enter your numeric X user id (recommended; avoids extra API calls). Leave blank to auto-detect once:');
            let url = `/bookmarks/oauth/start?key=${encodeURIComponent(API_KEY)}`;
            if (userId && userId.trim()) {
                const trimmed = userId.trim();
                if (!/^[0-9]+$/.test(trimmed)) {
                    alert('User id must be numeric.');
                    return;
                }
                url += `&user_id=${encodeURIComponent(trimmed)}`;
            } else {
                if (!confirm('Auto-detect user id using X API once during connect?')) return;
                url += `&infer_user_id=1`;
            }
            window.open(url, '_blank');
            // Refresh status after the user completes OAuth in the other window.
            setTimeout(refreshBookmarksAuthStatus, 3000);
        }

        async function disconnectBookmarks(e) {
            if (e) e.preventDefault();
            if (!confirm('Disconnect bookmarks monitoring? (Archives will remain)')) return;
            try {
                await fetch('/api/v1/bookmarks/oauth/disconnect', { method: 'POST', headers: { 'X-API-Key': API_KEY } });
            } catch {}
            await refreshBookmarksAuthStatus();
        }

        // Initial bookmarks status
        refreshBookmarksAuthStatus();
    </script>
</body>
</html>
