<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xgrabba</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2314b8a6'/%3E%3Cstop offset='100%25' stop-color='%230891b2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M20 8 L8 8 L8 40' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M108 8 L120 8 L120 40' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M20 120 L8 120 L8 88' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M108 120 L120 120 L120 88' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M40 40 L88 88 M88 40 L40 88' stroke='%23e7e9ea' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Brand colors */
            --brand-start: #14b8a6;
            --brand-end: #0891b2;
            --brand-gradient: linear-gradient(135deg, #14b8a6, #0891b2);
            /* Refined neutral color palette - sophisticated and minimal */
            --bg-primary: #0f1419;
            --bg-secondary: #16181c;
            --bg-hover: #1d1f23;
            --bg-elevated: #202327;
            --border-color: #2f3336;
            --border-subtle: #252829;
            --text-primary: #e7e9ea;
            --text-secondary: #71767b;
            --text-muted: #536471;
            --accent-primary: #1d9bf0;
            --accent-hover: #1a8cd8;
            --accent-subtle: rgba(29, 155, 240, 0.1);
            --danger: #f4212e;
            --danger-muted: #67070f;
            --success: #00ba7c;
            --retweet: #00ba7c;
            --like: #f91880;
            --reply: #1d9bf0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.4;
            font-size: 13px;
        }

        /* Header - Compact */
        .header {
            background: rgba(15, 20, 25, 0.85);
            border-bottom: 1px solid var(--border-subtle);
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(12px);
        }

        .header h1 {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header h1 svg {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }

        /* Container - Tighter */
        .container {
            max-width: 540px;
            margin: 0 auto;
            padding: 12px;
        }

        /* Search Bar - Compact */
        .search-container {
            position: relative;
            margin-bottom: 12px;
        }

        .search-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .search-bar:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px var(--accent-subtle);
        }

        .search-bar input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
        }

        .search-bar input::placeholder {
            color: var(--text-muted);
        }

        .search-bar svg {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .search-bar:focus-within svg {
            color: var(--accent-primary);
        }

        .search-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .search-clear:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        .search-clear.visible {
            display: flex;
        }

        .search-results-info {
            font-size: 11px;
            color: var(--text-muted);
            padding: 6px 12px;
            display: none;
        }

        .search-results-info.visible {
            display: block;
        }

        .search-results-info strong {
            color: var(--text-secondary);
        }

        /* Tweet List - Timeline Style */
        .tweet-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Tweet Card - Compact Timeline Item */
        .tweet-card {
            background: var(--bg-secondary);
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tweet-card:last-child {
            border-bottom: none;
        }

        .tweet-card:hover {
            background: var(--bg-hover);
        }

        .tweet-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 6px;
        }

        .tweet-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-elevated);
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .tweet-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tweet-author {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: baseline;
            gap: 4px;
            flex-wrap: wrap;
        }

        .tweet-author-name {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 3px;
            color: var(--text-primary);
        }

        .verified-badge {
            width: 14px;
            height: 14px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .tweet-author-username {
            color: var(--text-muted);
            font-size: 12px;
        }

        .tweet-author-followers {
            color: var(--text-muted);
            font-size: 11px;
            margin-left: 6px;
            opacity: 0.7;
        }

        .tweet-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 6px 0;
        }

        .tweet-tag {
            background: var(--bg-primary);
            color: var(--accent-primary);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .tweet-tag-more {
            background: var(--bg-elevated);
            color: var(--text-muted);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .tweet-meta-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 1px;
        }

        .tweet-date {
            color: var(--text-muted);
            font-size: 11px;
        }

        .tweet-text {
            font-size: 12px;
            line-height: 1.45;
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tweet-text .highlight {
            background: var(--accent-subtle);
            border-radius: 2px;
            padding: 0 2px;
        }

        /* Media Thumbnails - X.com-style larger media */
        .tweet-media-preview {
            display: grid;
            gap: 2px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
            width: 100%;
            max-width: 510px;
        }

        .tweet-media-preview.single { grid-template-columns: 1fr; }
        .tweet-media-preview.double { grid-template-columns: 1fr 1fr; }
        .tweet-media-preview.triple { grid-template-columns: 1fr 1fr; }
        .tweet-media-preview.quad { grid-template-columns: 1fr 1fr; }

        .tweet-media-preview .media-thumb {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            overflow: hidden;
            cursor: pointer;
        }

        .tweet-media-preview.single .media-thumb {
            aspect-ratio: 16/9;
            max-height: 290px;
        }

        .tweet-media-preview.double .media-thumb,
        .tweet-media-preview.triple .media-thumb,
        .tweet-media-preview.quad .media-thumb {
            aspect-ratio: 1/1;
        }

        .tweet-media-preview .media-thumb img,
        .tweet-media-preview .media-thumb video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            transition: opacity 0.2s ease;
        }

        .tweet-media-preview .media-thumb:hover img,
        .tweet-media-preview .media-thumb:hover video {
            opacity: 0.9;
        }

        .tweet-media-preview .video-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            backdrop-filter: blur(4px);
            transition: opacity 0.2s ease;
        }

        .tweet-media-preview .video-indicator svg {
            width: 18px;
            height: 18px;
            fill: white;
            margin-left: 3px;
        }

        .tweet-media-preview .video-duration {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 11px;
            font-weight: 500;
            padding: 2px 5px;
            border-radius: 3px;
            pointer-events: none;
            font-variant-numeric: tabular-nums;
        }

        .tweet-media-preview .media-thumb.playing .video-duration {
            display: none;
        }

        /* Inline video player styles */
        .tweet-media-preview .media-thumb.playing {
            /* Keep original aspect-ratio to prevent layout shift */
            /* Video will letterbox inside the container */
        }

        .tweet-media-preview .media-thumb.playing .video-indicator {
            opacity: 0;
            pointer-events: none;
        }

        .tweet-media-preview .media-thumb.playing video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: auto;
            background: #000;
        }

        .tweet-media-preview .media-thumb.playing img {
            visibility: hidden;
        }

        .tweet-media-preview .expand-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            z-index: 2;
        }

        .tweet-media-preview .media-thumb.playing .expand-btn {
            display: flex;
        }

        .tweet-media-preview .expand-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .tweet-media-preview .expand-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        .tweet-media-preview .more-media {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .tweet-media-preview .media-thumb.no-thumb {
            background: var(--bg-elevated);
        }

        .tweet-media-preview .thumb-placeholder {
            width: 100%;
            height: 100%;
            background: var(--bg-elevated);
        }

        /* Tweet Footer - Compact */
        .tweet-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tweet-metrics {
            display: flex;
            gap: 12px;
            color: var(--text-muted);
            font-size: 11px;
        }

        .tweet-metrics .metric {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-metrics .metric svg {
            width: 12px;
            height: 12px;
        }

        .tweet-metrics .metric.likes svg { color: var(--text-muted); }
        .tweet-metrics .metric.views svg { color: var(--text-muted); }

        .media-badge {
            background: var(--bg-elevated);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .media-badge svg {
            width: 10px;
            height: 10px;
        }

        .tweet-actions {
            display: flex;
            gap: 4px;
        }

        /* Buttons - Refined */
        .btn {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .btn svg {
            width: 12px;
            height: 12px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger-muted);
        }

        .btn-danger:hover {
            background: rgba(244, 33, 46, 0.1);
        }

        .btn-success {
            background: transparent;
            color: #00ba7c;
            border: 1px solid rgba(0, 186, 124, 0.3);
        }

        .btn-success:hover {
            background: rgba(0, 186, 124, 0.1);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .btn-processing {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-processing:hover {
            background: transparent;
        }

        .ai-progress-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-size: 11px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .ai-progress-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        /* Phase progress badges */
        .phase-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .phase-badge.fetching {
            background: rgba(29, 155, 240, 0.15);
            color: #1d9bf0;
        }

        .phase-badge.downloading {
            background: rgba(255, 180, 0, 0.15);
            color: #ffb400;
        }

        .phase-badge.analyzing {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .phase-badge.completed {
            background: rgba(0, 186, 124, 0.15);
            color: #00ba7c;
        }

        .phase-badge.failed {
            background: rgba(244, 33, 46, 0.15);
            color: #f4212e;
        }

        .phase-badge.fade-out {
            opacity: 0;
            transform: scale(0.8);
        }

        .phase-badge .phase-spinner {
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 5px;
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        /* X Bookmarks Button */
        .bookmarks-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .bookmarks-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--text-muted);
        }

        .bookmarks-btn .x-logo {
            width: 18px;
            height: 18px;
        }

        .bookmarks-btn.connected {
            border-color: rgba(0, 186, 124, 0.4);
            background: rgba(0, 186, 124, 0.1);
        }

        .bookmarks-btn.connected .x-logo {
            color: #00ba7c;
        }

        .bookmarks-status {
            font-size: 11px;
            font-weight: 500;
        }

        .bookmarks-status.connected {
            color: #00ba7c;
        }

        .bookmarks-status.disconnected {
            color: var(--text-muted);
        }

        /* Bookmarks Modal */
        .bookmarks-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 300;
            padding: 24px;
            overflow-y: auto;
        }

        .bookmarks-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .bookmarks-modal-content {
            width: 100%;
            max-width: 600px;
            background: var(--bg-primary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
            animation: detailSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bookmarks-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .bookmarks-modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .bookmarks-modal-header h2 svg {
            width: 20px;
            height: 20px;
        }

        .bookmarks-modal-body {
            padding: 20px;
        }

        .bookmarks-connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .bookmarks-connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .bookmarks-connection-dot.connected {
            background: #00ba7c;
            box-shadow: 0 0 8px rgba(0, 186, 124, 0.5);
        }

        .bookmarks-connection-info {
            flex: 1;
        }

        .bookmarks-connection-info .status {
            font-weight: 600;
            font-size: 14px;
        }

        .bookmarks-connection-info .details {
            font-size: 12px;
            color: var(--text-muted);
        }

        .bookmarks-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .bookmarks-controls .btn {
            flex: 1;
            justify-content: center;
        }

        .bookmarks-activity {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .bookmarks-activity-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
        }

        .bookmarks-activity-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .bookmarks-activity-item:last-child {
            border-bottom: none;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .activity-dot.success { background: #00ba7c; }
        .activity-dot.rate_limited { background: #ffd400; }
        .activity-dot.failed { background: #f4212e; }
        .activity-dot.paused { background: var(--text-muted); }
        .activity-dot.resumed { background: #1d9bf0; }
        .activity-dot.check_now { background: #1d9bf0; }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-title {
            font-size: 13px;
            font-weight: 500;
        }

        .activity-details {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .bookmarks-activity-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .btn-browse-media {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--brand-start), var(--brand-end));
            color: #fff;
            font-weight: 600;
            font-size: 13px;
            border-radius: 20px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
        }

        .btn-browse-media:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
        }

        .btn-browse-media svg {
            opacity: 0.9;
        }

        .btn-browse-media .btn-text-short {
            display: none;
        }

        /* Empty State - Minimal */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .empty-state svg {
            width: 40px;
            height: 40px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .empty-state h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .empty-state p {
            font-size: 12px;
        }

        /* Infinite scroll loading indicator */
        .load-more-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .load-more-indicator .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-top-color: var(--brand-start);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .load-more-indicator .load-more-hint {
            color: var(--text-muted);
            opacity: 0.6;
        }

        .load-more-indicator .load-more-end {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Modal Base - Clean */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 10px;
            max-width: 520px;
            width: 100%;
            margin: auto;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-subtle);
        }

        .modal-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            border-radius: 10px 10px 0 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 14px;
        }

        .modal-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Tweet Detail Modal - Refined */
        .tweet-detail-modal {
            max-width: 560px;
        }

        .tweet-detail-content {
            padding: 0;
        }

        .tweet-detail-header {
            padding: 14px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tweet-detail-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .tweet-detail-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tweet-detail-author {
            flex: 1;
        }

        .tweet-detail-author-name {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-detail-author-username {
            color: var(--text-muted);
            font-size: 12px;
        }

        .tweet-detail-author-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .tweet-detail-author-stats span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .tweet-detail-author-bio {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.4;
            max-width: 400px;
        }

        /* Author tooltip */
        .author-tooltip-trigger {
            position: relative;
            cursor: pointer;
        }

        .author-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            min-width: 240px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: none;
            animation: tooltipFadeIn 0.15s ease-out;
        }

        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .author-tooltip-trigger:hover .author-tooltip {
            display: block;
        }

        .author-tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .author-tooltip-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-primary);
            overflow: hidden;
            flex-shrink: 0;
        }

        .author-tooltip-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .author-tooltip-names {
            flex: 1;
            min-width: 0;
        }

        .author-tooltip-displayname {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .author-tooltip-username {
            color: var(--text-muted);
            font-size: 12px;
        }

        .author-tooltip-bio {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .author-tooltip-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
        }

        .author-tooltip-stat {
            display: flex;
            gap: 4px;
        }

        .author-tooltip-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .author-tooltip-stat-label {
            color: var(--text-muted);
        }

        .tweet-detail-body {
            padding: 14px;
        }

        .tweet-detail-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* AI Analysis Section */
        .ai-analysis {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent-primary);
        }

        .ai-summary {
            font-size: 13px;
            line-height: 1.4;
            color: var(--text-secondary);
            font-style: italic;
        }

        .ai-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .ai-tag {
            background: var(--bg-primary);
            color: var(--accent-primary);
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .ai-tag:hover {
            background: var(--bg-elevated);
        }

        /* Media Stats */
        .media-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .media-stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .media-stat-type {
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .media-stat-detail {
            padding: 2px 6px;
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        .tweet-detail-date {
            color: var(--text-muted);
            font-size: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tweet-detail-date a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .tweet-detail-date a:hover {
            text-decoration: underline;
        }

        /* Tweet Detail Metrics - Compact */
        .tweet-detail-metrics {
            display: flex;
            gap: 16px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
            flex-wrap: wrap;
        }

        .tweet-detail-metrics .metric {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-detail-metrics .metric-value {
            font-weight: 600;
            font-size: 13px;
        }

        .tweet-detail-metrics .metric-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Tweet Detail Media Grid - Constrained */
        .tweet-detail-media {
            margin-top: 12px;
        }

        .tweet-detail-media h4 {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .tweet-detail-media h4 svg {
            width: 14px;
            height: 14px;
        }

        .media-grid {
            display: grid;
            gap: 4px;
            border-radius: 8px;
            overflow: hidden;
        }

        .media-grid.single { grid-template-columns: 1fr; }
        .media-grid.double { grid-template-columns: 1fr 1fr; }
        .media-grid.triple {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        .media-grid.triple .media-item:first-child {
            grid-row: span 2;
        }
        .media-grid.quad {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        .media-item {
            position: relative;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }

        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            min-height: 120px;
            max-height: 280px;
            transition: transform 0.2s;
        }

        .media-grid.single .media-item img {
            max-height: 320px;
        }

        .media-item:hover img {
            transform: scale(1.01);
        }

        .media-download-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s, background 0.15s;
            text-decoration: none;
        }

        .media-item:hover .media-download-btn {
            opacity: 1;
        }

        .media-download-btn:hover {
            background: var(--accent-primary);
        }

        .media-download-btn svg {
            width: 14px;
            height: 14px;
        }

        .media-download-btn.video-download {
            bottom: auto;
            top: 8px;
        }

        .media-item.video {
            background: #000;
            border-radius: 6px;
            overflow: hidden;
        }

        .media-item video {
            width: 100%;
            max-height: 320px;
            display: block;
            background: #000;
        }

        /* Archive Metadata - Minimal */
        .archive-metadata {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
        }

        .archive-metadata h4 {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .archive-metadata h4 svg {
            width: 12px;
            height: 12px;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 6px 0;
            font-size: 12px;
        }

        .metadata-row:not(:last-child) {
            border-bottom: 1px solid var(--border-subtle);
        }

        .metadata-label {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .metadata-value {
            text-align: right;
            word-break: break-all;
            margin-left: 12px;
            color: var(--text-secondary);
        }

        .metadata-value a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .metadata-value a:hover {
            text-decoration: underline;
        }

        /* Tweet Detail Actions - Compact */
        .tweet-detail-actions {
            padding: 12px 14px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
        }

        .tweet-detail-actions .action-group {
            display: flex;
            gap: 6px;
        }

        /* Image Lightbox - Clean */
        .lightbox-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lightbox-overlay.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 4px;
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-nav.prev { left: -50px; }
        .lightbox-nav.next { right: -50px; }

        .lightbox-counter {
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Premium Media Theater */
        .media-theater {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 400;
            background: #000;
        }

        .media-theater.active {
            display: flex;
            flex-direction: column;
        }

        .theater-backdrop {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000 100%);
        }

        .theater-header {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .media-theater:hover .theater-header,
        .media-theater.controls-visible .theater-header {
            opacity: 1;
            transform: translateY(0);
        }

        .theater-title {
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .theater-subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 13px;
            margin-top: 2px;
        }

        .theater-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theater-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }

        .theater-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .theater-btn svg {
            width: 18px;
            height: 18px;
        }

        .theater-btn.icon-only {
            padding: 10px;
            border-radius: 50%;
        }

        .theater-btn.close-btn {
            background: rgba(255,255,255,0.05);
        }

        .theater-btn.close-btn:hover {
            background: rgba(255,77,77,0.2);
        }

        .theater-stage {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            min-width: 0;
            background: #000; /* Black bars for letterboxing */
        }

        .theater-media-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-media-container img {
            max-width: 100%;
            max-height: calc(100vh - 140px);
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.6);
            transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-media-container video {
            max-width: 100%;
            max-height: calc(100vh - 140px);
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.6);
            background: #000;
            transition: max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Mobile floating close button - always visible */
        .theater-floating-close {
            display: none;
        }

        /* Mobile bottom action bar - hidden on desktop */
        .theater-mobile-actions {
            display: none;
        }

        .theater-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s, background 0.2s;
            backdrop-filter: blur(10px);
        }

        .media-theater:hover .theater-nav,
        .media-theater.controls-visible .theater-nav {
            opacity: 1;
        }

        .theater-nav:hover {
            background: rgba(255,255,255,0.2);
        }

        .theater-nav.prev { left: 24px; }
        .theater-nav.next { right: 24px; }

        .theater-nav svg {
            width: 28px;
            height: 28px;
        }

        .theater-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 24px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .media-theater:hover .theater-footer,
        .media-theater.controls-visible .theater-footer {
            opacity: 1;
            transform: translateY(0);
        }

        .theater-counter {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-variant-numeric: tabular-nums;
        }

        /* AI Notes Panel - Sidebar Layout */
        .theater-main {
            display: flex;
            flex: 1;
            min-height: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-stage {
            flex: 1;
            min-width: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-ai-panel {
            width: 380px;
            min-width: 380px;
            background: rgba(15, 20, 25, 0.98);
            border-left: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            margin-right: -380px;
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theater-ai-panel.active {
            margin-right: 0;
        }

        .ai-panel-inner {
            width: 380px;
            min-width: 380px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ai-panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .ai-panel-header h3 {
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-panel-header h3 svg {
            width: 18px;
            height: 18px;
            color: var(--brand-start);
        }

        .ai-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .ai-panel-section {
            margin-bottom: 24px;
        }

        .ai-panel-section:last-child {
            margin-bottom: 0;
        }

        .ai-panel-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 8px;
        }

        .ai-panel-text {
            font-size: 14px;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
        }

        .ai-panel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ai-panel-tag {
            padding: 6px 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .ai-panel-transcript {
            font-size: 13px;
            line-height: 1.7;
            color: rgba(255,255,255,0.8);
            white-space: pre-wrap;
            max-height: none;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        /* Info Panel - Author Section */
        .info-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .info-avatar-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
        }

        .info-author-text {
            flex: 1;
            min-width: 0;
        }

        .info-author-name {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .info-author-handle {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            text-decoration: none;
        }

        .info-author-handle:hover {
            color: var(--brand-start);
        }

        /* Info Panel - Meta Grid */
        .info-meta-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .info-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .info-meta-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        /* Info Panel - Media Details */
        .info-media-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-media-type {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-media-type.video {
            background: rgba(249, 24, 128, 0.15);
            color: #f91880;
        }

        .info-media-type.image {
            background: rgba(29, 155, 240, 0.15);
            color: #1d9bf0;
        }

        .info-media-count {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }

        /* Autoplay Toggle */
        .autoplay-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
        }

        .autoplay-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        .autoplay-toggle input {
            width: 16px;
            height: 16px;
            accent-color: var(--brand-start);
        }

        .autoplay-toggle span {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
        }

        /* Gallery Mode - Browse All Media */
        .media-theater.gallery-mode .theater-header {
            opacity: 1;
            transform: none;
            background: rgba(0,0,0,0.9);
        }

        .media-theater.gallery-mode .theater-footer {
            opacity: 1;
            transform: none;
            background: rgba(0,0,0,0.9);
        }

        .gallery-nav-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
        }

        .gallery-nav-info .nav-hint {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gallery-nav-info kbd {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
        }

        /* ============================================
           SYSTEM STATS BAR - Terminal/Dashboard Style
           ============================================ */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 16px;
            background: linear-gradient(180deg, rgba(20, 184, 166, 0.08) 0%, transparent 100%);
            border-bottom: 1px solid rgba(20, 184, 166, 0.15);
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .stats-bar::-webkit-scrollbar { display: none; }

        .stat-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .stat-pill:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .stat-pill svg {
            width: 12px;
            height: 12px;
            opacity: 0.6;
        }

        .stat-label {
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 9px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .stat-value.good { color: #00ba7c; }
        .stat-value.warn { color: #ffd400; }
        .stat-value.critical { color: #f4212e; }

        .stat-bar {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease-out;
        }

        .stat-bar-fill.good { background: linear-gradient(90deg, #00ba7c, #14b8a6); }
        .stat-bar-fill.warn { background: linear-gradient(90deg, #ffd400, #ff9500); }
        .stat-bar-fill.critical { background: linear-gradient(90deg, #f4212e, #ff6b6b); }

        .stat-separator {
            width: 1px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
        }

        .stat-divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.15);
            margin: 0 4px;
        }

        .stat-pill.archive-stat {
            background: rgba(29, 155, 240, 0.1);
            border-color: rgba(29, 155, 240, 0.2);
        }

        .stat-pill.archive-stat .stat-label {
            color: rgba(29, 155, 240, 0.8);
        }

        .stat-pill.backfill-pill {
            background: rgba(255, 171, 0, 0.15);
            border-color: rgba(255, 171, 0, 0.3);
            cursor: pointer;
        }

        .stat-pill.backfill-pill:hover {
            background: rgba(255, 171, 0, 0.25);
            border-color: rgba(255, 171, 0, 0.5);
        }

        .stat-pill.backfill-pill .stat-label {
            color: rgba(255, 171, 0, 0.9);
        }

        .stat-pill.backfill-pill .stat-value {
            color: #ffab00;
        }

        /* CPU Sparkline */
        .stat-pill.cpu-stat {
            background: rgba(0, 186, 124, 0.1);
            border-color: rgba(0, 186, 124, 0.2);
        }

        .stat-pill.cpu-stat .stat-label {
            color: rgba(0, 186, 124, 0.8);
        }

        .cpu-sparkline {
            width: 80px;
            height: 20px;
            margin-left: 6px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.2);
        }

        .cpu-sparkline polyline {
            transition: stroke 0.3s;
        }

        .cpu-sparkline.warn polyline {
            stroke: #ffd400;
        }

        .cpu-sparkline.critical polyline {
            stroke: #f4212e;
        }

        /* ============================================
           DETAIL PANEL - Multi-Column Magazine Layout
           ============================================ */
        .detail-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 200;
            padding: 24px;
            overflow-y: auto;
        }

        .detail-panel-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .detail-panel {
            width: 100%;
            max-width: 1200px;
            background: var(--bg-primary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: detailSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes detailSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(180deg, rgba(20, 184, 166, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .detail-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-elevated);
            overflow: hidden;
            border: 2px solid rgba(20, 184, 166, 0.3);
        }

        .detail-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-author-info h2 {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
        }

        .detail-author-info .username {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .detail-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .detail-close:hover {
            background: rgba(244, 33, 46, 0.15);
            color: #f4212e;
        }

        .detail-body {
            display: grid;
            grid-template-columns: 1fr 340px;
            min-height: 400px;
        }

        /* Left Column - Content */
        .detail-content {
            padding: 20px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-section {
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }

        .detail-section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-section-label svg {
            width: 12px;
            height: 12px;
            opacity: 0.7;
        }

        .detail-tweet-text {
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .detail-ai-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .detail-ai-summary {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .detail-tag {
            padding: 5px 12px;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.15), rgba(8, 145, 178, 0.15));
            border: 1px solid rgba(20, 184, 166, 0.2);
            border-radius: 20px;
            font-size: 11px;
            color: var(--brand-start);
            font-weight: 500;
        }

        /* Media Preview in Detail */
        .detail-media-preview {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .detail-media-thumb {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .detail-media-thumb:hover {
            transform: scale(1.02);
        }

        .detail-media-thumb img,
        .detail-media-thumb video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .detail-media-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            padding: 3px 8px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            color: white;
        }

        /* Right Column - Metadata */
        .detail-meta {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 16px;
            font-size: 13px;
        }

        .detail-meta-group {
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-meta-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .detail-meta-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-meta-title svg {
            width: 12px;
            height: 12px;
        }

        .detail-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .detail-meta-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .detail-meta-key {
            color: var(--text-muted);
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 11px;
        }

        .detail-meta-value {
            color: var(--text-primary);
            font-weight: 500;
            text-align: right;
        }

        .detail-meta-value.mono {
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 11px;
        }

        /* Metrics Row */
        .detail-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .detail-metric {
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            text-align: center;
        }

        .detail-metric-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Transcript Section */
        .detail-transcript {
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Menlo', monospace;
        }

        .detail-transcript::-webkit-scrollbar {
            width: 4px;
        }

        .detail-transcript::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* Detail Actions */
        .detail-actions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-color);
        }

        .detail-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            text-decoration: none;
        }

        .detail-action-btn.primary {
            background: linear-gradient(135deg, var(--brand-start), var(--brand-end));
            color: white;
        }

        .detail-action-btn.primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .detail-action-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .detail-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .detail-action-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Detail Panel Header */
        .detail-close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .detail-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .detail-close-btn svg {
            width: 20px;
            height: 20px;
        }

        .detail-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .detail-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-header-actions .detail-action-btn {
            flex: none;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            font-size: 12px;
        }

        .detail-header-actions .detail-action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .detail-header-actions .detail-action-btn.danger:hover {
            background: rgba(244, 33, 46, 0.15);
            color: var(--danger);
            border-color: rgba(244, 33, 46, 0.3);
        }

        /* Detail Panel Navigation */
        .detail-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 210;
            opacity: 0;
            pointer-events: none;
        }

        .detail-panel-overlay.active .detail-nav {
            opacity: 1;
            pointer-events: auto;
        }

        .detail-nav:hover {
            background: rgba(20, 184, 166, 0.2);
            border-color: rgba(20, 184, 166, 0.4);
            color: var(--text-primary);
            transform: translateY(-50%) scale(1.1);
        }

        .detail-nav:active {
            transform: translateY(-50%) scale(0.95);
        }

        .detail-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .detail-nav svg {
            width: 24px;
            height: 24px;
        }

        .detail-nav.prev {
            left: max(12px, calc((100vw - 1250px) / 2 - 60px));
        }

        .detail-nav.next {
            right: max(12px, calc((100vw - 1250px) / 2 - 60px));
        }

        .detail-position {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            margin-left: 12px;
            padding-left: 12px;
            border-left: 1px solid var(--border-subtle);
        }

        .detail-position-count {
            font-variant-numeric: tabular-nums;
        }

        .detail-position kbd {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-muted);
        }

        .detail-header-actions .detail-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Detail Section Headers */
        .detail-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .detail-section-header svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .detail-section-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: rgba(20, 184, 166, 0.15);
            border-radius: 10px;
            font-size: 10px;
            color: var(--brand-start);
        }

        /* Detail Media Grid */
        .detail-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .detail-media-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        .detail-media-item {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .detail-media-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .detail-media-item img,
        .detail-media-item video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .detail-media-play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .detail-media-item:hover .detail-media-play {
            opacity: 1;
        }

        .detail-media-play svg {
            width: 36px;
            height: 36px;
            color: white;
        }

        .detail-media-duration {
            position: absolute;
            bottom: 6px;
            right: 6px;
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            color: white;
        }

        /* Inline Video Player in Detail Panel */
        .detail-media-item.video.inline-player {
            aspect-ratio: auto;
            grid-column: 1 / -1;
            max-width: 100%;
            cursor: default;
        }

        .detail-media-item.video.inline-player:hover {
            transform: none;
            box-shadow: none;
        }

        .detail-media-item.video.inline-player video {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            background: #000;
        }

        .detail-media-item.video.inline-player .detail-media-play {
            display: none;
        }

        .detail-video-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .detail-media-item.video.inline-player:hover .detail-video-controls {
            opacity: 1;
        }

        .detail-video-controls button {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .detail-video-controls button:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .detail-video-controls button svg {
            width: 16px;
            height: 16px;
        }

        .detail-video-download {
            position: absolute;
            bottom: 48px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            text-decoration: none;
        }

        .detail-media-item.video.inline-player:hover .detail-video-download {
            opacity: 1;
        }

        .detail-video-download:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .detail-video-download svg {
            width: 16px;
            height: 16px;
        }

        /* Detail Tweet Text */
        .detail-tweet-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* X-Style Tweet Card in Detail Panel */
        .detail-tweet-card {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }

        .detail-tweet-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-elevated);
        }

        .detail-tweet-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-tweet-avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-muted);
            background: var(--bg-elevated);
        }

        .detail-tweet-main {
            flex: 1;
            min-width: 0;
        }

        .detail-tweet-header {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }

        .detail-tweet-name {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .detail-tweet-name .verified-badge {
            width: 18px;
            height: 18px;
        }

        .detail-tweet-handle {
            color: var(--text-muted);
            font-size: 14px;
        }

        .detail-tweet-date {
            color: var(--text-muted);
            font-size: 14px;
        }

        .detail-tweet-date::before {
            content: "";
            margin: 0 6px;
        }

        .detail-tweet-body {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 8px;
        }

        .detail-tweet-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        .detail-tweet-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .detail-tweet-stat svg {
            width: 16px;
            height: 16px;
        }

        .detail-tweet-stat-value {
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Transcript Toggle Button (near video) */
        .transcript-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid rgba(20, 184, 166, 0.3);
            border-radius: 20px;
            color: var(--brand-start);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .transcript-toggle-btn:hover {
            background: rgba(20, 184, 166, 0.2);
            border-color: rgba(20, 184, 166, 0.5);
        }

        .transcript-toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        .transcript-toggle-btn.active {
            background: rgba(20, 184, 166, 0.2);
        }

        /* Collapsible Transcript Panel */
        .detail-transcript-panel {
            margin-top: 12px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            display: none;
        }

        .detail-transcript-panel.visible {
            display: block;
        }

        .detail-transcript-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .detail-transcript-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .detail-transcript-lang {
            padding: 2px 6px;
            background: rgba(20, 184, 166, 0.15);
            border-radius: 4px;
            color: var(--brand-start);
            font-weight: 500;
            text-transform: uppercase;
        }

        .detail-transcript-copy-btn {
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .detail-transcript-copy-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .detail-transcript-copy-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .detail-transcript-content {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .detail-transcript-content::-webkit-scrollbar {
            width: 6px;
        }

        .detail-transcript-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Insights Section (renamed from AI Analysis) */
        .detail-insights-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .detail-insights-summary {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .detail-insights-type {
            display: inline-block;
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Detail Transcript - Enhanced */
        .detail-transcript {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.08), rgba(8, 145, 178, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(20, 184, 166, 0.2);
            overflow: hidden;
        }

        .detail-transcript .detail-section-header {
            background: rgba(20, 184, 166, 0.1);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(20, 184, 166, 0.15);
        }

        .detail-transcript-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .detail-transcript-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(20, 184, 166, 0.2);
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            color: var(--brand-start);
            text-transform: uppercase;
        }

        .detail-transcript-badge svg {
            width: 10px;
            height: 10px;
        }

        .detail-transcript-copy {
            background: rgba(20, 184, 166, 0.15);
            border: 1px solid rgba(20, 184, 166, 0.3);
            color: var(--brand-start);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .detail-transcript-copy:hover {
            background: rgba(20, 184, 166, 0.25);
            border-color: rgba(20, 184, 166, 0.5);
        }

        .detail-transcript-copy.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .detail-transcript-copy svg {
            width: 12px;
            height: 12px;
        }

        .detail-transcript-text {
            max-height: 280px;
            overflow-y: auto;
            padding: 16px;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .detail-transcript-text::-webkit-scrollbar {
            width: 4px;
        }

        .detail-transcript-text::-webkit-scrollbar-thumb {
            background: rgba(20, 184, 166, 0.3);
            border-radius: 2px;
        }

        .detail-transcript-text::-webkit-scrollbar-thumb:hover {
            background: rgba(20, 184, 166, 0.5);
        }

        /* No Transcript State */
        .detail-no-transcript {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            border: 1px dashed var(--border-color);
        }

        .detail-no-transcript svg {
            width: 24px;
            height: 24px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        /* Detail Diagnostics */
        .detail-diagnostics-code {
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.5;
            color: var(--text-secondary);
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 0;
        }

        /* =============================================
           MAIN MEDIA VIEWER WITH THUMBNAIL NAVIGATION
           ============================================= */
        .detail-main-media {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .detail-main-media-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            max-height: 500px;
            background: #000;
        }

        .detail-main-media-container img,
        .detail-main-media-container video {
            max-width: 100%;
            max-height: 500px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .detail-main-media-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .detail-main-media-nav:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-50%) scale(1.1);
        }

        .detail-main-media-nav.prev { left: 12px; }
        .detail-main-media-nav.next { right: 12px; }

        .detail-main-media-nav svg {
            width: 20px;
            height: 20px;
        }

        .detail-main-media-counter {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 12px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            font-size: 12px;
            color: white;
            font-variant-numeric: tabular-nums;
        }

        .detail-main-media-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .detail-main-media:hover .detail-main-media-actions {
            opacity: 1;
        }

        .detail-main-media-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            text-decoration: none;
        }

        .detail-main-media-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .detail-main-media-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Media Thumbnails Strip */
        .detail-media-thumbs {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .detail-media-thumbs::-webkit-scrollbar {
            height: 4px;
        }

        .detail-media-thumbs::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .detail-media-thumb {
            flex-shrink: 0;
            width: 64px;
            height: 48px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            opacity: 0.6;
            background: #000;
        }

        .detail-media-thumb:hover {
            opacity: 0.9;
        }

        .detail-media-thumb.active {
            border-color: var(--brand-start);
            opacity: 1;
        }

        .detail-media-thumb img,
        .detail-media-thumb video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-media-thumb .thumb-video-icon {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
        }

        .detail-media-thumb .thumb-video-icon svg {
            width: 16px;
            height: 16px;
            color: white;
        }

        /* =============================================
           NOTES SECTION
           ============================================= */
        .detail-notes-section {
            margin-top: 16px;
        }

        .detail-notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .detail-notes-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .detail-notes-label svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .detail-notes-status {
            font-size: 10px;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-notes-status.visible {
            opacity: 1;
        }

        .detail-notes-status.saved {
            color: var(--success);
        }

        .detail-notes-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 200px;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.5;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .detail-notes-textarea:focus {
            outline: none;
            border-color: var(--brand-start);
        }

        .detail-notes-textarea::placeholder {
            color: var(--text-muted);
        }

        /* =============================================
           DIAGNOSTICS ICON + MODAL
           ============================================= */
        .detail-diag-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .detail-diag-btn:hover {
            background: var(--bg-hover);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .detail-diag-btn svg {
            width: 14px;
            height: 14px;
        }

        .diag-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .diag-modal-overlay.active {
            display: flex;
        }

        .diag-modal {
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .diag-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .diag-modal-header h3 {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diag-modal-header h3 svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .diag-modal-actions {
            display: flex;
            gap: 8px;
        }

        .diag-modal-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .diag-modal-btn.copy {
            background: var(--brand-start);
            border: none;
            color: white;
        }

        .diag-modal-btn.copy:hover {
            background: var(--brand-end);
        }

        .diag-modal-btn.copy.copied {
            background: var(--success);
        }

        .diag-modal-btn.close {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .diag-modal-btn.close:hover {
            background: var(--bg-hover);
        }

        .diag-modal-btn svg {
            width: 12px;
            height: 12px;
        }

        .diag-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .diag-modal-code {
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
        }

        /* =============================================
           NEW ENTRY ANIMATION
           ============================================= */
        @keyframes newEntrySlideIn {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.98);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes newEntryGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.4);
            }
            50% {
                box-shadow: 0 0 20px 4px rgba(20, 184, 166, 0.2);
            }
            100% {
                box-shadow: none;
            }
        }

        .tweet-card.new-entry {
            animation: newEntrySlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                       newEntryGlow 1.5s ease-out;
        }

        .tweet-card.new-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--brand-gradient);
            animation: newEntryBarFade 2s ease-out forwards;
        }

        @keyframes newEntryBarFade {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* New entries indicator */
        .new-entries-indicator {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: var(--brand-gradient);
            border-radius: 20px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            z-index: 150;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 20px rgba(20, 184, 166, 0.4);
            transition: all 0.2s;
        }

        .new-entries-indicator:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .new-entries-indicator.visible {
            display: flex;
            animation: indicatorPulse 0.3s ease-out;
        }

        @keyframes indicatorPulse {
            0% { transform: translateX(-50%) scale(0.9); opacity: 0; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }

        .new-entries-indicator svg {
            width: 14px;
            height: 14px;
        }

        /* =============================================
           INFO DROPDOWN (Mobile-Friendly Stats)
           ============================================= */
        .info-dropdown-container {
            position: relative;
        }

        .info-dropdown-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .info-dropdown-btn:hover,
        .info-dropdown-btn.active {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .info-dropdown-btn svg {
            width: 16px;
            height: 16px;
        }

        .info-dropdown-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            overflow: hidden;
        }

        .info-dropdown-panel.active {
            display: block;
            animation: dropdownSlide 0.2s ease-out;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .info-dropdown-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-dropdown-close {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-dropdown-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .info-dropdown-close svg {
            width: 14px;
            height: 14px;
        }

        .info-dropdown-content {
            padding: 12px 16px;
        }

        .info-dropdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .info-dropdown-row:last-child {
            border-bottom: none;
        }

        .info-dropdown-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .info-dropdown-value {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .info-dropdown-panel {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 16px 16px 0 0;
                max-height: 70vh;
            }

            .info-dropdown-panel.active {
                animation: mobileSlideUp 0.3s ease-out;
            }

            @keyframes mobileSlideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            .detail-main-media-container {
                min-height: 200px;
                max-height: 350px;
            }

            .detail-main-media-container img,
            .detail-main-media-container video {
                max-height: 350px;
            }

            .detail-main-media-nav {
                width: 36px;
                height: 36px;
            }

            .detail-main-media-actions {
                opacity: 1;
            }

            .detail-media-thumb {
                width: 56px;
                height: 42px;
            }
        }

        /* =============================================
           TRANSCRIPT MODAL
           ============================================= */
        .transcript-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 350;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .transcript-modal-overlay.active {
            display: flex;
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .transcript-modal {
            width: 100%;
            max-width: 640px;
            max-height: 80vh;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: modalSlideUp 0.25s ease-out;
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .transcript-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-primary);
        }

        .transcript-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transcript-modal-title svg {
            width: 20px;
            height: 20px;
            color: var(--brand-start);
        }

        .transcript-modal-title h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }

        .transcript-modal-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 30px;
        }

        .transcript-modal-lang {
            padding: 3px 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .transcript-modal-words {
            font-size: 12px;
            color: var(--text-muted);
        }

        .transcript-modal-actions {
            display: flex;
            gap: 8px;
        }

        .transcript-modal-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .transcript-modal-btn.copy {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .transcript-modal-btn.copy:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .transcript-modal-btn.copy.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .transcript-modal-btn.close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 8px;
        }

        .transcript-modal-btn.close:hover {
            color: var(--text-primary);
        }

        .transcript-modal-btn svg {
            width: 14px;
            height: 14px;
        }

        .transcript-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            line-height: 1.8;
            font-size: 15px;
            color: var(--text-primary);
        }

        .transcript-modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .transcript-modal-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .transcript-modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* =============================================
           STATS GEAR BUTTON + MODAL
           ============================================= */
        .stats-gear-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .stats-gear-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-color);
            transform: rotate(15deg);
        }

        .stats-gear-btn svg {
            width: 18px;
            height: 18px;
        }

        .stats-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 250;
            display: none;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 70px 16px 16px;
        }

        .stats-modal-overlay.active {
            display: flex;
        }

        .stats-modal {
            width: 320px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: statsSlideIn 0.2s ease-out;
        }

        @keyframes statsSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .stats-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stats-modal-header h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-modal-header h3 svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .stats-modal-close {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stats-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .stats-modal-close svg {
            width: 16px;
            height: 16px;
        }

        .stats-modal-section {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stats-modal-section:last-child {
            border-bottom: none;
        }

        .stats-modal-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .stats-modal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stats-modal-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stats-modal-item-label {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-modal-item-label svg {
            width: 12px;
            height: 12px;
        }

        .stats-modal-item-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-modal-bar {
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .stats-modal-bar-fill {
            height: 100%;
            background: var(--brand-gradient);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* =============================================
           HEADER BUTTON SYSTEM
           ============================================= */
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
            flex-shrink: 0;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .header-btn:active {
            transform: scale(0.96);
        }

        .header-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Header navigation */
        .header-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Button group */
        .header-btn-group {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 2px;
            gap: 2px;
        }

        .header-btn-group .header-btn {
            border: none;
            background: transparent;
            border-radius: 6px;
        }

        .header-btn-group .header-btn:hover {
            background: var(--bg-hover);
        }

        /* Offline Archive Info Banner */
        .offline-info-banner {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .offline-info-banner svg {
            color: var(--brand-start);
            flex-shrink: 0;
        }

        .offline-meta-sep {
            color: var(--text-muted);
            opacity: 0.5;
        }

        .offline-encrypted {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--success);
        }

        .offline-encrypted svg {
            color: var(--success);
        }

        /* Divider */
        .header-divider {
            width: 1px;
            height: 20px;
            background: var(--border-subtle);
        }

        /* =============================================
           EXPORT BUTTON WITH PROGRESS RING
           ============================================= */
        .export-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
        }

        .export-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .export-btn svg.export-icon {
            width: 18px;
            height: 18px;
        }

        /* Circular progress ring */
        .export-progress-ring {
            position: absolute;
            inset: -3px;
            width: 42px;
            height: 42px;
            transform: rotate(-90deg);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .export-btn.exporting .export-progress-ring {
            opacity: 1;
        }

        .export-progress-ring circle {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
        }

        .export-progress-ring .progress-bg {
            stroke: var(--border-subtle);
        }

        .export-progress-ring .progress-bar {
            stroke: url(#export-progress-gradient);
            stroke-dasharray: 125.6;
            stroke-dashoffset: 125.6;
            transition: stroke-dashoffset 0.3s ease;
        }

        .export-btn.exporting {
            border-color: var(--brand-start);
            color: var(--brand-start);
        }

        .export-btn.exporting:hover {
            background: rgba(20, 184, 166, 0.1);
        }

        /* Indeterminate spinning */
        .export-btn.exporting.indeterminate .export-progress-ring {
            animation: exportSpin 1.5s linear infinite;
        }

        @keyframes exportSpin {
            from { transform: rotate(-90deg); }
            to { transform: rotate(270deg); }
        }

        /* Progress tooltip */
        .export-progress-tooltip {
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--brand-start);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            pointer-events: none;
            z-index: 200;
        }

        .export-progress-tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-bottom-color: var(--border-color);
        }

        .export-btn.exporting:hover .export-progress-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .export-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 250;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .export-modal-overlay.active {
            display: flex;
        }

        .export-modal {
            width: 100%;
            max-width: 440px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: exportSlideIn 0.2s ease-out;
        }

        @keyframes exportSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .export-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .export-modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-modal-header h3 svg {
            width: 20px;
            height: 20px;
            color: var(--brand-start);
        }

        .export-modal-close {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .export-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .export-modal-close svg {
            width: 16px;
            height: 16px;
        }

        .export-modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .export-stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .export-stat-item {
            text-align: center;
            padding: 14px 10px;
            background: var(--bg-elevated);
            border-radius: 10px;
        }

        .export-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .export-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .export-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .export-volume-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
            max-height: 160px;
            overflow-y: auto;
        }

        .export-volume-item {
            padding: 12px 14px;
            background: var(--bg-elevated);
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }

        .export-volume-item:hover {
            background: var(--bg-hover);
        }

        .export-volume-item.selected {
            border-color: var(--brand-start);
            background: rgba(20, 184, 166, 0.08);
        }

        .export-volume-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-volume-name svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .export-volume-space {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            margin-left: 24px;
        }

        .export-path-input {
            margin-bottom: 16px;
        }

        .export-path-input label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .export-path-input input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: monospace;
        }

        .export-path-input input:focus {
            outline: none;
            border-color: var(--brand-start);
        }

        .export-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--bg-elevated);
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .export-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--brand-start);
        }

        .export-checkbox-label {
            flex: 1;
        }

        .export-checkbox-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-checkbox-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .export-options-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .encryption-password-group {
            margin-bottom: 12px;
        }

        .encryption-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .encryption-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .encryption-input:focus {
            outline: none;
            border-color: var(--brand-start);
        }

        .encryption-warning {
            padding: 8px 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
        }

        .export-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .export-btn-secondary {
            padding: 10px 18px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .export-btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .export-btn-primary {
            padding: 10px 20px;
            background: var(--brand-gradient);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }

        .export-btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .export-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .export-btn-primary svg {
            width: 16px;
            height: 16px;
        }

        /* Progress view */
        .export-progress-container {
            margin-bottom: 16px;
        }

        .export-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .export-progress-phase {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-progress-percent {
            font-size: 14px;
            font-weight: 700;
            color: var(--brand-start);
        }

        .export-progress-bar-container {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
        }

        .export-progress-bar {
            height: 100%;
            background: var(--brand-gradient);
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }

        .export-progress-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 16px;
        }

        .export-progress-stat {
            padding: 10px 8px;
            background: var(--bg-elevated);
            border-radius: 8px;
            text-align: center;
        }

        .export-progress-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-progress-stat-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 4px;
        }

        .export-current-file {
            margin-top: 16px;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Completed view */
        .export-completed {
            text-align: center;
            padding: 20px 0;
        }

        .export-completed-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: rgba(0, 186, 124, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .export-completed-icon svg {
            width: 32px;
            height: 32px;
            color: var(--success);
        }

        .export-completed h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .export-completed p {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Error view */
        .export-error {
            text-align: center;
            padding: 20px 0;
        }

        .export-error-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: rgba(244, 33, 46, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .export-error-icon svg {
            width: 32px;
            height: 32px;
            color: var(--danger);
        }

        .export-error h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .export-error p {
            font-size: 13px;
            color: var(--text-muted);
            max-width: 300px;
            margin: 0 auto;
        }

        .export-no-volumes {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* USB Export Mode Selector */
        .export-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--bg-elevated);
            border-radius: 10px;
        }

        .export-mode-tab {
            flex: 1;
            padding: 10px 14px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.15s;
            position: relative;
        }

        .export-mode-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .export-mode-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .export-mode-tab svg {
            width: 18px;
            height: 18px;
        }

        .usb-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--brand-start);
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* USB Drive List */
        .usb-drive-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 16px;
            max-height: 220px;
            overflow-y: auto;
        }

        .usb-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 30px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .usb-no-drives {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .usb-no-drives svg {
            width: 48px;
            height: 48px;
            opacity: 0.4;
            margin-bottom: 12px;
        }

        .usb-no-drives p {
            font-size: 13px;
            margin: 0;
        }

        .usb-unavailable {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }

        .usb-unavailable p {
            margin: 8px 0 0;
        }

        .usb-drive-item {
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .usb-drive-item:hover {
            background: var(--bg-hover);
        }

        .usb-drive-item.selected {
            border-color: var(--brand-start);
            background: rgba(20, 184, 166, 0.08);
        }

        .usb-drive-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .usb-drive-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .usb-drive-icon svg {
            width: 20px;
            height: 20px;
        }

        .usb-drive-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .usb-drive-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .usb-drive-name .usb-mounted-badge {
            font-size: 9px;
            padding: 2px 6px;
            background: rgba(0, 186, 124, 0.15);
            color: var(--success);
            border-radius: 4px;
            font-weight: 600;
        }

        .usb-drive-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .usb-drive-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .usb-drive-action {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .usb-drive-action:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .usb-drive-action.danger {
            color: var(--danger);
        }

        .usb-drive-action.danger:hover {
            background: rgba(244, 33, 46, 0.1);
        }

        /* Format Confirmation Dialog */
        .usb-format-confirm {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 260;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .usb-format-confirm-box {
            width: 100%;
            max-width: 380px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .usb-format-warning {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(244, 33, 46, 0.1);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .usb-format-warning svg {
            width: 24px;
            height: 24px;
            color: var(--danger);
            flex-shrink: 0;
        }

        .usb-format-warning p {
            font-size: 13px;
            color: var(--text-primary);
            margin: 0;
        }

        .usb-format-input {
            margin-bottom: 16px;
        }

        .usb-format-input label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .usb-format-input input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: monospace;
        }

        .usb-format-input input:focus {
            outline: none;
            border-color: var(--brand-start);
        }

        .usb-format-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Toast Notifications */
        .usb-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 400;
            animation: notificationIn 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            max-width: 380px;
        }

        .usb-notification.success {
            border-left: 4px solid var(--success);
        }

        .usb-notification.error {
            border-left: 4px solid var(--danger);
        }

        .usb-notification.info {
            border-left: 4px solid var(--accent-primary);
        }

        @keyframes notificationIn {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Rename Dialog */
        .usb-rename-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 270;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .usb-rename-modal {
            width: 100%;
            max-width: 360px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
            animation: renameModalIn 0.2s ease-out;
        }

        @keyframes renameModalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .usb-rename-modal h4 {
            margin: 0 0 16px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .usb-rename-input {
            margin-bottom: 16px;
        }

        .usb-rename-input label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .usb-rename-input input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .usb-rename-input input:focus {
            outline: none;
            border-color: var(--brand-start);
        }

        .usb-rename-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Format Progress Modal */
        .format-progress-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .format-progress-modal {
            width: 100%;
            max-width: 400px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: formatModalIn 0.3s ease-out;
        }

        @keyframes formatModalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .format-progress-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .format-progress-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .format-progress-body {
            padding: 24px;
        }

        .format-progress-phase {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .format-progress-phase::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--brand-start);
            border-radius: 50%;
            animation: phasePulse 1s infinite;
        }

        @keyframes phasePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .format-progress-bar-container {
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .format-progress-bar {
            height: 100%;
            background: var(--brand-gradient);
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }

        .format-progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Real-time indicator */
        .usb-realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        .usb-realtime-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: realtimePulse 2s infinite;
        }

        @keyframes realtimePulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 186, 124, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(0, 186, 124, 0); }
        }

        .stats-modal-cpu-sparkline {
            width: 100%;
            height: 40px;
            margin-top: 8px;
        }

        /* =============================================
           THEATER TWEET OVERLAY
           ============================================= */
        .theater-tweet-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theater-tweet-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        .theater-tweet-btn svg {
            width: 20px;
            height: 20px;
        }

        .theater-tweet-overlay {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            display: none;
            animation: overlayFadeIn 0.2s ease-out;
        }

        .theater-tweet-overlay.active {
            display: block;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .theater-tweet-overlay-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .theater-tweet-overlay-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .theater-tweet-overlay-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .theater-tweet-overlay-author {
            flex: 1;
            min-width: 0;
        }

        .theater-tweet-overlay-name {
            font-size: 14px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .theater-tweet-overlay-name .verified-badge {
            width: 14px;
            height: 14px;
            color: #1d9bf0;
        }

        .theater-tweet-overlay-handle {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
        }

        .theater-tweet-overlay-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theater-tweet-overlay-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theater-tweet-overlay-close svg {
            width: 16px;
            height: 16px;
        }

        .theater-tweet-overlay-text {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            max-height: 120px;
            overflow-y: auto;
        }

        .theater-tweet-overlay-text::-webkit-scrollbar {
            width: 4px;
        }

        .theater-tweet-overlay-text::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* Transcript button in theater */
        .theater-transcript-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theater-transcript-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .theater-transcript-btn svg {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 768px) {
            .stats-modal-overlay {
                align-items: flex-end;
                justify-content: center;
                padding: 16px;
            }

            .stats-modal {
                width: 100%;
                max-width: 100%;
                border-radius: 16px 16px 0 0;
                animation: mobileSlideUp 0.3s ease-out;
            }

            .transcript-modal {
                max-width: 100%;
                max-height: 90vh;
                border-radius: 16px 16px 0 0;
            }

            .theater-tweet-overlay {
                bottom: 120px;
                width: 95%;
            }
        }

        /* Detail AI Section */
        .detail-ai-type {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px solid var(--border-subtle);
            margin-top: 12px;
        }

        .detail-ai-pending {
            color: var(--text-muted);
            font-style: italic;
            font-size: 13px;
        }

        /* Detail Author Card */
        .detail-author-card {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .detail-author-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-elevated);
            overflow: hidden;
            border: 2px solid rgba(20, 184, 166, 0.2);
            flex-shrink: 0;
        }

        .detail-author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-author-info {
            flex: 1;
            min-width: 0;
        }

        .detail-author-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .detail-author-name .verified-badge {
            width: 16px;
            height: 16px;
            color: var(--accent-primary);
        }

        .detail-author-handle {
            font-size: 13px;
            color: var(--text-muted);
        }

        .detail-author-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .detail-author-stat {
            text-align: center;
            padding: 8px 4px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .detail-stat-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-author-bio {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Detail Technical Grid */
        .detail-tech-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-tech-item {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            align-items: center;
        }

        .detail-tech-type {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
            min-width: 60px;
        }

        .detail-tech-detail {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .detail-tech-empty {
            color: var(--text-muted);
            font-size: 12px;
            padding: 12px;
            text-align: center;
        }

        .detail-tech-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        /* Detail Rows */
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 6px 0;
        }

        .detail-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .detail-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        .detail-value {
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
            word-break: break-all;
        }

        .detail-path {
            font-family: 'SF Mono', 'Menlo', ui-monospace, monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        .detail-status-completed { color: var(--success); }
        .detail-status-processing, .detail-status-downloading { color: var(--accent-primary); }
        .detail-status-failed { color: var(--danger); }

        /* Small button variant */
        .btn-sm {
            padding: 6px 12px !important;
            font-size: 11px !important;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            /* Detail Panel Mobile */
            .detail-panel-overlay {
                padding: 0;
            }

            .detail-panel {
                border-radius: 0;
                min-height: 100vh;
            }

            .detail-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: var(--bg-primary);
            }

            .detail-header-actions {
                flex-wrap: wrap;
                gap: 4px;
            }

            .detail-header-actions .detail-action-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .detail-header-actions .detail-action-btn span {
                display: none;
            }

            .detail-body {
                grid-template-columns: 1fr;
            }

            .detail-content {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .detail-meta {
                padding: 16px;
            }

            .detail-section {
                padding: 12px;
            }

            .detail-author-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .detail-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .detail-media-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Stats Bar Mobile */
            .stats-bar {
                padding: 8px 12px;
                gap: 8px;
            }

            .stat-pill {
                padding: 6px 10px;
                font-size: 10px;
            }

            .stat-label {
                display: none;
            }

            /* Mobile Theater - Floating close button always visible */
            .theater-floating-close {
                display: flex;
                position: fixed;
                top: 12px;
                right: 12px;
                z-index: 500;
                width: 44px;
                height: 44px;
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                color: #fff;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .theater-floating-close:active {
                background: rgba(255, 77, 77, 0.5);
                transform: scale(0.95);
            }

            .theater-floating-close svg {
                width: 20px;
                height: 20px;
            }

            /* Hide desktop theater header on mobile - replaced by floating close + bottom bar */
            .theater-header {
                display: none;
            }

            /* Mobile bottom action bar */
            .theater-mobile-actions {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 450;
                padding: 12px 16px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
                background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 70%, transparent 100%);
                justify-content: center;
                gap: 12px;
            }

            .theater-mobile-actions .theater-btn {
                flex: 1;
                max-width: 140px;
                justify-content: center;
                min-height: 44px;
                font-size: 12px;
                padding: 10px 12px;
            }

            .theater-ai-panel {
                position: fixed;
                top: auto;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100% !important;
                min-width: 100% !important;
                max-height: 50vh;
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                margin-right: 0;
                z-index: 460;
                /* Override desktop transition - only animate transform on mobile */
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .theater-ai-panel.active {
                transform: translateY(0);
            }

            .ai-panel-inner {
                width: 100%;
                min-width: 100%;
            }

            .ai-panel-header {
                padding: 16px 20px;
            }

            .ai-panel-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: rgba(255,255,255,0.3);
                border-radius: 2px;
            }

            .theater-nav {
                width: 44px;
                height: 44px;
                opacity: 0.7;
            }

            .theater-nav.prev { left: 8px; }
            .theater-nav.next { right: 8px; }

            .theater-stage {
                padding: 10px;
            }

            .theater-footer {
                bottom: 80px;
                padding: 8px 16px;
            }

            .theater-media-container video,
            .theater-media-container img {
                max-height: calc(100vh - 160px);
                width: auto;
                height: auto;
                object-fit: contain;
                border-radius: 0;
                box-shadow: none;
            }

            .media-theater.ai-panel-open .theater-media-container video,
            .media-theater.ai-panel-open .theater-media-container img {
                max-height: calc(50vh - 80px);
            }
        }

        /* Touch-friendly hit areas */
        @media (pointer: coarse) {
            .theater-nav {
                width: 60px;
                height: 60px;
            }

            .theater-btn {
                min-height: 44px;
            }

            .theater-btn.icon-only {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* More button for tweets */
        .tweet-more-btn {
            background: none;
            border: none;
            color: var(--brand-start);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 0;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .tweet-more-btn:hover {
            color: var(--brand-end);
            text-decoration: underline;
        }

        .tweet-more-btn svg {
            width: 12px;
            height: 12px;
        }

        .tweet-text.expanded {
            -webkit-line-clamp: unset;
            max-height: none;
            display: block;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid var(--brand-start);
        }

        .tweet-more-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        /* Transcript button on video thumbnails */
        .media-thumb .transcript-btn {
            position: absolute;
            bottom: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.75);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.15s;
            z-index: 5;
        }

        .media-thumb:hover .transcript-btn {
            opacity: 1;
        }

        .media-thumb .transcript-btn:hover {
            background: var(--brand-start);
            transform: scale(1.1);
        }

        .media-thumb .transcript-btn svg {
            width: 14px;
            height: 14px;
        }

        .media-thumb .transcript-btn.no-transcript {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .media-thumb:hover .transcript-btn.no-transcript {
            opacity: 0.4;
        }

        .media-thumb .transcript-btn.no-transcript:hover {
            background: rgba(0, 0, 0, 0.75);
            transform: none;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Keyboard shortcuts hint - Subtle */
        .keyboard-hint {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s;
            pointer-events: none;
        }

        .keyboard-hint.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .keyboard-hint kbd {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 1px 4px;
            border-radius: 3px;
            font-family: inherit;
            margin: 0 3px;
            font-size: 10px;
        }

        /* Scroll to top button - Minimal */
        .scroll-top {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(16px);
            transition: all 0.2s;
            pointer-events: none;
        }

        .scroll-top.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .scroll-top:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .scroll-top svg {
            width: 16px;
            height: 16px;
        }

        /* Responsive - Compact Mobile */
        @media (max-width: 768px) {
            .header {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 12px;
            }

            .header h1 {
                flex-shrink: 0;
            }

            .btn-browse-media {
                padding: 6px 12px;
                font-size: 11px;
                flex-shrink: 0;
            }

            .btn-browse-media .btn-text-full {
                display: none;
            }

            .btn-browse-media .btn-text-short {
                display: inline;
            }

            .container {
                padding: 8px;
            }

            .tweet-card {
                padding: 10px 12px;
            }

            .tweet-detail-text {
                font-size: 14px;
            }

            .tweet-detail-metrics {
                gap: 10px;
            }

            .tweet-detail-actions {
                flex-direction: column;
                gap: 8px;
            }

            .tweet-detail-actions .action-group {
                width: 100%;
                justify-content: center;
            }

            .lightbox-nav {
                display: none;
            }

            .tweet-media-preview {
                max-width: 100%;
            }

            .tweet-media-preview.single,
            .tweet-media-preview.double,
            .tweet-media-preview.triple,
            .tweet-media-preview.quad {
                max-width: 100%;
            }

            .tweet-media-preview .video-indicator {
                width: 36px;
                height: 36px;
            }

            .tweet-media-preview .video-indicator svg {
                width: 14px;
                height: 14px;
            }
        }

        /* Very small screens */
        @media (max-width: 400px) {
            .header {
                justify-content: space-between;
            }
        }

        /* Focus states for accessibility */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            <svg viewBox="0 0 128 128" width="28" height="28">
                <defs>
                    <linearGradient id="header-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#14b8a6"/>
                        <stop offset="100%" stop-color="#0891b2"/>
                    </linearGradient>
                </defs>
                <path d="M20 8 L8 8 L8 40" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M108 8 L120 8 L120 40" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M20 120 L8 120 L8 88" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M108 120 L120 120 L120 88" stroke="url(#header-grad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M40 40 L88 88 M88 40 L40 88" stroke="#e7e9ea" stroke-width="12" stroke-linecap="round"/>
            </svg>
            <span style="background: linear-gradient(135deg, #14b8a6, #0891b2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">xgrabba</span>
        </h1>

        <!-- Navigation Actions -->
        <nav class="header-nav">
            <!-- Primary Actions Group -->
            <div class="header-btn-group">
                <!-- Export Button with Progress Ring -->
                <button class="header-btn export-btn" id="exportBtn" onclick="openExportModal()" title="Export Archive">
                    <!-- Progress Ring SVG -->
                    <svg class="export-progress-ring" viewBox="0 0 42 42">
                        <defs>
                            <linearGradient id="export-progress-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#14b8a6"/>
                                <stop offset="100%" stop-color="#0891b2"/>
                            </linearGradient>
                        </defs>
                        <circle class="progress-bg" cx="21" cy="21" r="20"/>
                        <circle class="progress-bar" id="headerExportProgressRing" cx="21" cy="21" r="20"/>
                    </svg>
                    <!-- Export Icon -->
                    <svg class="export-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    <!-- Progress Tooltip -->
                    <span class="export-progress-tooltip" id="exportProgressTooltip">0%</span>
                </button>
            </div>

            <div class="header-divider"></div>

            <!-- Settings -->
            <button class="header-btn" onclick="toggleStatsModal()" title="Settings & Stats">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                </svg>
            </button>

            <!-- Activity Log (Admin) -->
            <a href="/admin/events" class="header-btn" title="Activity Log" style="text-decoration: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
            </a>
        </nav>
    </header>

    <!-- System Stats Bar (hidden - replaced by modal) -->
    <div class="stats-bar" id="statsBar" style="display:none;">
        <!-- CPU Usage with Sparkline -->
        <div class="stat-pill cpu-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M15 9H9v6h6V9zm-2 4h-2v-2h2v2zm8-2V9h-2V7c0-1.1-.9-2-2-2h-2V3h-2v2h-2V3H9v2H7c-1.1 0-2 .9-2 2v2H3v2h2v2H3v2h2v2c0 1.1.9 2 2 2h2v2h2v-2h2v2h2v-2h2c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2zm-4 6H7V7h10v10z"/>
            </svg>
            <span class="stat-label">CPU</span>
            <span class="stat-value" id="statCPU">0%</span>
            <svg id="cpuSparkline" class="cpu-sparkline" viewBox="0 0 80 20" preserveAspectRatio="none">
                <polyline id="cpuSparklineLine" fill="none" stroke="var(--success)" stroke-width="1.5" points="0,20"></polyline>
            </svg>
        </div>
        <!-- Disk Usage -->
        <div class="stat-pill">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M2 20h20v-4H2v4zm2-3h2v2H4v-2zM2 4v4h20V4H2zm4 3H4V5h2v2zm-4 7h20v-4H2v4zm2-3h2v2H4v-2z"/>
            </svg>
            <span class="stat-label">Disk</span>
            <span class="stat-value" id="statDisk">--</span>
            <div class="stat-bar">
                <div class="stat-bar-fill" id="statDiskBar" style="width: 0%"></div>
            </div>
        </div>
        <div class="stat-divider"></div>
        <!-- Archive Stats -->
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
            </svg>
            <span class="stat-label">Tweets</span>
            <span class="stat-value" id="statTweets">--</span>
        </div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
            </svg>
            <span class="stat-label">Videos</span>
            <span class="stat-value" id="statVideos">--</span>
        </div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span class="stat-label">Images</span>
            <span class="stat-value" id="statImages">--</span>
        </div>
        <div class="stat-pill archive-stat">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
            </svg>
            <span class="stat-label">Archive</span>
            <span class="stat-value" id="statArchive">--</span>
        </div>
        <div class="stat-pill backfill-pill" id="backfillPill" style="display: none;" onclick="showBackfillModal()">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
            </svg>
            <span class="stat-label">Truncated</span>
            <span class="stat-value" id="statTruncated">0</span>
        </div>
    </div>

    <div class="container">
        <div class="search-container">
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10.25 3.75a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zm-8.5 6.5a8.5 8.5 0 1 1 15.176 5.262l4.781 4.781-1.414 1.414-4.781-4.781A8.5 8.5 0 0 1 1.75 10.25z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Search by author, text, AI, or transcript..." aria-label="Search tweets">
                <button class="search-clear" id="searchClear" aria-label="Clear search">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="search-results-info" id="searchResultsInfo">
                Showing <strong id="searchResultCount">0</strong> results for "<span id="searchQuery"></span>"
            </div>
        </div>

        <div id="tweetList" class="tweet-list">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="deleteModalTitle">Delete Archive</h2>
                <button class="modal-close" onclick="closeDeleteModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); line-height: 1.6;">Are you sure you want to delete this archived tweet? This will permanently remove all associated media files and cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div class="bookmarks-modal" id="bookmarksModal">
        <div class="bookmarks-modal-content">
            <div class="bookmarks-modal-header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                    Bookmarks Monitor
                </h2>
                <button class="modal-close" onclick="closeBookmarksModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="bookmarks-modal-body">
                <!-- Connection Status -->
                <div class="bookmarks-connection-status" id="bookmarksConnectionStatus">
                    <div class="bookmarks-connection-dot" id="bookmarksConnectionDot"></div>
                    <div class="bookmarks-connection-info">
                        <div class="status" id="bookmarksConnectionLabel">Disconnected</div>
                        <div class="details" id="bookmarksConnectionDetails">Not connected to X</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bookmarks-controls" id="bookmarksControls">
                    <button class="btn btn-secondary" id="bookmarksPauseBtn" onclick="toggleBookmarksPause()">Pause</button>
                    <button class="btn btn-secondary" id="bookmarksCheckNowBtn" onclick="bookmarksCheckNow()">Check Now</button>
                    <button class="btn btn-ghost" id="bookmarksConnectBtn" onclick="openBookmarksConnect(event)">Connect</button>
                    <button class="btn btn-ghost" id="bookmarksDisconnectBtn" onclick="disconnectBookmarks(event)" style="display:none;">Disconnect</button>
                </div>

                <!-- Activity Log -->
                <div class="bookmarks-activity">
                    <div class="bookmarks-activity-header">Activity Log</div>
                    <div id="bookmarksActivityList">
                        <div class="bookmarks-activity-empty">No activity yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backfill Truncated Tweets Modal -->
    <div class="modal-overlay" id="backfillModal" role="dialog" aria-modal="true" aria-labelledby="backfillModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="backfillModalTitle">Backfill Truncated Tweets</h2>
                <button class="modal-close" onclick="closeBackfillModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px;">
                    Found <strong id="backfillCount">0</strong> tweets that may have truncated text. These were likely archived before the GraphQL full-text support was added.
                </p>
                <p style="color: var(--text-muted); font-size: 13px; line-height: 1.5;">
                    Clicking "Start Backfill" will resync these tweets from X to fetch the full text. This may take a few minutes depending on the number of tweets.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBackfillModal()">Cancel</button>
                <button class="btn" id="startBackfillBtn" onclick="startBackfill()" style="background: linear-gradient(135deg, #ffab00 0%, #ff6d00 100%); color: #000;">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                    </svg>
                    Start Backfill
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="export-modal-overlay" id="exportModalOverlay" onclick="if(event.target===this && !exportInProgress)closeExportModal()" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
        <div class="export-modal">
            <div class="export-modal-header">
                <h3 id="exportModalTitle">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    Export Archive
                </h3>
                <button class="export-modal-close" onclick="closeExportModal()" aria-label="Close">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="export-modal-body">
                <!-- USB Drive View -->
                <div id="exportUSBView">
                    <div class="export-stat-grid">
                        <div class="export-stat-item">
                            <div class="export-stat-value" id="exportUSBTweetCount">--</div>
                            <div class="export-stat-label">Tweets</div>
                        </div>
                        <div class="export-stat-item">
                            <div class="export-stat-value" id="exportUSBMediaCount">--</div>
                            <div class="export-stat-label">Media Files</div>
                        </div>
                        <div class="export-stat-item">
                            <div class="export-stat-value" id="exportUSBSize">--</div>
                            <div class="export-stat-label">Est. Size</div>
                        </div>
                    </div>

                    <div class="usb-drive-list" id="usbDriveList">
                        <div class="usb-loading">
                            <div class="spinner" style="width: 24px; height: 24px;"></div>
                            <span>Scanning for USB drives...</span>
                        </div>
                    </div>

                    <!-- Encryption Options -->
                    <div class="export-options-section" id="encryptionOptions" style="display: none;">
                        <div class="export-checkbox">
                            <input type="checkbox" id="encryptExport" onchange="toggleEncryptionFields()">
                            <div class="export-checkbox-label">
                                <div class="export-checkbox-title">Encrypt Archive</div>
                                <div class="export-checkbox-desc">Protect with AES-256 encryption (password required to view)</div>
                            </div>
                        </div>
                        <div id="encryptionFields" style="display: none;">
                            <div class="encryption-password-group">
                                <label class="encryption-label">Password (min 8 characters)</label>
                                <input type="password" id="encryptPassword" class="encryption-input" placeholder="Enter password" autocomplete="new-password">
                            </div>
                            <div class="encryption-password-group">
                                <label class="encryption-label">Confirm Password</label>
                                <input type="password" id="encryptPasswordConfirm" class="encryption-input" placeholder="Confirm password" autocomplete="new-password">
                            </div>
                            <div class="encryption-warning" id="encryptionWarning" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="usb-unavailable" id="usbUnavailable" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48" style="opacity: 0.5;">
                            <path d="M15 7v4h1v2h-3V5h2l-3-4-3 4h2v8H8v-2.07c.7-.37 1.2-1.08 1.2-1.93 0-1.21-.99-2.2-2.2-2.2-1.21 0-2.2.99-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37-1.2 1.1-1.2 1.95a2.2 2.2 0 0 0 4.4 0c0-.85-.49-1.58-1.2-1.95V15h3c1.11 0 2-.89 2-2v-2h1V7h-4z"/>
                        </svg>
                        <p>USB export is not available.</p>
                        <p style="font-size: 12px; opacity: 0.7;">USB Manager service not connected.</p>
                    </div>
                </div>

                <!-- Progress View -->
                <div id="exportProgressView" style="display: none;">
                    <div class="export-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div class="export-progress-header">
                            <span class="export-progress-phase" id="exportPhase">Preparing...</span>
                            <span class="export-progress-percent" id="exportPercent">0%</span>
                        </div>
                        <div class="export-progress-bar-container">
                            <div class="export-progress-bar" id="exportProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="export-progress-stats">
                        <div class="export-progress-stat">
                            <div class="export-progress-stat-label">Tweets</div>
                            <div class="export-progress-stat-value" id="exportedTweets">0 / 0</div>
                        </div>
                        <div class="export-progress-stat">
                            <div class="export-progress-stat-label">Written</div>
                            <div class="export-progress-stat-value" id="exportBytesWritten">0 B</div>
                        </div>
                        <div class="export-progress-stat">
                            <div class="export-progress-stat-label">Speed</div>
                            <div class="export-progress-stat-value" id="exportTransferRate">--</div>
                        </div>
                    </div>

                    <div class="export-current-file" id="exportCurrentFile" style="display: none;">
                        <span id="exportCurrentFileName">--</span>
                    </div>
                </div>

                <!-- Completed View -->
                <div id="exportCompletedView" style="display: none;">
                    <div class="export-completed">
                        <div class="export-completed-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                        </div>
                        <h4>Export Complete</h4>
                        <p id="exportCompletedSummary">Your archive has been copied to the USB drive.</p>
                        <p style="color: var(--text-secondary); margin-top: 12px; font-size: 14px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" style="vertical-align: middle; margin-right: 4px;">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            Drive safely ejected. You can remove it now.
                        </p>
                    </div>
                </div>

                <!-- Error View -->
                <div id="exportErrorView" style="display: none;">
                    <div class="export-error">
                        <div class="export-error-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                        </div>
                        <h4>Export Failed</h4>
                        <p id="exportErrorMessage">An error occurred during export.</p>
                    </div>
                </div>
            </div>
            <div class="export-modal-footer" id="exportModalFooter">
                <button class="export-btn-secondary" id="exportCancelBtn" onclick="closeExportModal()">Cancel</button>
                <button class="export-btn-primary" id="exportStartBtn" onclick="startUSBExport()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15 7v4h1v2h-3V5h2l-3-4-3 4h2v8H8v-2.07c.7-.37 1.2-1.08 1.2-1.93 0-1.21-.99-2.2-2.2-2.2-1.21 0-2.2.99-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37-1.2 1.1-1.2 1.95a2.2 2.2 0 0 0 4.4 0c0-.85-.49-1.58-1.2-1.95V15h3c1.11 0 2-.89 2-2v-2h1V7h-4z"/>
                    </svg>
                    Export to USB
                </button>
            </div>
        </div>
    </div>

    <!-- Tweet Detail Panel (Redesigned) -->
    <div class="detail-panel-overlay" id="detailPanelOverlay" role="dialog" aria-modal="true" aria-labelledby="detailPanelTitle">
        <!-- Navigation Arrows -->
        <button class="detail-nav prev" id="detailNavPrev" onclick="navigateDetailPanel(-1)" aria-label="Previous tweet">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
        </button>
        <button class="detail-nav next" id="detailNavNext" onclick="navigateDetailPanel(1)" aria-label="Next tweet">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </svg>
        </button>

        <div class="detail-panel" id="detailPanel">
            <div class="detail-header">
                <div class="detail-header-left">
                    <button class="detail-close-btn" onclick="closeDetailPanel()" aria-label="Close">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                    </button>
                    <h2 id="detailPanelTitle">Archive Details</h2>
                    <div class="detail-position" id="detailPosition">
                        <span class="detail-position-count" id="detailPositionCount"></span>
                        <kbd>Arrow keys</kbd>
                    </div>
                </div>
                <div class="detail-header-actions">
                    <a class="detail-action-btn" id="detailViewOriginal" href="#" target="_blank" rel="noopener">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        View on X
                    </a>
                    <button class="detail-action-btn" id="detailRegenAI" onclick="regenerateAI(currentTweetDetail?.tweet_id)">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Regen AI
                    </button>
                    <button class="detail-action-btn" id="detailResync" onclick="resyncTweet(currentTweetDetail?.tweet_id)">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        Resync
                    </button>
                    <button class="detail-action-btn danger" onclick="const id = currentTweetDetail?.tweet_id; closeDetailPanel(); showDeleteModal(id)">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
            <div class="detail-body" id="detailBody">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Legacy Tweet Detail Modal (hidden, for backwards compat) -->
    <div class="modal-overlay" id="tweetDetailModal" role="dialog" aria-modal="true" aria-labelledby="tweetDetailTitle" style="display:none;">
        <div class="modal tweet-detail-modal">
            <div class="modal-header">
                <h2 id="tweetDetailTitle">Tweet</h2>
                <button class="modal-close" onclick="closeTweetDetailModal()" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
            <div class="tweet-detail-content" id="tweetDetailContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox (legacy - kept for compatibility) -->
    <div class="lightbox-overlay" id="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()" aria-label="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                </svg>
            </button>
            <button class="lightbox-nav prev" onclick="navigateLightbox(-1)" aria-label="Previous image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <img id="lightboxImage" src="" alt="Full size image">
            <button class="lightbox-nav next" onclick="navigateLightbox(1)" aria-label="Next image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
            </button>
            <div class="lightbox-counter" id="lightboxCounter"></div>
        </div>
    </div>

    <!-- Premium Media Theater -->
    <div class="media-theater" id="mediaTheater" role="dialog" aria-modal="true" aria-label="Media viewer">
        <div class="theater-backdrop" onclick="closeTheater()"></div>

        <!-- Mobile floating close button - always visible on mobile -->
        <button class="theater-floating-close" onclick="closeTheater()" aria-label="Close media viewer">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
            </svg>
        </button>

        <header class="theater-header">
            <div>
                <div class="theater-title" id="theaterTitle"></div>
                <div class="theater-subtitle" id="theaterSubtitle"></div>
            </div>
            <div class="theater-actions">
                <!-- Media Info button removed - use Archive Details for full info -->
                <a class="theater-btn" id="theaterDownload" href="#" download>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                    </svg>
                    Download
                </a>
                <button class="theater-btn icon-only close-btn" onclick="closeTheater()" aria-label="Close">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main content area with sidebar layout -->
        <div class="theater-main">
            <div class="theater-stage">
                <button class="theater-nav prev" id="theaterNavPrev" onclick="navigateTheater(-1)" aria-label="Previous">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>

                <div class="theater-media-container" id="theaterMediaContainer">
                    <!-- Media (image or video) inserted here dynamically -->
                </div>

                <button class="theater-nav next" id="theaterNavNext" onclick="navigateTheater(1)" aria-label="Next">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </button>

                <footer class="theater-footer">
                    <div class="theater-counter" id="theaterCounter"></div>
                    <label class="autoplay-toggle" title="Auto-advance through all media">
                        <input type="checkbox" id="autoplayCheckbox" onchange="toggleAutoplay()">
                        <span>Autoplay</span>
                    </label>
                </footer>
            </div>

            <!-- Media Info Side Panel (deprecated - hidden) -->
            <aside class="theater-ai-panel" id="theaterAiPanel" style="display:none;">
                <div class="ai-panel-inner">
                    <div class="ai-panel-header">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                            </svg>
                            Media Info
                        </h3>
                        <button class="theater-btn icon-only" onclick="toggleTheaterAI()" aria-label="Close panel">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="ai-panel-content" id="theaterAiContent">
                        <!-- Media info inserted dynamically -->
                    </div>
                </div>
            </aside>
        </div>

        <!-- Mobile action bar - shown only on mobile -->
        <div class="theater-mobile-actions">
            <button class="theater-btn" onclick="toggleTheaterAI()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                </svg>
                Info
            </button>
            <a class="theater-btn" id="theaterDownloadMobile" href="#" download>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                </svg>
                Download
            </a>
            <button class="theater-btn" id="mobilePlayBtn" onclick="toggleMobilePlay()">
                <svg viewBox="0 0 24 24" fill="currentColor" id="mobilePlayIcon">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                Play
            </button>
        </div>
    </div>

    <!-- Scroll to top -->
    <button class="scroll-top" id="scrollTop" aria-label="Scroll to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>

    <!-- Keyboard hint -->
    <div class="keyboard-hint" id="keyboardHint">
        Press <kbd>Esc</kbd> to close, <kbd>/</kbd> to search
    </div>

    <!-- Diagnostics Modal -->
    <div class="diag-modal-overlay" id="diagModalOverlay" onclick="if(event.target===this)closeDiagModal()">
        <div class="diag-modal">
            <div class="diag-modal-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18zm1 13h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
                    Diagnostics
                </h3>
                <div class="diag-modal-actions">
                    <button class="diag-modal-btn copy" id="diagCopyBtn" onclick="copyDiagnosticsModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        Copy
                    </button>
                    <button class="diag-modal-btn close" onclick="closeDiagModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>
                        Close
                    </button>
                </div>
            </div>
            <div class="diag-modal-content">
                <pre class="diag-modal-code" id="diagModalCode">Loading...</pre>
            </div>
        </div>
    </div>

    <!-- New Entries Indicator -->
    <div class="new-entries-indicator" id="newEntriesIndicator" onclick="loadNewEntries()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></svg>
        <span id="newEntriesCount">1 new</span>
    </div>

    <!-- Transcript Modal -->
    <div class="transcript-modal-overlay" id="transcriptModalOverlay" onclick="if(event.target===this)closeTranscriptModal()">
        <div class="transcript-modal">
            <div class="transcript-modal-header">
                <div class="transcript-modal-title">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/></svg>
                    <h3>Transcript</h3>
                </div>
                <div class="transcript-modal-meta">
                    <span class="transcript-modal-lang" id="transcriptModalLang"></span>
                    <span class="transcript-modal-words" id="transcriptModalWords"></span>
                </div>
                <div class="transcript-modal-actions">
                    <button class="transcript-modal-btn copy" id="transcriptCopyBtn" onclick="copyTranscriptFromModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        Copy
                    </button>
                    <button class="transcript-modal-btn close" onclick="closeTranscriptModal()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>
                    </button>
                </div>
            </div>
            <div class="transcript-modal-content" id="transcriptModalContent"></div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="stats-modal-overlay" id="statsModalOverlay" onclick="if(event.target===this)closeStatsModal()">
        <div class="stats-modal">
            <div class="stats-modal-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                    System Stats
                </h3>
                <button class="stats-modal-close" onclick="closeStatsModal()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>
                </button>
            </div>
            <div class="stats-modal-section">
                <div class="stats-modal-section-title">System</div>
                <div class="stats-modal-grid">
                    <div class="stats-modal-item">
                        <div class="stats-modal-item-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 9H9v6h6V9zm-2 4h-2v-2h2v2zm8-2V9h-2V7c0-1.1-.9-2-2-2h-2V3h-2v2h-2V3H9v2H7c-1.1 0-2 .9-2 2v2H3v2h2v2H3v2h2v2c0 1.1.9 2 2 2h2v2h2v-2h2v2h2v-2h2c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2zm-4 6H7V7h10v10z"/></svg>
                            CPU
                        </div>
                        <div class="stats-modal-item-value" id="statsModalCPU">0%</div>
                    </div>
                    <div class="stats-modal-item">
                        <div class="stats-modal-item-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 20h20v-4H2v4zm2-3h2v2H4v-2zM2 4v4h20V4H2zm4 3H4V5h2v2zm-4 7h20v-4H2v4zm2-3h2v2H4v-2z"/></svg>
                            Disk
                        </div>
                        <div class="stats-modal-item-value" id="statsModalDisk">--</div>
                        <div class="stats-modal-bar"><div class="stats-modal-bar-fill" id="statsModalDiskBar"></div></div>
                    </div>
                </div>
            </div>
            <div class="stats-modal-section">
                <div class="stats-modal-section-title">Archive</div>
                <div class="stats-modal-grid">
                    <div class="stats-modal-item">
                        <div class="stats-modal-item-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
                            Tweets
                        </div>
                        <div class="stats-modal-item-value" id="statsModalTweets">--</div>
                    </div>
                    <div class="stats-modal-item">
                        <div class="stats-modal-item-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                            Videos
                        </div>
                        <div class="stats-modal-item-value" id="statsModalVideos">--</div>
                    </div>
                    <div class="stats-modal-item">
                        <div class="stats-modal-item-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            Images
                        </div>
                        <div class="stats-modal-item-value" id="statsModalImages">--</div>
                    </div>
                    <div class="stats-modal-item">
                        <div class="stats-modal-item-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
                            Storage
                        </div>
                        <div class="stats-modal-item-value" id="statsModalStorage">--</div>
                    </div>
                </div>
            </div>

            <div class="stats-modal-section">
                <div class="stats-modal-section-title">Integrations</div>
                <div class="stats-modal-grid">
                    <div class="stats-modal-item" style="grid-column: 1 / -1;">
                        <div class="stats-modal-item-label" style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                            X Bookmarks
                        </div>
                        <div class="stats-modal-item-value" style="display:flex; align-items:center; gap:10px; justify-content:flex-end;">
                            <span class="bookmarks-status disconnected" id="bookmarksStatus">Disconnected</span>
                            <button class="btn btn-secondary" id="bookmarksBtn" onclick="openBookmarksModal()">Open</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Offline mode detection - OFFLINE_DATA is set by exported archives
        // When present, the UI operates without API calls using embedded data
        const OFFLINE_MODE = typeof window.OFFLINE_DATA !== 'undefined';
        let OFFLINE_TWEETS = OFFLINE_MODE ? (window.OFFLINE_DATA.tweets || []) : [];

        // Get API key from URL params first, then localStorage (only needed in online mode)
        const params = new URLSearchParams(window.location.search);
        let API_KEY = OFFLINE_MODE ? '' : (params.get('key') || localStorage.getItem('xgrabba_api_key') || '');

        // Store API key if provided in URL (skip in offline mode)
        if (!OFFLINE_MODE && params.get('key')) {
            localStorage.setItem('xgrabba_api_key', params.get('key'));
            window.history.replaceState({}, '', window.location.pathname);
        }

        // Update events link to include API key for seamless navigation
        if (API_KEY) {
            const eventsLink = document.querySelector('a[href="/admin/events"]');
            if (eventsLink) {
                eventsLink.href = '/admin/events?key=' + encodeURIComponent(API_KEY);
            }
        }

        // State
        let tweets = [];
        let deleteTarget = null;
        let currentTweetDetail = null;
        let lightboxImages = [];
        let lightboxIndex = 0;
        let searchTimeout = null;
        let currentDetailMediaIndex = 0; // For main media viewer navigation
        let lastKnownTweetIds = new Set(); // For detecting new entries
        let newEntriesPollTimer = null;
        let noteSaveTimeout = null; // For debouncing note saves

        // Pagination state for infinite scroll
        let paginationState = {
            offset: 0,
            limit: 50,
            total: 0,
            hasMore: true,
            isLoading: false,
            searchQuery: ''
        };

        // Video handoff state for seamless playback between views
        let videoHandoff = {
            tweetId: null,
            mediaIndex: null,
            currentTime: 0,
            wasPlaying: false,
            mediaId: null
        };

        // DOM Elements
        const tweetList = document.getElementById('tweetList');
        const searchInput = document.getElementById('searchInput');
        const searchClear = document.getElementById('searchClear');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const searchResultCount = document.getElementById('searchResultCount');
        const searchQuerySpan = document.getElementById('searchQuery');
        const scrollTopBtn = document.getElementById('scrollTop');
        const keyboardHint = document.getElementById('keyboardHint');

        // Fetch tweets from API with pagination and optional search
        async function fetchTweetsPage(offset = 0, limit = 50, searchQuery = '') {
            // Offline mode: use embedded data with client-side search
            if (OFFLINE_MODE) {
                return fetchOfflinePage(offset, limit, searchQuery);
            }

            try {
                let url;
                if (searchQuery) {
                    url = `/api/v1/tweets/search?q=${encodeURIComponent(searchQuery)}&limit=${limit}&offset=${offset}`;
                } else {
                    url = `/api/v1/tweets?limit=${limit}&offset=${offset}`;
                }

                const response = await fetch(url, {
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.status === 401) {
                    const key = prompt('Enter your xgrabba API key:');
                    if (key) {
                        localStorage.setItem('xgrabba_api_key', key);
                        location.reload();
                    }
                    return null;
                }

                const data = await response.json();
                return {
                    tweets: data.tweets || [],
                    total: data.total || 0,
                    hasMore: data.has_more || false
                };
            } catch (error) {
                console.error('Failed to fetch tweets:', error);
                return null;
            }
        }

        // Offline mode: fetch from embedded data with client-side filtering
        function fetchOfflinePage(offset, limit, searchQuery) {
            let results = OFFLINE_TWEETS;

            // Client-side search
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                results = results.filter(tweet => {
                    if ((tweet.text || '').toLowerCase().includes(query)) return true;
                    if ((tweet.author?.username || '').toLowerCase().includes(query)) return true;
                    if ((tweet.author?.display_name || '').toLowerCase().includes(query)) return true;
                    if ((tweet.ai_title || '').toLowerCase().includes(query)) return true;
                    if ((tweet.ai_summary || '').toLowerCase().includes(query)) return true;
                    if ((tweet.ai_tags || []).some(t => t.toLowerCase().includes(query))) return true;
                    if ((tweet.ai_topics || []).some(t => t.toLowerCase().includes(query))) return true;
                    // Search media transcripts and captions
                    for (const media of (tweet.media || [])) {
                        if ((media.transcript || '').toLowerCase().includes(query)) return true;
                        if ((media.ai_caption || '').toLowerCase().includes(query)) return true;
                        if ((media.ai_tags || []).some(t => t.toLowerCase().includes(query))) return true;
                    }
                    return false;
                });
            }

            const total = results.length;
            const page = results.slice(offset, offset + limit);

            // Convert offline format to API response format
            const convertedTweets = page.map(t => convertOfflineTweetToApiFormat(t));

            return {
                tweets: convertedTweets,
                total: total,
                hasMore: offset + limit < total
            };
        }

        // Convert offline tweet format to match API response format
        function convertOfflineTweetToApiFormat(t) {
            return {
                tweet_id: t.tweet_id,
                url: t.url,
                author: t.author?.username || '',
                author_display_name: t.author?.display_name || '',
                author_avatar: t.author?.avatar_path ? t.author.avatar_path : null,
                author_verified: t.author?.verified || false,
                text: t.text,
                posted_at: t.posted_at,
                archived_at: t.archived_at,
                media: (t.media || []).map(m => ({
                    id: m.id,
                    type: m.type,
                    url: m.local_path || '',
                    thumbnail_url: m.thumbnail_path || (m.type === 'image' ? m.local_path : null),
                    duration: m.duration_seconds || 0,
                    transcript: m.transcript || '',
                    transcript_language: m.transcript_language || '',
                    ai_caption: m.ai_caption || '',
                    ai_tags: m.ai_tags || []
                })),
                metrics: t.metrics || { likes: 0, retweets: 0, replies: 0 },
                ai_title: t.ai_title || '',
                ai_summary: t.ai_summary || '',
                ai_tags: t.ai_tags || [],
                ai_content_type: t.ai_content_type || '',
                ai_topics: t.ai_topics || [],
                status: 'completed',
                archive_path: t.archive_path || ''
            };
        }

        // Legacy function for backwards compatibility
        async function fetchTweetsRaw() {
            const result = await fetchTweetsPage(0, 100, '');
            if (result) {
                tweets = result.tweets;
                paginationState.total = result.total;
                paginationState.hasMore = result.hasMore;
                return true;
            }
            tweetList.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <h3>Connection Error</h3>
                    <p>Failed to load tweets. Make sure the server is running.</p>
                </div>
            `;
            return false;
        }

        // Load tweets with infinite scroll support
        async function loadTweets({ preserveScroll = true, keepSearch = true, reset = false } = {}) {
            const scrollY = preserveScroll ? window.scrollY : 0;
            const query = keepSearch ? (searchInput.value || '').trim() : '';

            // Reset pagination state for fresh load
            if (reset || !keepSearch) {
                paginationState.offset = 0;
                paginationState.searchQuery = query;
            }

            paginationState.isLoading = true;

            const result = await fetchTweetsPage(0, paginationState.limit, query);
            if (!result) {
                paginationState.isLoading = false;
                tweetList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        <h3>Connection Error</h3>
                        <p>Failed to load tweets. Make sure the server is running.</p>
                    </div>
                `;
                return;
            }

            tweets = result.tweets;
            paginationState.total = result.total;
            paginationState.hasMore = result.hasMore;
            paginationState.offset = tweets.length;
            paginationState.isLoading = false;
            paginationState.searchQuery = query;

            renderTweets(tweets, query);
            updateStats();
            updateLoadMoreIndicator();

            if (preserveScroll) {
                window.scrollTo({ top: scrollY });
            }

            // Ensure polling keeps the list UI up to date.
            startAIPolling();
        }

        // Load more tweets (infinite scroll)
        async function loadMoreTweets() {
            if (paginationState.isLoading || !paginationState.hasMore) return;

            paginationState.isLoading = true;
            updateLoadMoreIndicator();

            const result = await fetchTweetsPage(
                paginationState.offset,
                paginationState.limit,
                paginationState.searchQuery
            );

            if (!result) {
                paginationState.isLoading = false;
                updateLoadMoreIndicator();
                return;
            }

            // Append new tweets
            tweets = [...tweets, ...result.tweets];
            paginationState.total = result.total;
            paginationState.hasMore = result.hasMore;
            paginationState.offset = tweets.length;
            paginationState.isLoading = false;

            // Append to DOM instead of replacing
            appendTweets(result.tweets, paginationState.searchQuery);
            updateLoadMoreIndicator();
        }

        // Update loading indicator
        function updateLoadMoreIndicator() {
            let indicator = document.getElementById('loadMoreIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loadMoreIndicator';
                indicator.className = 'load-more-indicator';
                tweetList.parentElement.appendChild(indicator);
            }

            if (paginationState.isLoading) {
                indicator.innerHTML = '<div class="loading-spinner"></div><span>Loading more...</span>';
                indicator.style.display = 'flex';
            } else if (paginationState.hasMore) {
                indicator.innerHTML = '<span class="load-more-hint">Scroll for more</span>';
                indicator.style.display = 'flex';
            } else if (tweets.length > 0) {
                indicator.innerHTML = `<span class="load-more-end">All ${paginationState.total} tweets loaded</span>`;
                indicator.style.display = 'flex';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Backwards compatibility: existing code calls fetchTweets().
        async function fetchTweets() {
            await loadTweets({ preserveScroll: false, keepSearch: false, reset: true });
        }

        // Smart polling for phased processing status
        // Uses batch-status endpoint for efficient polling of multiple tweets
        let statusPollTimer = null;
        const activeTweets = new Map(); // tweetId -> { status, media_downloaded, media_total, ai_in_progress }
        const TERMINAL_STATUSES = ['completed', 'failed'];

        // Phase badge configuration
        const phaseBadges = {
            pending:     { text: 'Pending...', class: 'fetching', spinner: true },
            fetching:    { text: 'Fetching...', class: 'fetching', spinner: true },
            fetched:     { text: 'Fetched', class: 'fetching', spinner: false },
            downloading: { text: 'Downloading', class: 'downloading', spinner: true }, // Will show percentage
            downloaded:  { text: 'Downloaded', class: 'downloading', spinner: false },
            analyzing:   { text: 'Analyzing...', class: 'analyzing', spinner: true },
            completed:   { text: '', class: 'completed', spinner: false }, // Checkmark shows briefly
            failed:      { text: 'Failed', class: 'failed', spinner: false }
        };

        function updateTweetCardStatus(tweetId, state) {
            const card = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
            if (!card) return;
            const dateEl = card.querySelector('.tweet-date');
            if (!dateEl) return;

            // Remove any existing badges
            const existingPhase = dateEl.querySelector('.phase-badge');
            const existingAI = dateEl.querySelector('.ai-progress-badge');
            if (existingPhase) existingPhase.remove();
            if (existingAI) existingAI.remove();

            const status = state.status;
            const config = phaseBadges[status] || phaseBadges.pending;

            // Don't show badge for completed tweets (just fade out)
            if (status === 'completed') {
                // Show brief checkmark then fade out
                const badge = document.createElement('span');
                badge.className = `phase-badge ${config.class}`;
                badge.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                dateEl.insertBefore(badge, dateEl.firstChild);
                setTimeout(() => badge.classList.add('fade-out'), 2000);
                setTimeout(() => badge.remove(), 2300);
                return;
            }

            if (status === 'failed') {
                return; // Failed status shown differently
            }

            // Build badge text
            let text = config.text;
            if (status === 'downloading' && state.media_total > 0) {
                const pct = Math.round((state.media_downloaded / state.media_total) * 100);
                text = `Downloading ${pct}%`;
            }

            const badge = document.createElement('span');
            badge.className = `phase-badge ${config.class}`;
            badge.innerHTML = config.spinner
                ? `<span class="phase-spinner"></span> ${text}`
                : text;
            dateEl.insertBefore(badge, dateEl.firstChild);
        }

        async function pollBatchStatus() {
            // Always re-scan for new active tweets on every poll
            scanForActiveTweets();

            const ids = Array.from(activeTweets.keys());
            if (ids.length === 0) return;

            try {
                const resp = await fetch('/api/v1/tweets/batch-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({ tweet_ids: ids })
                });

                if (!resp.ok) return;
                const data = await resp.json();
                const statuses = data.statuses || {};

                let anyCompleted = false;
                let anyProgressChanged = false;

                for (const [id, state] of Object.entries(statuses)) {
                    const oldState = activeTweets.get(id);
                    const statusChanged = !oldState || oldState.status !== state.status;
                    const progressChanged = oldState && (
                        oldState.media_downloaded !== state.media_downloaded
                    );

                    if (statusChanged || progressChanged) {
                        anyProgressChanged = true;
                        updateTweetCardStatus(id, state);
                    }

                    // Check if tweet completed or failed
                    if (TERMINAL_STATUSES.includes(state.status)) {
                        activeTweets.delete(id);
                        if (state.status === 'completed' && oldState && !TERMINAL_STATUSES.includes(oldState.status)) {
                            anyCompleted = true;
                            // Refresh detail view if open for this tweet
                            if (document.getElementById('tweetDetailModal').classList.contains('active') &&
                                currentTweetDetail && currentTweetDetail.tweet_id === id) {
                                openTweetDetail(id);
                            }
                        }
                    } else {
                        activeTweets.set(id, state);
                    }
                }

                // Refresh card content when phases advance (media appears, AI completes)
                if (anyCompleted) {
                    await loadTweets({ preserveScroll: true, keepSearch: true });
                }
            } catch (e) {
                // Silent fail
            }
        }

        // Scan tweets for any in non-terminal status and add to activeTweets
        function scanForActiveTweets() {
            // Check tweets data for non-completed status
            for (const tweet of tweets) {
                const id = tweet.tweet_id;

                // Skip tweets we don't have IDs for
                if (!id) continue;

                // Add tweets with non-terminal status
                if (tweet.status && !TERMINAL_STATUSES.includes(tweet.status)) {
                    activeTweets.set(id, {
                        status: tweet.status,
                        media_downloaded: 0,
                        media_total: tweet.media_count || 0
                    });
                }
                // Also track tweets with AI in progress
                else if (tweet.ai_in_progress) {
                    activeTweets.set(id, { status: 'analyzing' });
                }
            }

            // Also check DOM for badges that might indicate in-progress state
            const cards = document.querySelectorAll('.tweet-card[data-tweet-id]');
            for (const card of cards) {
                const id = card.getAttribute('data-tweet-id');
                const hasBadge = card.querySelector('.phase-badge:not(.completed)');
                if (hasBadge && !activeTweets.has(id)) {
                    activeTweets.set(id, { status: 'unknown' });
                }
            }
        }

        function startStatusPolling() {
            // Always re-scan for active tweets when called
            scanForActiveTweets();

            // Only start timer once
            if (statusPollTimer) return;

            // Poll every 2 seconds
            statusPollTimer = setInterval(pollBatchStatus, 2000);
            // Initial poll
            pollBatchStatus();
        }

        // Backwards compat alias
        function startAIPolling() {
            startStatusPolling();
        }

        // Legacy function for AI-only status updates
        function updateTweetCardAIStatus(tweetId, inProgress) {
            if (inProgress) {
                activeTweets.set(tweetId, { status: 'analyzing' });
            }
            updateTweetCardStatus(tweetId, { status: inProgress ? 'analyzing' : 'completed' });
        }

        function updateStats() {
            // Stats now shown in the stats bar via fetchSystemStats()
        }

        // System stats fetching
        let statsInterval = null;
        const cpuHistory = []; // Store last 30 CPU readings for sparkline
        const CPU_HISTORY_MAX = 30;

        async function fetchSystemStats() {
            try {
                const response = await fetch('/api/v1/stats', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) return;
                const stats = await response.json();

                // Update CPU with sparkline
                const cpuPct = stats.cpu_usage_percent || 0;
                document.getElementById('statCPU').textContent = `${cpuPct.toFixed(0)}%`;

                // Update CPU history and sparkline
                cpuHistory.push(cpuPct);
                if (cpuHistory.length > CPU_HISTORY_MAX) cpuHistory.shift();
                updateCpuSparkline(cpuPct);

                // Update disk usage
                const diskUsedGB = (stats.disk_used_bytes / (1024 * 1024 * 1024)).toFixed(1);
                const diskTotalGB = (stats.disk_total_bytes / (1024 * 1024 * 1024)).toFixed(1);
                const diskPct = stats.disk_used_pct || 0;
                document.getElementById('statDisk').textContent = `${diskUsedGB}/${diskTotalGB} GB`;
                const diskBar = document.getElementById('statDiskBar');
                diskBar.style.width = `${Math.min(diskPct, 100)}%`;
                // Color code disk usage
                if (diskPct >= 90) {
                    diskBar.style.background = 'var(--danger)';
                } else if (diskPct >= 75) {
                    diskBar.style.background = '#f59e0b';
                } else {
                    diskBar.style.background = 'var(--brand-gradient)';
                }

                // Update archive stats (count and size)
                document.getElementById('statTweets').textContent = stats.tweet_count || 0;
                const videoCount = stats.video_count || 0;
                const videoMB = stats.video_mb || 0;
                document.getElementById('statVideos').textContent = `${videoCount} (${videoMB} MB)`;
                const imageCount = stats.image_count || 0;
                const imageMB = stats.image_mb || 0;
                document.getElementById('statImages').textContent = `${imageCount} (${imageMB} MB)`;
                document.getElementById('statArchive').textContent = `${stats.archive_total_mb || 0} MB`;
            } catch (error) {
                console.error('Failed to fetch system stats:', error);
            }
        }

        function updateCpuSparkline(currentPct) {
            const sparkline = document.getElementById('cpuSparkline');
            const line = document.getElementById('cpuSparklineLine');
            if (!sparkline || !line || cpuHistory.length === 0) return;

            // Generate SVG polyline points
            const width = 80;
            const height = 20;
            const padding = 1;
            const availableWidth = width - padding * 2;
            const availableHeight = height - padding * 2;

            const points = cpuHistory.map((val, idx) => {
                const x = padding + (idx / (CPU_HISTORY_MAX - 1)) * availableWidth;
                const y = height - padding - (val / 100) * availableHeight;
                return `${x.toFixed(1)},${y.toFixed(1)}`;
            }).join(' ');

            line.setAttribute('points', points);

            // Update color based on current CPU
            sparkline.classList.remove('warn', 'critical');
            if (currentPct >= 80) {
                sparkline.classList.add('critical');
            } else if (currentPct >= 50) {
                sparkline.classList.add('warn');
            }
        }

        function startSystemStatsPolling() {
            fetchSystemStats(); // Initial fetch
            if (statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(fetchSystemStats, 30000); // Every 30 seconds
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    return diffMins <= 1 ? 'Just now' : `${diffMins}m ago`;
                }
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            }

            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function formatFullDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape for use in HTML attributes (also escapes quotes)
        function escapeAttr(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Format duration in seconds to MM:SS or H:MM:SS
        function formatDuration(seconds) {
            if (!seconds || seconds <= 0) return '';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) {
                return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function highlightText(text, query) {
            if (!query) return escapeHtml(text);
            const escaped = escapeHtml(text);
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return escaped.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function getInitials(author) {
            if (!author) return '?';
            // Handle both string and object (from /full endpoint)
            const username = typeof author === 'string' ? author : (author.username || author.display_name || '?');
            return username.charAt(0).toUpperCase();
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) {
                return mins + ':' + secs.toString().padStart(2, '0');
            }
            return '0:' + secs.toString().padStart(2, '0');
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(1) + ' GB';
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
            if (bytes >= 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return bytes + ' B';
        }

        // Render status badge for a tweet based on its processing phase
        function renderStatusBadge(tweet) {
            const status = tweet.status;

            // Skip completed tweets - no badge needed
            if (!status || status === 'completed') {
                // But still show AI analyzing if that's in progress
                if (tweet.ai_in_progress) {
                    return `<span class="phase-badge analyzing"><span class="phase-spinner"></span> Analyzing...</span>`;
                }
                return '';
            }

            const badges = {
                pending:     { text: 'Pending...', class: 'fetching', spinner: true },
                fetching:    { text: 'Fetching...', class: 'fetching', spinner: true },
                fetched:     { text: 'Fetched', class: 'fetching', spinner: false },
                downloading: { text: 'Downloading...', class: 'downloading', spinner: true },
                downloaded:  { text: 'Downloaded', class: 'downloading', spinner: false },
                analyzing:   { text: 'Analyzing...', class: 'analyzing', spinner: true },
                failed:      { text: 'Failed', class: 'failed', spinner: false }
            };

            const config = badges[status] || badges.pending;

            if (config.spinner) {
                return `<span class="phase-badge ${config.class}"><span class="phase-spinner"></span> ${config.text}</span>`;
            }
            return `<span class="phase-badge ${config.class}">${config.text}</span>`;
        }

        // Render tweet list
        function renderTweets(tweetsToRender, searchQuery = '') {
            if (tweetsToRender.length === 0) {
                tweetList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3v10.586l3.293-3.293 1.414 1.414L12 16.414l-4.707-4.707 1.414-1.414L12 13.586V3h2z"/>
                            <path d="M5 17v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/>
                        </svg>
                        <h3>${searchQuery ? 'No results found' : 'No archived tweets yet'}</h3>
                        <p>${searchQuery ? `No tweets match "${escapeHtml(searchQuery)}"` : 'Use the browser extension to archive tweets from X.com'}</p>
                    </div>
                `;
                return;
            }

            tweetList.innerHTML = tweetsToRender.map(tweet => {
                const mediaPreview = renderMediaPreview(tweet);
                const displayName = tweet.author_display_name || tweet.author || 'Unknown';

                return `
                    <div class="tweet-card" data-tweet-id="${tweet.tweet_id}" onclick="openTweetDetail('${tweet.tweet_id}')">
                        <div class="tweet-header">
                            <div class="tweet-avatar">
                                ${tweet.author_avatar
                                    ? `<img src="${addApiKey(tweet.author_avatar)}" alt="${escapeHtml(displayName)}" onerror="this.parentElement.innerHTML='${getInitials(tweet.author)}'">`
                                    : getInitials(tweet.author)
                                }
                            </div>
                            <div class="tweet-author">
                                <div class="tweet-author-name">
                                    ${escapeHtml(displayName)}
                                    ${tweet.verified ? `
                                        <svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/>
                                        </svg>
                                    ` : ''}
                                </div>
                                <span class="tweet-author-username">@${escapeHtml(tweet.author || 'unknown')}</span>
                                ${tweet.follower_count ? `<span class="tweet-author-followers">${formatNumber(tweet.follower_count)} followers</span>` : ''}
                            </div>
                            <div class="tweet-date">
                                ${renderStatusBadge(tweet)}
                                ${formatDate(tweet.created_at)}
                            </div>
                        </div>
                        <div class="tweet-text" data-full-text="${escapeAttr(tweet.text || '')}">${highlightText((tweet.text || '').length > 200 ? (tweet.text || '').substring(0, 200) + '...' : (tweet.text || ''), searchQuery)}</div>
                        ${(tweet.text || '').length > 200 ? `<button class="tweet-more-btn" onclick="event.stopPropagation(); toggleTweetExpand(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/></svg>
                            <span>Show more</span>
                        </button>` : ''}
                        ${tweet.ai_tags && tweet.ai_tags.length > 0 ? `
                            <div class="tweet-tags">
                                ${tweet.ai_tags.slice(0, 5).map(tag => `<span class="tweet-tag">${escapeHtml(tag)}</span>`).join('')}
                                ${tweet.ai_tags.length > 5 ? `<span class="tweet-tag-more">+${tweet.ai_tags.length - 5}</span>` : ''}
                            </div>
                        ` : ''}
                        ${mediaPreview}
                        <div class="tweet-footer">
                            <div class="tweet-metrics">
                                ${tweet.like_count !== undefined ? `
                                    <span class="metric likes">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"/>
                                        </svg>
                                        ${formatNumber(tweet.like_count)}
                                    </span>
                                ` : ''}
                                ${tweet.view_count ? `
                                    <span class="metric views">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 4C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                        </svg>
                                        ${formatNumber(tweet.view_count)}
                                    </span>
                                ` : ''}
                                <span class="media-badge">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"/>
                                    </svg>
                                    ${tweet.media_count || 0}
                                </span>
                            </div>
                            <div class="tweet-actions">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); openTweetDetail('${tweet.tweet_id}')">View</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Setup infinite scroll observer after rendering
            setupInfiniteScroll();
        }

        // Append additional tweets to the DOM (for infinite scroll)
        function appendTweets(newTweets, searchQuery = '') {
            if (newTweets.length === 0) return;

            const html = newTweets.map(tweet => {
                const mediaPreview = renderMediaPreview(tweet);
                const displayName = tweet.author_display_name || tweet.author || 'Unknown';

                return `
                    <div class="tweet-card" data-tweet-id="${tweet.tweet_id}" onclick="openTweetDetail('${tweet.tweet_id}')">
                        <div class="tweet-header">
                            <div class="tweet-avatar">
                                ${tweet.author_avatar
                                    ? `<img src="${addApiKey(tweet.author_avatar)}" alt="${escapeHtml(displayName)}" onerror="this.parentElement.innerHTML='${getInitials(tweet.author)}'">`
                                    : getInitials(tweet.author)
                                }
                            </div>
                            <div class="tweet-author">
                                <div class="tweet-author-name">
                                    ${escapeHtml(displayName)}
                                    ${tweet.verified ? `
                                        <svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/>
                                        </svg>
                                    ` : ''}
                                </div>
                                <span class="tweet-author-username">@${escapeHtml(tweet.author || 'unknown')}</span>
                                ${tweet.follower_count ? `<span class="tweet-author-followers">${formatNumber(tweet.follower_count)} followers</span>` : ''}
                            </div>
                            <div class="tweet-date">
                                ${renderStatusBadge(tweet)}
                                ${formatDate(tweet.created_at)}
                            </div>
                        </div>
                        <div class="tweet-text" data-full-text="${escapeAttr(tweet.text || '')}">${highlightText((tweet.text || '').length > 200 ? (tweet.text || '').substring(0, 200) + '...' : (tweet.text || ''), searchQuery)}</div>
                        ${(tweet.text || '').length > 200 ? `<button class="tweet-more-btn" onclick="event.stopPropagation(); toggleTweetExpand(this)">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/></svg>
                            <span>Show more</span>
                        </button>` : ''}
                        ${tweet.ai_tags && tweet.ai_tags.length > 0 ? `
                            <div class="tweet-tags">
                                ${tweet.ai_tags.slice(0, 5).map(tag => `<span class="tweet-tag">${escapeHtml(tag)}</span>`).join('')}
                                ${tweet.ai_tags.length > 5 ? `<span class="tweet-tag-more">+${tweet.ai_tags.length - 5}</span>` : ''}
                            </div>
                        ` : ''}
                        ${mediaPreview}
                        <div class="tweet-footer">
                            <div class="tweet-metrics">
                                ${tweet.like_count !== undefined ? `
                                    <span class="metric likes">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"/>
                                        </svg>
                                        ${formatNumber(tweet.like_count)}
                                    </span>
                                ` : ''}
                                ${tweet.view_count ? `
                                    <span class="metric views">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 4C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                        </svg>
                                        ${formatNumber(tweet.view_count)}
                                    </span>
                                ` : ''}
                                <span class="media-badge">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"/>
                                    </svg>
                                    ${tweet.media_count || 0}
                                </span>
                            </div>
                            <div class="tweet-actions">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); openTweetDetail('${tweet.tweet_id}')">View</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            tweetList.insertAdjacentHTML('beforeend', html);
        }

        // Infinite scroll observer
        let infiniteScrollObserver = null;
        function setupInfiniteScroll() {
            // Cleanup old observer
            if (infiniteScrollObserver) {
                infiniteScrollObserver.disconnect();
            }

            // Create sentinel element if it doesn't exist
            let sentinel = document.getElementById('infiniteScrollSentinel');
            if (!sentinel) {
                sentinel = document.createElement('div');
                sentinel.id = 'infiniteScrollSentinel';
                sentinel.style.height = '1px';
                tweetList.parentElement.appendChild(sentinel);
            }

            // Create observer
            infiniteScrollObserver = new IntersectionObserver((entries) => {
                const entry = entries[0];
                if (entry.isIntersecting && paginationState.hasMore && !paginationState.isLoading) {
                    loadMoreTweets();
                }
            }, {
                rootMargin: '200px' // Start loading 200px before reaching the end
            });

            infiniteScrollObserver.observe(sentinel);
        }

        function renderMediaPreview(tweet) {
            if (!tweet.media || tweet.media.length === 0) return '';

            const mediaCount = tweet.media.length;
            const gridClass = mediaCount === 1 ? 'single' : mediaCount === 2 ? 'double' : mediaCount === 3 ? 'triple' : 'quad';
            const displayMedia = tweet.media.slice(0, 4);

            return `
                <div class="tweet-media-preview ${gridClass}">
                    ${displayMedia.map((media, idx) => {
                        const isVideo = media.type === 'video' || media.type === 'gif';
                        const showMore = idx === 3 && mediaCount > 4;

                        // For videos: prefer thumbnail_url, fallback to generating from video
                        // For images: use url directly
                        let thumbUrl = '';
                        if (isVideo) {
                            // Use thumbnail if available, otherwise we'll generate one
                            thumbUrl = media.thumbnail_url || '';
                        } else {
                            thumbUrl = media.url || '';
                        }

                        // Add API key for our URLs
                        const isOurUrl = thumbUrl.startsWith('/api/');
                        const finalThumbUrl = isOurUrl ? addApiKey(thumbUrl) : thumbUrl;

                        // For videos: get the actual video URL for inline playback
                        const videoUrl = isVideo ? addApiKey(media.url || '') : '';

                        return `
                            <div class="media-thumb ${isVideo ? 'is-video' : ''}"
                                 ${isVideo ? `data-video-src="${videoUrl}" data-tweet-id="${tweet.tweet_id}" data-media-idx="${idx}"` : ''}
                                 onclick="event.stopPropagation(); ${isVideo ? `playInlineVideo(this, '${tweet.tweet_id}', ${idx})` : `openTheater('${tweet.tweet_id}', ${idx})`}"
                                 style="cursor:pointer;">
                                ${finalThumbUrl
                                    ? `<img src="${finalThumbUrl}" alt="${isVideo ? 'Video thumbnail' : 'Tweet media'}" onerror="this.parentElement.classList.add('no-thumb')">`
                                    : isVideo && videoUrl
                                        ? `<video src="${videoUrl}" preload="metadata" muted playsinline onloadeddata="this.currentTime=0.5" style="pointer-events:none;"></video>`
                                        : `<div class="thumb-placeholder"></div>`
                                }
                                ${isVideo ? `
                                    <div class="video-indicator">
                                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    </div>
                                    ${media.duration ? `<div class="video-duration">${formatDuration(media.duration)}</div>` : ''}
                                    ${media.transcript ? `
                                        <button class="transcript-btn" data-transcript="${escapeAttr(media.transcript)}" data-lang="${escapeAttr(media.transcript_language || '')}" onclick="event.stopPropagation(); event.preventDefault(); showTranscriptFromButton(this);" title="View transcript">
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/></svg>
                                        </button>
                                    ` : ''}
                                    <button class="expand-btn" onclick="event.stopPropagation(); openTheater('${tweet.tweet_id}', ${idx})" title="Fullscreen">
                                        <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                                    </button>
                                ` : ''}
                                ${showMore ? `<div class="more-media">+${mediaCount - 4}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Helper to add API key to URLs (offline mode: return URL as-is)
        function addApiKey(url) {
            if (!url) return url;
            // In offline mode, URLs are already relative paths - no API key needed
            if (OFFLINE_MODE) return url;
            if (!API_KEY) return url;
            const separator = url.includes('?') ? '&' : '?';
            return url + separator + 'key=' + encodeURIComponent(API_KEY);
        }

        // Play video inline in the tweet stream
        function playInlineVideo(thumb, tweetId, mediaIdx) {
            // If already playing, toggle play/pause
            if (thumb.classList.contains('playing')) {
                const video = thumb.querySelector('video');
                if (video) {
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                }
                return;
            }

            // Pause any other playing inline videos
            document.querySelectorAll('.media-thumb.playing').forEach(el => {
                if (el !== thumb) {
                    el.classList.remove('playing');
                    const vid = el.querySelector('video');
                    if (vid) {
                        vid.pause();
                        vid.currentTime = 0;
                    }
                }
            });

            const videoUrl = thumb.dataset.videoSrc;
            if (!videoUrl) {
                // Fallback to theater if no video URL
                openTheater(tweetId, mediaIdx);
                return;
            }

            // Create or get the video element
            let video = thumb.querySelector('video');
            if (!video) {
                video = document.createElement('video');
                video.src = videoUrl;
                video.controls = true;
                video.autoplay = true;
                video.playsInline = true;
                video.setAttribute('playsinline', '');
                // Styles now handled by CSS - no inline styles needed
                // This prevents style conflicts and layout recalculations

                thumb.appendChild(video);

                // Handle video end - only attach once when video is created
                video.addEventListener('ended', () => {
                    thumb.classList.remove('playing');
                });
            } else {
                // Video exists, just play it
                video.play();
            }

            // Add playing class after video is in DOM to trigger CSS transition
            thumb.classList.add('playing');
        }

        // Open tweet detail modal
        async function openTweetDetail(tweetId, startMediaIndex = null) {
            // Capture playing video state for seamless handoff
            videoHandoff = { tweetId: null, mediaIndex: null, currentTime: 0, wasPlaying: false, mediaId: null };

            document.querySelectorAll('.media-thumb.playing').forEach(thumb => {
                const vid = thumb.querySelector('video');
                if (vid && !vid.paused) {
                    // Capture the state before pausing
                    const card = thumb.closest('.tweet-card');
                    const thumbTweetId = card?.dataset?.tweetId;
                    const mediaIdx = parseInt(thumb.dataset?.mediaIdx || '0', 10);

                    if (thumbTweetId === tweetId) {
                        videoHandoff = {
                            tweetId: thumbTweetId,
                            mediaIndex: mediaIdx,
                            currentTime: vid.currentTime,
                            wasPlaying: true,
                            mediaId: null
                        };
                    }
                    vid.pause();
                }
                thumb.classList.remove('playing');
            });

            const overlay = document.getElementById('detailPanelOverlay');
            const body = document.getElementById('detailBody');
            const viewOriginalBtn = document.getElementById('detailViewOriginal');

            // Show loading state
            body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/full`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const tweet = await response.json();
                currentTweetDetail = tweet;

                // Update navigation state
                updateDetailNavigation();

                // Update header URL
                if (tweet.url) {
                    viewOriginalBtn.href = tweet.url;
                    viewOriginalBtn.style.display = '';
                } else {
                    viewOriginalBtn.style.display = 'none';
                }

                // Handle author being an object (from /full endpoint) or string
                const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
                const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
                const displayName = authorObj ? (authorObj.display_name || authorObj.username) : (tweet.author_display_name || tweet.author || 'Unknown');
                const authorAvatar = authorObj ? authorObj.avatar_url : tweet.author_avatar;
                const verified = authorObj ? authorObj.verified : tweet.verified;
                const followerCount = authorObj ? authorObj.follower_count : tweet.follower_count;
                const followingCount = authorObj ? authorObj.following_count : tweet.following_count;
                const tweetCount = authorObj ? authorObj.tweet_count : tweet.tweet_count;
                const authorBio = authorObj ? authorObj.description : tweet.author_bio;

                // Build author tooltip if we have metadata
                const hasAuthorMeta = followerCount || followingCount || tweetCount || authorBio;
                const tooltipAvatarUrl = authorAvatar ? addApiKey(authorAvatar) : '';
                const authorTooltip = hasAuthorMeta ? `
                    <div class="author-tooltip">
                        <div class="author-tooltip-header">
                            <div class="author-tooltip-avatar">
                                ${tooltipAvatarUrl
                                    ? `<img src="${tooltipAvatarUrl}" alt="${escapeHtml(displayName)}">`
                                    : `<span style="display:flex;align-items:center;justify-content:center;height:100%;font-size:16px;font-weight:600;color:var(--text-muted);">${getInitials(authorUsername)}</span>`
                                }
                            </div>
                            <div class="author-tooltip-names">
                                <div class="author-tooltip-displayname">
                                    ${escapeHtml(displayName)}
                                    ${verified ? `<svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;"><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/></svg>` : ''}
                                </div>
                                <div class="author-tooltip-username">@${escapeHtml(authorUsername)}</div>
                            </div>
                        </div>
                        ${authorBio ? `<div class="author-tooltip-bio">${escapeHtml(authorBio)}</div>` : ''}
                        <div class="author-tooltip-stats">
                            ${followerCount !== undefined ? `
                                <div class="author-tooltip-stat">
                                    <span class="author-tooltip-stat-value">${formatNumber(followerCount)}</span>
                                    <span class="author-tooltip-stat-label">Followers</span>
                                </div>
                            ` : ''}
                            ${followingCount !== undefined ? `
                                <div class="author-tooltip-stat">
                                    <span class="author-tooltip-stat-value">${formatNumber(followingCount)}</span>
                                    <span class="author-tooltip-stat-label">Following</span>
                                </div>
                            ` : ''}
                            ${tweetCount !== undefined ? `
                                <div class="author-tooltip-stat">
                                    <span class="author-tooltip-stat-value">${formatNumber(tweetCount)}</span>
                                    <span class="author-tooltip-stat-label">Posts</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : '';

                // Build avatar URL with API key
                const avatarWithKey = authorAvatar ? addApiKey(authorAvatar) : '';

                // Calculate total storage size
                const totalSize = tweet.media?.reduce((sum, m) => sum + (m.size || 0), 0) || 0;

                // Build transcript HTML - find first video with transcript
                const videoWithTranscript = tweet.media?.find(m =>
                    (m.type === 'video' || m.content_type?.startsWith('video/')) && m.transcript && m.transcript.trim().length > 0
                );
                const hasTranscript = !!videoWithTranscript;
                const transcriptText = videoWithTranscript?.transcript || '';
                const transcriptLang = videoWithTranscript?.transcript_language || '';
                const transcriptWordCount = transcriptText ? transcriptText.trim().split(/\s+/).length : 0;

                // Check if there are videos (to show "no transcript yet" state)
                const hasVideos = tweet.media?.some(m => m.type === 'video' || m.content_type?.startsWith('video/'));

                // Format posted date
                const postedDate = tweet.posted_at ? new Date(tweet.posted_at) : null;
                const formattedDate = postedDate ? postedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';

                body.innerHTML = `
                    <!-- Left Column: Content -->
                    <div class="detail-content">
                        <!-- X-Style Tweet Card -->
                        <div class="detail-tweet-card">
                            <div class="detail-tweet-avatar">
                                ${avatarWithKey
                                    ? `<img src="${avatarWithKey}" alt="${escapeHtml(displayName)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="detail-tweet-avatar-placeholder" style="display:none;">${getInitials(authorUsername)}</div>`
                                    : `<div class="detail-tweet-avatar-placeholder">${getInitials(authorUsername)}</div>`
                                }
                            </div>
                            <div class="detail-tweet-main">
                                <div class="detail-tweet-header">
                                    <span class="detail-tweet-name">
                                        ${escapeHtml(displayName)}
                                        ${verified ? `<svg class="verified-badge" viewBox="0 0 24 24" fill="currentColor"><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.34 2.19c-1.39-.46-2.9-.2-3.91.81s-1.27 2.52-.81 3.91C2.63 9.33 1.75 10.57 1.75 12s.88 2.67 2.19 3.34c-.46 1.39-.2 2.9.81 3.91s2.52 1.27 3.91.81c.66 1.31 1.91 2.19 3.34 2.19s2.67-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.04 4.3l-3.54-3.54 1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41-5.64 5.66z"/></svg>` : ''}
                                    </span>
                                    <span class="detail-tweet-handle">@${escapeHtml(authorUsername)}</span>
                                    ${formattedDate ? `<span class="detail-tweet-date">${formattedDate}</span>` : ''}
                                </div>
                                <div class="detail-tweet-body">${escapeHtml(tweet.text || '')}</div>
                                ${tweet.metrics && (tweet.metrics.likes || tweet.metrics.views || tweet.metrics.retweets || tweet.metrics.replies) ? `
                                    <div class="detail-tweet-stats">
                                        ${tweet.metrics.views ? `<div class="detail-tweet-stat"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg><span class="detail-tweet-stat-value">${formatNumber(tweet.metrics.views)}</span></div>` : ''}
                                        ${tweet.metrics.likes ? `<div class="detail-tweet-stat"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span class="detail-tweet-stat-value">${formatNumber(tweet.metrics.likes)}</span></div>` : ''}
                                        ${tweet.metrics.retweets ? `<div class="detail-tweet-stat"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg><span class="detail-tweet-stat-value">${formatNumber(tweet.metrics.retweets)}</span></div>` : ''}
                                        ${tweet.metrics.replies ? `<div class="detail-tweet-stat"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/></svg><span class="detail-tweet-stat-value">${formatNumber(tweet.metrics.replies)}</span></div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Main Media Viewer -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                                Media
                                <span class="detail-section-badge">${tweet.media?.length || 0}</span>
                                <button class="detail-diag-btn" onclick="openDiagModal('${tweet.tweet_id}')" title="View Diagnostics" style="margin-left: auto;">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18zm1 13h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
                                </button>
                            </div>
                            ${renderMainMediaViewer(tweet, 0)}
                        </div>

                        <!-- Transcript Section -->
                        ${hasTranscript ? `
                            <div class="detail-section detail-transcript-section">
                                <div class="detail-section-header" style="cursor:pointer;" onclick="toggleInlineTranscript(this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/></svg>
                                    Transcript
                                    <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                                        ${transcriptLang ? `<span class="detail-transcript-lang">${escapeHtml(transcriptLang)}</span>` : ''}
                                        <span style="font-size:10px; color:var(--text-muted); font-weight:normal; text-transform:none; letter-spacing:0;">${transcriptWordCount} words</span>
                                        <svg class="transcript-expand-icon" viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;color:var(--text-muted);transition:transform 0.2s;"><path d="M7 10l5 5 5-5z"/></svg>
                                    </div>
                                </div>
                                <div class="detail-transcript-content" style="max-height:120px; overflow:hidden; mask-image:linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image:linear-gradient(to bottom, black 60%, transparent 100%); transition: max-height 0.3s ease;">${escapeHtml(transcriptText)}</div>
                                <div class="transcript-toggle-hint" style="text-align:center; padding:8px 0; font-size:12px; color:var(--brand-start); cursor:pointer;" onclick="toggleInlineTranscript(this.parentElement)">Show full transcript</div>
                            </div>
                        ` : ''}

                        <!-- Notes Section -->
                        <div class="detail-section detail-notes-section">
                            <div class="detail-notes-header">
                                <div class="detail-notes-label">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    Notes
                                </div>
                                <span class="detail-notes-status"></span>
                            </div>
                            <textarea class="detail-notes-textarea" placeholder="Add your notes here..." oninput="handleNoteChange('${tweet.tweet_id}', this)">${escapeHtml(loadNote(tweet.tweet_id))}</textarea>
                        </div>
                    </div>

                    <!-- Right Column: Metadata -->
                    <div class="detail-meta">
                        <!-- Insights (Summary & Tags) -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
                                Insights
                            </div>
                            ${tweet.ai_summary ? `
                                <div class="detail-insights-summary">${escapeHtml(tweet.ai_summary)}</div>
                            ` : ''}
                            ${tweet.ai_content_type ? `
                                <span class="detail-insights-type">${escapeHtml(tweet.ai_content_type)}</span>
                            ` : ''}
                            ${tweet.ai_tags && tweet.ai_tags.length > 0 ? `
                                <div class="detail-tags">
                                    ${tweet.ai_tags.map(tag => `<span class="detail-tag">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                            ${!tweet.ai_summary && (!tweet.ai_tags || tweet.ai_tags.length === 0) ? `
                                <div class="detail-ai-pending">Analysis pending...</div>
                            ` : ''}
                        </div>

                        <!-- Technical Details -->
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                Technical
                            </div>
                            <div class="detail-tech-grid">
                                ${tweet.media && tweet.media.length > 0 ? tweet.media.map((m, i) => `
                                    <div class="detail-tech-item">
                                        <span class="detail-tech-type">${m.type === 'video' ? 'Video' : 'Image'} ${tweet.media.length > 1 ? (i + 1) : ''}</span>
                                        ${m.width && m.height ? `<span class="detail-tech-detail">${m.width} x ${m.height}</span>` : ''}
                                        ${m.duration_seconds ? `<span class="detail-tech-detail">${formatDuration(m.duration_seconds)}</span>` : ''}
                                        ${m.size ? `<span class="detail-tech-detail">${formatFileSize(m.size)}</span>` : ''}
                                    </div>
                                `).join('') : '<div class="detail-tech-empty">No media files</div>'}
                            </div>
                            <div class="detail-tech-summary">
                                <div class="detail-row"><span class="detail-label">Total Size</span><span class="detail-value">${formatFileSize(totalSize)}</span></div>
                                <div class="detail-row"><span class="detail-label">Media Count</span><span class="detail-value">${tweet.media?.length || 0} files</span></div>
                            </div>
                        </div>

                        <!-- Archive Info -->
                        <div class="detail-section" style="border-bottom: none;">
                            <div class="detail-section-header">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.586l3.293-3.293 1.414 1.414L12 16.414l-4.707-4.707 1.414-1.414L12 13.586V3h2z"/><path d="M5 17v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/></svg>
                                Archive
                            </div>
                            <div class="detail-archive-info">
                                <div class="detail-row"><span class="detail-label">Posted</span><span class="detail-value">${formatFullDate(tweet.posted_at)}</span></div>
                                <div class="detail-row"><span class="detail-label">Archived</span><span class="detail-value">${formatFullDate(tweet.archived_at || tweet.created_at)}</span></div>
                                <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value detail-status-${tweet.status || 'completed'}">${tweet.status || 'Completed'}</span></div>
                                ${tweet.archive_path ? `<div class="detail-row"><span class="detail-label">Path</span><span class="detail-value detail-path">${escapeHtml(tweet.archive_path)}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Check AI analysis status and update button
                updateRegenerateButtonState(tweet.tweet_id);

                // Seamless video handoff - restore playback position if coming from main view
                if (videoHandoff.wasPlaying && videoHandoff.tweetId === tweet.tweet_id) {
                    // Select the correct media index if we have it
                    if (videoHandoff.mediaIndex !== null && videoHandoff.mediaIndex !== currentDetailMediaIndex) {
                        selectDetailMedia(videoHandoff.mediaIndex);
                    }

                    // Find the video in the detail view and restore playback
                    setTimeout(() => {
                        const detailVideo = document.querySelector('.detail-main-media-container video');
                        if (detailVideo) {
                            detailVideo.currentTime = videoHandoff.currentTime;
                            detailVideo.play().catch(() => {}); // Autoplay may be blocked
                        }
                    }, 100);
                } else if (startMediaIndex !== null) {
                    // Open to specific media index if requested
                    selectDetailMedia(startMediaIndex);
                }

            } catch (error) {
                console.error('Failed to fetch tweet details:', error);
                body.innerHTML = `
                    <div class="empty-state" style="padding: 48px;">
                        <p>Failed to load tweet details.</p>
                    </div>
                `;
            }
        }

        function closeDetailPanel() {
            const overlay = document.getElementById('detailPanelOverlay');

            // Capture video state for seamless handoff back to main view
            const detailVideo = overlay.querySelector('.detail-main-media-container video');
            const wasPlaying = detailVideo && !detailVideo.paused;
            const currentTime = detailVideo ? detailVideo.currentTime : 0;
            const tweetId = currentTweetDetail?.tweet_id;

            // Pause all videos before closing
            const videos = overlay.querySelectorAll('video');
            videos.forEach(video => {
                video.pause();
            });

            overlay.classList.remove('active');
            document.body.style.overflow = '';

            // Restore playback to main page video if it was playing
            if (wasPlaying && tweetId) {
                setTimeout(() => {
                    const mainThumb = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"] .media-thumb[data-media-idx="${currentDetailMediaIndex}"]`);
                    if (mainThumb) {
                        const mainVideo = mainThumb.querySelector('video');
                        if (mainVideo) {
                            mainVideo.currentTime = currentTime;
                            mainVideo.play().then(() => {
                                mainThumb.classList.add('playing');
                            }).catch(() => {});
                        }
                    }
                }, 100);
            }

            currentTweetDetail = null;
        }

        // Toggle transcript panel visibility
        function toggleDetailTranscript(btn) {
            const panel = btn.nextElementSibling;
            if (!panel) return;

            const isVisible = panel.classList.contains('visible');
            if (isVisible) {
                panel.classList.remove('visible');
                btn.classList.remove('active');
                btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/></svg> View Transcript`;
            } else {
                panel.classList.add('visible');
                btn.classList.add('active');
                btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/></svg> Hide Transcript`;
            }
        }

        // Copy transcript to clipboard without prompt fallback
        function copyTranscriptSimple(btn, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1500);
            }).catch(() => {
                // Silent fail - just show error state briefly
                btn.textContent = 'Error';
                setTimeout(() => {
                    btn.textContent = 'Copy';
                }, 1500);
            });
        }

        // Get current tweet index in the tweets array
        function getCurrentTweetIndex() {
            if (!currentTweetDetail) return -1;
            return tweets.findIndex(t => t.tweet_id === currentTweetDetail.tweet_id);
        }

        // Update navigation UI state
        function updateDetailNavigation() {
            const currentIndex = getCurrentTweetIndex();
            const total = tweets.length;
            const prevBtn = document.getElementById('detailNavPrev');
            const nextBtn = document.getElementById('detailNavNext');
            const positionEl = document.getElementById('detailPositionCount');

            if (currentIndex === -1 || total === 0) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                positionEl.textContent = '';
                return;
            }

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === total - 1;
            positionEl.textContent = `${currentIndex + 1} of ${total}`;
        }

        // Navigate between tweets in detail panel
        function navigateDetailPanel(direction) {
            const currentIndex = getCurrentTweetIndex();
            if (currentIndex === -1) return;

            const newIndex = currentIndex + direction;
            if (newIndex < 0 || newIndex >= tweets.length) return;

            const newTweet = tweets[newIndex];
            if (newTweet && newTweet.tweet_id) {
                openTweetDetail(newTweet.tweet_id);
            }
        }

        // Keyboard navigation for detail panel
        document.addEventListener('keydown', function(e) {
            const overlay = document.getElementById('detailPanelOverlay');
            if (!overlay.classList.contains('active')) return;

            // Don't navigate if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateDetailPanel(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigateDetailPanel(1);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeDetailPanel();
            }
        });

        // New helper function for the detail panel media grid
        function renderDetailMediaGrid(tweet) {
            if (!tweet.media || tweet.media.length === 0) {
                return '<div class="detail-media-empty">No media files</div>';
            }

            const tweetId = tweet.tweet_id;

            // Build download filename
            const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
            const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
            const dateStr = tweet.posted_at ? new Date(tweet.posted_at).toISOString().split('T')[0] : 'archived';
            const titleSlug = (tweet.ai_title || tweet.text || '').slice(0, 40).replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+$/, '') || 'media';
            const baseFilename = `${authorUsername}_${dateStr}_${titleSlug}`;

            return tweet.media.map((m, index) => {
                const mediaUrl = addApiKey(m.url);
                const isVideo = m.type === 'video' || m.content_type?.startsWith('video/');

                if (isVideo) {
                    // Videos play inline with controls
                    const downloadName = `${baseFilename}${tweet.media.filter(x => x.type === 'video').length > 1 ? '_' + (index + 1) : ''}.mp4`;
                    return `
                        <div class="detail-media-item video inline-player">
                            <video src="${mediaUrl}" controls preload="metadata" playsinline></video>
                            <div class="detail-video-controls">
                                <button onclick="event.stopPropagation(); openTheater('${tweetId}', ${index})" title="Fullscreen">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                                </button>
                            </div>
                            <a class="detail-video-download" href="${mediaUrl}" download="${escapeHtml(downloadName)}" onclick="event.stopPropagation()" title="Download">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/></svg>
                            </a>
                        </div>
                    `;
                } else {
                    // Images still open theater on click
                    return `
                        <div class="detail-media-item" onclick="openTheater('${tweetId}', ${index})">
                            <img src="${mediaUrl}" alt="Media ${index + 1}" loading="lazy">
                        </div>
                    `;
                }
            }).join('');
        }

        function renderDetailMedia(tweet) {
            if (!tweet.media || tweet.media.length === 0) return '';

            // Media URLs come from the /full endpoint in the format /api/v1/tweets/{id}/media/{filename}
            const images = tweet.media.filter(m => m.type === 'image' || m.content_type?.startsWith('image/'));
            const videos = tweet.media.filter(m => m.type === 'video' || m.content_type?.startsWith('video/'));

            // Build a descriptive base filename from author and tweet content
            const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
            const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
            const dateStr = tweet.posted_at ? new Date(tweet.posted_at).toISOString().split('T')[0] : 'archived';
            const titleSlug = (tweet.ai_title || tweet.text || '').slice(0, 40).replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+$/, '') || 'media';
            const baseFilename = `${authorUsername}_${dateStr}_${titleSlug}`;

            let html = '<div class="tweet-detail-media">';

            // Images
            if (images.length > 0) {
                html += `
                    <h4>
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13z"/>
                        </svg>
                        Images (${images.length})
                    </h4>
                `;

                const gridClass = images.length === 1 ? 'single' : images.length === 2 ? 'double' : images.length === 3 ? 'triple' : 'quad';

                html += `<div class="media-grid ${gridClass}">`;
                images.forEach((img, idx) => {
                    const imgUrl = addApiKey(img.url || '');
                    const ext = (img.filename || img.url || '').split('.').pop() || 'jpg';
                    const downloadName = images.length > 1 ? `${baseFilename}_${idx + 1}.${ext}` : `${baseFilename}.${ext}`;
                    html += `
                        <div class="media-item" onclick="openLightbox(${idx}, 'images')">
                            <img src="${imgUrl}" alt="Tweet image ${idx + 1}" loading="lazy" onerror="this.parentElement.style.display='none'">
                            <a class="media-download-btn" href="${imgUrl}" download="${escapeHtml(downloadName)}" onclick="event.stopPropagation()" title="Download image">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                                </svg>
                            </a>
                            ${(img.ai_caption || (img.ai_tags && img.ai_tags.length)) ? `
                                <div style="position:absolute; left:8px; bottom:8px; right:8px; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.55); color: white;"
                                     onclick="event.stopPropagation()">
                                    ${img.ai_caption ? `<div style="font-size: 12px; line-height: 1.35; max-height: 52px; overflow:hidden;">${escapeHtml(img.ai_caption)}</div>` : ''}
                                    ${(img.ai_tags && img.ai_tags.length) ? `<div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
                                        ${img.ai_tags.slice(0,6).map(t => `<span style="font-size:11px; padding:2px 6px; border-radius:999px; background: rgba(255,255,255,0.18);">${escapeHtml(t)}</span>`).join('')}
                                    </div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Videos
            if (videos.length > 0) {
                html += `
                    <h4 style="margin-top: 16px;">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 6.45V17.55c0 .48-.27.92-.7 1.12-.15.07-.31.1-.47.1-.29 0-.57-.1-.79-.3l-3.56-3.33c-.55-.52-.88-1.25-.88-2.02V10.87c0-.77.33-1.5.88-2.02l3.56-3.33c.35-.33.83-.45 1.26-.35.43.1.79.4.98.82.08.17.12.35.12.53v.53c0-.01 0 0 0 0zM14 18V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2z"/>
                        </svg>
                        Videos (${videos.length})
                    </h4>
                `;

                videos.forEach((video, idx) => {
                    const videoUrl = addApiKey(video.url || '');
                    const downloadName = videos.length > 1 ? `${baseFilename}_video${idx + 1}.mp4` : `${baseFilename}.mp4`;
                    const hasTranscript = !!(video.transcript && video.transcript.length > 0);
                    const transcriptId = `transcript-${tweet.tweet_id}-${idx}`;
                    const transcriptCopyId = `transcript-copy-${tweet.tweet_id}-${idx}`;

                    html += `
                        <div class="media-item video" data-video-idx="${idx}">
                            <video
                                src="${videoUrl}"
                                controls
                                preload="metadata"
                                playsinline
                            ></video>
                            <a class="media-download-btn video-download" href="${videoUrl}" download="${escapeHtml(downloadName)}" onclick="event.stopPropagation()" title="Download video">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/>
                                </svg>
                            </a>
                            ${hasTranscript ? `
                                <button class="media-download-btn" style="right: 40px;" onclick="event.stopPropagation(); openTranscriptModal(${JSON.stringify(video.transcript)}, '${escapeHtml(video.transcript_language || '')}', ${video.transcript.split(/\s+/).length})"
                                    title="View transcript">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;">
                                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/>
                                    </svg>
                                </button>
                            ` : `
                                <button class="media-download-btn" style="right: 40px; opacity: 0.4; cursor: not-allowed;" onclick="event.stopPropagation()"
                                    title="No transcript yet">
                                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;">
                                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/>
                                    </svg>
                                </button>
                            `}

                            ${(video.ai_caption || (video.ai_tags && video.ai_tags.length)) ? `
                                <div style="margin-top: 8px; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--bg-secondary);">
                                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Media AI</div>
                                    ${video.ai_caption ? `<div style="font-size: 12px; white-space: pre-wrap; line-height: 1.4;">${escapeHtml(video.ai_caption)}</div>` : ''}
                                    ${(video.ai_tags && video.ai_tags.length) ? `<div style="margin-top: 8px; display:flex; flex-wrap:wrap; gap:6px;">
                                        ${video.ai_tags.map(t => `<span class="tag-chip">${escapeHtml(t)}</span>`).join('')}
                                    </div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            html += '</div>';
            return html;
        }

        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Lightbox
        function openLightbox(index, type) {
            if (!currentTweetDetail || !currentTweetDetail.media) return;

            const images = currentTweetDetail.media.filter(m => m.type === 'image' || m.content_type?.startsWith('image/'));
            // Use the url field with API key
            lightboxImages = images.map(img => addApiKey(img.url || ''));
            lightboxIndex = index;

            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImage');
            const counter = document.getElementById('lightboxCounter');

            lightboxImg.src = lightboxImages[lightboxIndex];
            counter.textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;

            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            if (!document.getElementById('tweetDetailModal').classList.contains('active')) {
                document.body.style.overflow = '';
            }
        }

        function navigateLightbox(direction) {
            lightboxIndex = (lightboxIndex + direction + lightboxImages.length) % lightboxImages.length;
            document.getElementById('lightboxImage').src = lightboxImages[lightboxIndex];
            document.getElementById('lightboxCounter').textContent = `${lightboxIndex + 1} / ${lightboxImages.length}`;
        }

        // Premium Media Theater
        let theaterMedia = [];
        let theaterIndex = 0;
        let theaterTweet = null;

        // Autoplay mode state
        let autoplayEnabled = localStorage.getItem('xgrabba_autoplay') === 'true';

        function openTheater(tweetId, mediaIndex = 0) {
            // Pause any playing inline videos on the main page
            document.querySelectorAll('.media-thumb.playing').forEach(thumb => {
                thumb.classList.remove('playing');
                const vid = thumb.querySelector('video');
                if (vid) {
                    vid.pause();
                    vid.currentTime = 0;
                }
            });

            const tweet = tweets.find(t => t.tweet_id === tweetId);
            if (!tweet || !tweet.media || tweet.media.length === 0) return;

            theaterTweet = tweet;
            theaterMedia = tweet.media;
            theaterIndex = mediaIndex;

            renderTheaterMedia();
            updateTheaterInfo();

            const theater = document.getElementById('mediaTheater');
            theater.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Force reflow to ensure panel width transition works correctly
            // (The panel was never laid out while theater was display:none)
            void theater.offsetWidth;

            // Auto-open info panel only on desktop (not mobile)
            const isMobile = window.innerWidth <= 768;
            // Sync resize tracker state when theater opens
            lastWasMobile = isMobile;
            if (!isMobile) {
                document.getElementById('theaterAiPanel').classList.add('active');
                theater.classList.add('ai-panel-open');
            } else {
                // Ensure AI panel is closed on mobile
                document.getElementById('theaterAiPanel').classList.remove('active');
                theater.classList.remove('ai-panel-open');
            }

            // Initialize autoplay checkbox
            document.getElementById('autoplayCheckbox').checked = autoplayEnabled;

            // Show controls briefly then hide (desktop only)
            if (!isMobile) {
                theater.classList.add('controls-visible');
                setTimeout(() => theater.classList.remove('controls-visible'), 2000);
            }

            // Hide nav arrows if only one media item
            updateTheaterNavVisibility();
        }

        function closeTheater() {
            const theater = document.getElementById('mediaTheater');
            const container = document.getElementById('theaterMediaContainer');

            // Clear autoplay timer
            if (autoplayTimer) {
                clearTimeout(autoplayTimer);
                autoplayTimer = null;
            }

            // Pause any playing video
            const video = container.querySelector('video');
            if (video) {
                video.pause();
                video.currentTime = 0;
            }

            theater.classList.remove('active');
            theater.classList.remove('ai-panel-open');
            document.getElementById('theaterAiPanel').classList.remove('active');
            document.body.style.overflow = '';
            theaterTweet = null;
            theaterMedia = [];
        }

        // Show/hide navigation arrows based on media count
        function updateTheaterNavVisibility() {
            const prevBtn = document.getElementById('theaterNavPrev');
            const nextBtn = document.getElementById('theaterNavNext');
            const mediaCount = galleryMode ? allGalleryMedia.length : theaterMedia.length;
            const showNav = mediaCount > 1;

            if (prevBtn) prevBtn.style.display = showNav ? '' : 'none';
            if (nextBtn) nextBtn.style.display = showNav ? '' : 'none';
        }

        // Track last known viewport state to detect breakpoint crossing
        let lastWasMobile = window.innerWidth <= 768;

        // Handle viewport resize to sync panel state across mobile/desktop breakpoints
        function handleTheaterResize() {
            const theater = document.getElementById('mediaTheater');
            if (!theater || !theater.classList.contains('active')) return;

            const isMobile = window.innerWidth <= 768;
            const panel = document.getElementById('theaterAiPanel');
            const panelIsActive = panel && panel.classList.contains('active');

            // Only act when crossing the 768px breakpoint
            if (isMobile !== lastWasMobile) {
                if (isMobile && panelIsActive) {
                    // Crossing from desktop to mobile with panel open - close it
                    // (mobile users should manually open via bottom bar)
                    panel.classList.remove('active');
                    theater.classList.remove('ai-panel-open');
                }
                // When crossing from mobile to desktop, leave panel state as-is
                // (user preference should persist)
                lastWasMobile = isMobile;
            }
        }

        // Debounced resize handler to avoid excessive calls
        let resizeTimeout = null;
        window.addEventListener('resize', function() {
            if (resizeTimeout) clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleTheaterResize, 100);
        });

        function navigateTheater(direction) {
            if (theaterMedia.length <= 1) return;

            // Pause current video if any
            const container = document.getElementById('theaterMediaContainer');
            const video = container.querySelector('video');
            if (video) video.pause();

            theaterIndex = (theaterIndex + direction + theaterMedia.length) % theaterMedia.length;
            renderTheaterMedia();
            updateTheaterInfo();
        }

        let autoplayTimer = null;

        function renderTheaterMedia() {
            const container = document.getElementById('theaterMediaContainer');
            const media = theaterMedia[theaterIndex];
            const mediaUrl = addApiKey(media.url || '');
            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');
            const isMobile = window.innerWidth <= 768;

            // Clear any pending autoplay timer
            if (autoplayTimer) {
                clearTimeout(autoplayTimer);
                autoplayTimer = null;
            }

            if (isVideo) {
                // On mobile, don't autoplay - let user tap play button
                // On desktop, autoplay as before
                const autoplayAttr = isMobile ? '' : 'autoplay';
                container.innerHTML = `
                    <video
                        src="${mediaUrl}"
                        controls
                        ${autoplayAttr}
                        playsinline
                        webkit-playsinline
                        style="outline: none;"
                    ></video>
                `;
                const video = container.querySelector('video');

                // Add ended event for autoplay
                video.addEventListener('ended', handleMediaEnded);

                // Update mobile play button state when video plays/pauses
                video.addEventListener('play', () => {
                    const playBtn = document.getElementById('mobilePlayBtn');
                    if (playBtn) playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> Pause';
                });
                video.addEventListener('pause', () => {
                    const playBtn = document.getElementById('mobilePlayBtn');
                    if (playBtn) playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Play';
                });

                // On mobile, add a tap-to-play overlay hint
                if (isMobile) {
                    // Reset play button to Play state
                    const playBtn = document.getElementById('mobilePlayBtn');
                    if (playBtn) playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Play';
                }
            } else {
                container.innerHTML = `<img src="${mediaUrl}" alt="Media">`;
                // For images in autoplay mode, advance after 5 seconds
                if (autoplayEnabled) {
                    autoplayTimer = setTimeout(handleMediaEnded, 5000);
                }
            }

            // Update counter
            document.getElementById('theaterCounter').textContent =
                theaterMedia.length > 1 ? `${theaterIndex + 1} / ${theaterMedia.length}` : '';

            // Update download link
            updateTheaterDownload();
        }

        function handleMediaEnded() {
            if (!autoplayEnabled) return;

            // Move to next media in current tweet
            if (theaterIndex < theaterMedia.length - 1) {
                navigateTheater(1);
            } else {
                // Move to next tweet with media
                const currentIdx = tweets.findIndex(t => t.tweet_id === theaterTweet.tweet_id);
                for (let i = currentIdx + 1; i < tweets.length; i++) {
                    if (tweets[i].media && tweets[i].media.length > 0) {
                        openTheater(tweets[i].tweet_id, 0);
                        return;
                    }
                }
                // Wrap to first tweet with media
                for (let i = 0; i < currentIdx; i++) {
                    if (tweets[i].media && tweets[i].media.length > 0) {
                        openTheater(tweets[i].tweet_id, 0);
                        return;
                    }
                }
            }
        }

        function toggleAutoplay() {
            autoplayEnabled = !autoplayEnabled;
            localStorage.setItem('xgrabba_autoplay', autoplayEnabled);
            document.getElementById('autoplayCheckbox').checked = autoplayEnabled;
        }

        function updateTheaterInfo() {
            if (!theaterTweet) return;

            const authorObj = typeof theaterTweet.author === 'object' ? theaterTweet.author : null;
            const authorName = authorObj ? (authorObj.name || authorObj.username) : (theaterTweet.author || 'Unknown');
            const authorUsername = authorObj ? authorObj.username : (theaterTweet.author || 'unknown');

            document.getElementById('theaterTitle').textContent = theaterTweet.ai_title || theaterTweet.text?.slice(0, 80) || 'Media';
            document.getElementById('theaterSubtitle').textContent = `@${authorUsername}`;

            // Update AI panel content
            updateTheaterAiContent();
        }

        function updateTheaterDownload() {
            const downloadBtn = document.getElementById('theaterDownload');
            const downloadBtnMobile = document.getElementById('theaterDownloadMobile');
            const media = theaterMedia[theaterIndex];
            const mediaUrl = addApiKey(media.url || '');

            // Build smart filename
            const authorObj = typeof theaterTweet.author === 'object' ? theaterTweet.author : null;
            const authorUsername = authorObj ? authorObj.username : (theaterTweet.author || 'unknown');
            const dateStr = theaterTweet.posted_at ? new Date(theaterTweet.posted_at).toISOString().split('T')[0] : 'archived';
            const titleSlug = (theaterTweet.ai_title || theaterTweet.text || '').slice(0, 40).replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+$/, '') || 'media';

            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');
            const ext = isVideo ? 'mp4' : ((media.filename || media.url || '').split('.').pop() || 'jpg');
            const indexSuffix = theaterMedia.length > 1 ? `_${theaterIndex + 1}` : '';

            const filename = `${authorUsername}_${dateStr}_${titleSlug}${indexSuffix}.${ext}`;

            downloadBtn.href = mediaUrl;
            downloadBtn.download = filename;

            // Also update mobile download button
            if (downloadBtnMobile) {
                downloadBtnMobile.href = mediaUrl;
                downloadBtnMobile.download = filename;
            }

            // Update mobile play button visibility
            updateMobilePlayButton();
        }

        function toggleTheaterAI() {
            const panel = document.getElementById('theaterAiPanel');
            const theater = document.getElementById('mediaTheater');
            panel.classList.toggle('active');
            theater.classList.toggle('ai-panel-open');
        }

        // Mobile play button for video playback
        function updateMobilePlayButton() {
            const playBtn = document.getElementById('mobilePlayBtn');
            const media = theaterMedia[theaterIndex];
            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');

            if (playBtn) {
                playBtn.style.display = isVideo ? 'flex' : 'none';
            }
        }

        function toggleMobilePlay() {
            const container = document.getElementById('theaterMediaContainer');
            const video = container.querySelector('video');
            const playBtn = document.getElementById('mobilePlayBtn');
            const playIcon = document.getElementById('mobilePlayIcon');

            if (!video) return;

            if (video.paused) {
                video.play().then(() => {
                    if (playBtn) playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> Pause';
                }).catch(err => {
                    console.log('Video play failed:', err);
                });
            } else {
                video.pause();
                if (playBtn) playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Play';
            }
        }

        function updateTheaterAiContent() {
            const content = document.getElementById('theaterAiContent');
            if (!content) return;

            const media = theaterMedia[theaterIndex] || {};
            const tweet = theaterTweet;

            // Handle missing data gracefully
            if (!tweet) {
                content.innerHTML = '<div class="ai-panel-section"><div class="ai-panel-text" style="color: var(--text-muted);">No tweet info available</div></div>';
                return;
            }

            let html = '';

            // Author info
            const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
            const authorName = authorObj ? (authorObj.name || authorObj.username) : (tweet.author || 'Unknown');
            const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
            // Get avatar URL with fallback to tweet.author_avatar for compatibility
            const rawAvatarUrl = authorObj?.avatar_url || tweet.author_avatar;
            const avatarUrl = rawAvatarUrl ? addApiKey(rawAvatarUrl) : null;

            html += `
                <div class="ai-panel-section author-section">
                    <div class="info-author">
                        ${avatarUrl ? `<img src="${avatarUrl}" class="info-avatar" alt="">` : '<div class="info-avatar-placeholder"></div>'}
                        <div class="info-author-text">
                            <div class="info-author-name">${escapeHtml(authorName)}</div>
                            <a href="https://x.com/${authorUsername}" target="_blank" class="info-author-handle">@${escapeHtml(authorUsername)}</a>
                        </div>
                    </div>
                </div>
            `;

            // Posted date & metrics
            const postedAt = tweet.posted_at ? new Date(tweet.posted_at) : null;
            const metrics = tweet.metrics || {};
            html += `
                <div class="ai-panel-section">
                    <div class="info-meta-grid">
                        ${postedAt ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                <span>${postedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${postedAt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</span>
                            </div>
                        ` : ''}
                        ${metrics.likes ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <span>${formatNumber(metrics.likes)}</span>
                            </div>
                        ` : ''}
                        ${metrics.retweets ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                                <span>${formatNumber(metrics.retweets)}</span>
                            </div>
                        ` : ''}
                        ${metrics.replies ? `
                            <div class="info-meta-item">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/></svg>
                                <span>${formatNumber(metrics.replies)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Media details
            const isVideo = media.type === 'video' || media.content_type?.startsWith('video/');
            const mediaType = isVideo ? 'Video' : 'Image';
            html += `
                <div class="ai-panel-section">
                    <div class="ai-panel-label">Media</div>
                    <div class="info-media-details">
                        <span class="info-media-type ${isVideo ? 'video' : 'image'}">${mediaType}</span>
                        ${theaterMedia.length > 1 ? `<span class="info-media-count">${theaterIndex + 1} of ${theaterMedia.length}</span>` : ''}
                    </div>
                </div>
            `;

            // Tweet text
            if (tweet.text) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">Tweet</div>
                        <div class="ai-panel-text">${escapeHtml(tweet.text)}</div>
                    </div>
                `;
            }

            // AI Summary
            if (tweet.ai_summary) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">AI Summary</div>
                        <div class="ai-panel-text">${escapeHtml(tweet.ai_summary)}</div>
                    </div>
                `;
            }

            // Media-specific AI caption
            if (media.ai_caption) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">AI Description</div>
                        <div class="ai-panel-text">${escapeHtml(media.ai_caption)}</div>
                    </div>
                `;
            }

            // Tags
            const tags = media.ai_tags || tweet.ai_tags || [];
            if (tags.length > 0) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">Tags</div>
                        <div class="ai-panel-tags">
                            ${tags.map(tag => `<span class="ai-panel-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Transcript (for videos)
            if (media.transcript) {
                html += `
                    <div class="ai-panel-section">
                        <div class="ai-panel-label">Transcript</div>
                        <div class="ai-panel-transcript">${escapeHtml(media.transcript)}</div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Cache for full tweet text
        const fullTextCache = new Map();

        // Toggle expanded tweet text - pure client-side, no API call needed
        function toggleTweetExpand(btn) {
            const card = btn.closest('.tweet-card');
            const textEl = card.querySelector('.tweet-text');
            const fullText = textEl.dataset.fullText || '';
            const isExpanded = textEl.classList.contains('expanded');

            if (isExpanded) {
                // Collapse - show truncated
                textEl.textContent = fullText.substring(0, 200) + '...';
                textEl.classList.remove('expanded');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/></svg><span>Show more</span>';
            } else {
                // Expand - show full text
                textEl.textContent = fullText;
                textEl.classList.add('expanded');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10z"/></svg><span>Show less</span>';
            }
        }

        // Gallery Mode - Browse All Media
        let galleryMode = false;
        let allGalleryMedia = [];
        let galleryTweetMap = new Map();

        function openGalleryMode() {
            // Pause any playing inline videos on the main page
            document.querySelectorAll('.media-thumb.playing').forEach(thumb => {
                thumb.classList.remove('playing');
                const vid = thumb.querySelector('video');
                if (vid) {
                    vid.pause();
                    vid.currentTime = 0;
                }
            });

            // Collect all media from all tweets
            allGalleryMedia = [];
            galleryTweetMap = new Map();

            tweets.forEach(tweet => {
                if (tweet.media && tweet.media.length > 0) {
                    tweet.media.forEach((media, idx) => {
                        const globalIdx = allGalleryMedia.length;
                        allGalleryMedia.push({
                            ...media,
                            tweetId: tweet.tweet_id,
                            mediaIdx: idx
                        });
                        galleryTweetMap.set(globalIdx, tweet);
                    });
                }
            });

            if (allGalleryMedia.length === 0) {
                alert('No media found in archive');
                return;
            }

            // Set gallery mode flag and open theater
            galleryMode = true;
            theaterMedia = allGalleryMedia;
            theaterIndex = 0;
            theaterTweet = galleryTweetMap.get(0);

            renderTheaterMedia();
            updateTheaterInfo();
            updateGalleryCounter();

            const theater = document.getElementById('mediaTheater');
            theater.classList.add('active', 'gallery-mode');
            document.body.style.overflow = 'hidden';

            // Force reflow to ensure panel width transition works correctly
            // (The panel was never laid out while theater was display:none)
            void theater.offsetWidth;

            // Open info panel by default in gallery mode (desktop only)
            const isMobile = window.innerWidth <= 768;
            // Sync resize tracker state when gallery opens
            lastWasMobile = isMobile;
            if (!isMobile) {
                document.getElementById('theaterAiPanel').classList.add('active');
                theater.classList.add('ai-panel-open');
            } else {
                // Ensure AI panel is closed on mobile
                document.getElementById('theaterAiPanel').classList.remove('active');
                theater.classList.remove('ai-panel-open');
            }

            // Show controls briefly then hide
            theater.classList.add('controls-visible');
            setTimeout(() => theater.classList.remove('controls-visible'), 2000);

            // Hide nav arrows if only one media item
            updateTheaterNavVisibility();
        }

        function closeGalleryMode() {
            galleryMode = false;
            allGalleryMedia = [];
            galleryTweetMap.clear();
            const theater = document.getElementById('mediaTheater');
            theater.classList.remove('gallery-mode');
        }

        function updateGalleryCounter() {
            document.getElementById('theaterCounter').textContent =
                `${theaterIndex + 1} / ${allGalleryMedia.length} media`;
        }

        // Override navigate to handle gallery mode
        const originalNavigateTheater = navigateTheater;
        navigateTheater = function(direction) {
            if (galleryMode) {
                // Pause current video if any
                const container = document.getElementById('theaterMediaContainer');
                const video = container.querySelector('video');
                if (video) video.pause();

                theaterIndex = (theaterIndex + direction + allGalleryMedia.length) % allGalleryMedia.length;
                theaterTweet = galleryTweetMap.get(theaterIndex);
                renderTheaterMedia();
                updateTheaterInfo();
                updateGalleryCounter();
            } else {
                originalNavigateTheater(direction);
            }
        };

        // Override close to handle gallery mode
        const originalCloseTheater = closeTheater;
        closeTheater = function() {
            if (galleryMode) {
                closeGalleryMode();
            }
            originalCloseTheater();
        };

        function closeTweetDetailModal() {
            // Redirect to new detail panel close function
            closeDetailPanel();
        }

        // Delete modal
        // Regenerate AI metadata for a tweet
        // Check if AI analysis is in progress for a tweet
        async function checkAIAnalysisStatus(tweetId) {
            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/ai-status`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (response.ok) {
                    const result = await response.json();
                    return result.in_progress || false;
                }
            } catch (error) {
                console.error('Failed to check AI status:', error);
            }
            return false;
        }

        // Update button state based on AI analysis status
        async function updateRegenerateButtonState(tweetId) {
            const btn = document.getElementById(`regenAiBtn-${tweetId}`);
            if (!btn) return;

            const inProgress = await checkAIAnalysisStatus(tweetId);
            if (inProgress) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Analyzing...';
                btn.classList.add('btn-processing');
                // Check again in 2 seconds
                setTimeout(() => updateRegenerateButtonState(tweetId), 2000);
            } else {
                btn.disabled = false;
                if (btn.classList.contains('btn-processing')) {
                    btn.classList.remove('btn-processing');
                    // Restore original button content
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Regenerate AI
                    `;

                    // Analysis finished - refresh the tweet details (and list) to show updated AI and transcripts.
                    // This is safe even if the user closed the modal; openTweetDetail will just re-open if needed.
                    loadTweets({ preserveScroll: true, keepSearch: true });
                    if (document.getElementById('tweetDetailModal').classList.contains('active')) {
                        openTweetDetail(tweetId);
                    }
                }
            }
        }

        let lastDiagnosticsJson = null;
        let diagnosticsExpanded = false;

        function toggleDiagnostics() {
            diagnosticsExpanded = !diagnosticsExpanded;
            const el = document.getElementById('tweetDiagnostics');
            const icon = document.getElementById('diagToggleIcon');
            if (el) el.style.display = diagnosticsExpanded ? 'block' : 'none';
            if (icon) icon.style.transform = diagnosticsExpanded ? 'rotate(180deg)' : 'rotate(0)';
        }

        async function loadDiagnostics(tweetId) {
            const container = document.getElementById('tweetDiagnostics');
            const codeEl = container?.querySelector('.detail-diagnostics-code') || container;
            if (!codeEl) return;
            codeEl.textContent = 'Loading diagnostics...';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/diagnostics`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) {
                    throw new Error(`Diagnostics failed: ${response.status}`);
                }
                const data = await response.json();
                lastDiagnosticsJson = data;

                // Pretty print with a small summary up top
                const summary = [
                    `AI in progress: ${data.ai_in_progress}`,
                    `Whisper enabled: ${data.pipeline?.whisper_enabled} (client init: ${data.pipeline?.whisper_client_initialized})`,
                    `FFmpeg: ${data.pipeline?.ffmpeg_available ? 'available' : 'missing'} ${data.pipeline?.ffmpeg_version ? '(' + data.pipeline.ffmpeg_version + ')' : ''}`,
                    `Video processor: ${data.pipeline?.video_processor_initialized}`,
                    `Has video: ${data.has_video} | Has images: ${data.has_images}`,
                    `Media items: ${data.media?.length || 0}`,
                ].join('\n');

                codeEl.textContent = summary + '\n\n' + JSON.stringify(data, null, 2);
            } catch (err) {
                lastDiagnosticsJson = null;
                codeEl.textContent = `Failed to load diagnostics: ${err}`;
            }
        }

        async function copyDiagnostics() {
            if (!lastDiagnosticsJson) {
                alert('No diagnostics loaded yet.');
                return;
            }
            try {
                await navigator.clipboard.writeText(JSON.stringify(lastDiagnosticsJson, null, 2));
            } catch {
                // Fallback: prompt
                prompt('Copy diagnostics JSON:', JSON.stringify(lastDiagnosticsJson, null, 2));
            }
        }

        // =============================================
        // DIAGNOSTICS MODAL (new clean implementation)
        // =============================================
        async function openDiagModal(tweetId) {
            const overlay = document.getElementById('diagModalOverlay');
            const codeEl = document.getElementById('diagModalCode');
            overlay.classList.add('active');
            codeEl.textContent = 'Loading diagnostics...';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/diagnostics`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) throw new Error(`Failed: ${response.status}`);
                const data = await response.json();
                lastDiagnosticsJson = data;
                codeEl.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                lastDiagnosticsJson = null;
                codeEl.textContent = `Error: ${err.message}`;
            }
        }

        function closeDiagModal() {
            document.getElementById('diagModalOverlay').classList.remove('active');
        }

        async function copyDiagnosticsModal() {
            const btn = document.getElementById('diagCopyBtn');
            if (!lastDiagnosticsJson) return;

            try {
                await navigator.clipboard.writeText(JSON.stringify(lastDiagnosticsJson, null, 2));
                btn.classList.add('copied');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy';
                }, 2000);
            } catch {
                // Fallback
                const text = JSON.stringify(lastDiagnosticsJson, null, 2);
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 2000);
            }
        }

        // =============================================
        // MAIN MEDIA VIEWER WITH NAVIGATION
        // =============================================
        function renderMainMediaViewer(tweet, startIndex = 0) {
            if (!tweet.media || tweet.media.length === 0) {
                return '<div class="detail-media-empty">No media files</div>';
            }

            currentDetailMediaIndex = startIndex;
            const media = tweet.media;
            const current = media[startIndex];
            const isVideo = current.type === 'video' || current.content_type?.startsWith('video/');
            const mediaUrl = addApiKey(current.url);
            const tweetId = tweet.tweet_id;

            // Build download filename
            const authorObj = typeof tweet.author === 'object' ? tweet.author : null;
            const authorUsername = authorObj ? authorObj.username : (tweet.author || 'unknown');
            const dateStr = tweet.posted_at ? new Date(tweet.posted_at).toISOString().split('T')[0] : 'archived';
            const titleSlug = (tweet.ai_title || tweet.text || '').slice(0, 40).replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+$/, '') || 'media';
            const baseFilename = `${authorUsername}_${dateStr}_${titleSlug}`;
            const ext = isVideo ? 'mp4' : (current.filename || current.url || '').split('.').pop() || 'jpg';
            const downloadName = `${baseFilename}${media.length > 1 ? '_' + (startIndex + 1) : ''}.${ext}`;

            // Main media display
            const mainMedia = isVideo
                ? `<video src="${mediaUrl}" controls preload="metadata" playsinline></video>`
                : `<img src="${mediaUrl}" alt="Media ${startIndex + 1}" onclick="openTheater('${tweetId}', ${startIndex})">`;

            // Navigation (only if multiple media)
            const showNav = media.length > 1;
            const navPrev = showNav ? `
                <button class="detail-main-media-nav prev" onclick="navigateDetailMedia(-1)" ${startIndex === 0 ? 'style="display:none"' : ''}>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>` : '';
            const navNext = showNav ? `
                <button class="detail-main-media-nav next" onclick="navigateDetailMedia(1)" ${startIndex === media.length - 1 ? 'style="display:none"' : ''}>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                </button>` : '';

            // Counter
            const counter = showNav ? `<div class="detail-main-media-counter">${startIndex + 1} / ${media.length}</div>` : '';

            // Action buttons
            const actions = `
                <div class="detail-main-media-actions">
                    ${!isVideo ? `<button class="detail-main-media-btn" onclick="openTheater('${tweetId}', ${startIndex})" title="Fullscreen">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                    </button>` : ''}
                    <a class="detail-main-media-btn" href="${mediaUrl}" download="${escapeHtml(downloadName)}" title="Download">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l-5-5 1.41-1.41L11 12.17V4h2v8.17l2.59-2.58L17 11l-5 5zm-7 2h14v2H5z"/></svg>
                    </a>
                </div>`;

            // Thumbnails strip
            let thumbsHtml = '';
            if (showNav) {
                thumbsHtml = '<div class="detail-media-thumbs">';
                media.forEach((m, idx) => {
                    const thumbUrl = addApiKey(m.url);
                    const isThumbVideo = m.type === 'video' || m.content_type?.startsWith('video/');
                    const activeClass = idx === startIndex ? 'active' : '';
                    thumbsHtml += `
                        <div class="detail-media-thumb ${activeClass}" onclick="selectDetailMedia(${idx})" style="position:relative;">
                            ${isThumbVideo
                                ? `<video src="${thumbUrl}" preload="metadata" muted></video><div class="thumb-video-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></div>`
                                : `<img src="${thumbUrl}" alt="Thumbnail ${idx + 1}">`
                            }
                        </div>`;
                });
                thumbsHtml += '</div>';
            }

            return `
                <div class="detail-main-media" id="detailMainMedia">
                    <div class="detail-main-media-container">
                        ${navPrev}
                        ${mainMedia}
                        ${navNext}
                        ${counter}
                        ${actions}
                    </div>
                    ${thumbsHtml}
                </div>`;
        }

        function navigateDetailMedia(direction) {
            if (!currentTweetDetail || !currentTweetDetail.media) return;
            const newIndex = currentDetailMediaIndex + direction;
            if (newIndex < 0 || newIndex >= currentTweetDetail.media.length) return;
            selectDetailMedia(newIndex);
        }

        function selectDetailMedia(index) {
            if (!currentTweetDetail || !currentTweetDetail.media) return;
            if (index < 0 || index >= currentTweetDetail.media.length) return;

            currentDetailMediaIndex = index;
            const container = document.getElementById('detailMainMedia');
            if (container) {
                container.outerHTML = renderMainMediaViewer(currentTweetDetail, index);
            }

            // Pause any playing videos when switching
            document.querySelectorAll('.detail-main-media-container video').forEach(v => {
                if (!v.paused) v.pause();
            });
        }

        // =============================================
        // NOTES FUNCTIONALITY (localStorage-based)
        // =============================================
        function getNoteKey(tweetId) {
            return `xgrabba_note_${tweetId}`;
        }

        function loadNote(tweetId) {
            return localStorage.getItem(getNoteKey(tweetId)) || '';
        }

        function saveNote(tweetId, text) {
            if (text.trim()) {
                localStorage.setItem(getNoteKey(tweetId), text);
            } else {
                localStorage.removeItem(getNoteKey(tweetId));
            }
        }

        function handleNoteChange(tweetId, textarea) {
            const statusEl = textarea.parentElement.querySelector('.detail-notes-status');

            // Clear any pending save
            if (noteSaveTimeout) clearTimeout(noteSaveTimeout);

            // Show "saving..." status
            statusEl.textContent = 'Saving...';
            statusEl.classList.add('visible');
            statusEl.classList.remove('saved');

            // Debounce save
            noteSaveTimeout = setTimeout(() => {
                saveNote(tweetId, textarea.value);
                statusEl.textContent = 'Saved';
                statusEl.classList.add('saved');
                setTimeout(() => {
                    statusEl.classList.remove('visible', 'saved');
                }, 1500);
            }, 500);
        }

        // =============================================
        // NEW ENTRIES DETECTION
        // =============================================
        function startNewEntriesPolling() {
            // Initialize with current tweet IDs
            lastKnownTweetIds = new Set(tweets.map(t => t.tweet_id));

            // Poll every 15 seconds
            if (newEntriesPollTimer) clearInterval(newEntriesPollTimer);
            newEntriesPollTimer = setInterval(checkForNewEntries, 15000);
        }

        async function checkForNewEntries() {
            try {
                const response = await fetch('/api/v1/tweets?limit=10', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) return;

                const data = await response.json();
                const newTweets = (data.tweets || []).filter(t => !lastKnownTweetIds.has(t.tweet_id));

                if (newTweets.length > 0) {
                    // Auto-load new entries with animation
                    loadNewEntries();
                }
            } catch (err) {
                console.error('Error checking for new entries:', err);
            }
        }

        function showNewEntriesIndicator(count) {
            const indicator = document.getElementById('newEntriesIndicator');
            const countEl = document.getElementById('newEntriesCount');
            countEl.textContent = count === 1 ? '1 new archive' : `${count} new archives`;
            indicator.classList.add('visible');
        }

        function hideNewEntriesIndicator() {
            document.getElementById('newEntriesIndicator').classList.remove('visible');
        }

        async function loadNewEntries() {
            hideNewEntriesIndicator();

            // Only scroll to top if user is near the top already
            if (window.scrollY < 300) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Reload tweets
            const previousIds = new Set(tweets.map(t => t.tweet_id));
            await loadTweets({ preserveScroll: true, keepSearch: true });

            // Mark new entries for animation
            tweets.forEach(t => {
                if (!previousIds.has(t.tweet_id)) {
                    lastKnownTweetIds.add(t.tweet_id);
                    const card = document.querySelector(`.tweet-card[data-tweet-id="${t.tweet_id}"]`);
                    if (card) {
                        card.classList.add('new-entry');
                        setTimeout(() => card.classList.remove('new-entry'), 2000);
                    }
                }
            });
        }

        function toggleTranscript(transcriptId) {
            const el = document.getElementById(transcriptId);
            if (!el) return;
            el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
        }

        // =============================================
        // TRANSCRIPT MODAL
        // =============================================
        let currentTranscriptText = '';

        function openTranscriptModal(text, lang, wordCount) {
            currentTranscriptText = text;
            const overlay = document.getElementById('transcriptModalOverlay');
            const langEl = document.getElementById('transcriptModalLang');
            const wordsEl = document.getElementById('transcriptModalWords');
            const contentEl = document.getElementById('transcriptModalContent');

            langEl.textContent = lang || '';
            langEl.style.display = lang ? '' : 'none';
            wordsEl.textContent = wordCount ? `${wordCount} words` : '';
            contentEl.textContent = text;

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Show transcript from button data attributes (for browse view)
        function showTranscriptFromButton(btn) {
            const text = btn.dataset.transcript || '';
            const lang = btn.dataset.lang || '';
            const wordCount = text.split(/\s+/).filter(w => w).length;
            openTranscriptModal(text, lang, wordCount);
        }

        // Toggle inline transcript expansion (for archive details)
        function toggleInlineTranscript(section) {
            const content = section.querySelector('.detail-transcript-content');
            const hint = section.querySelector('.transcript-toggle-hint');
            const icon = section.querySelector('.transcript-expand-icon');
            const isExpanded = section.classList.contains('expanded');

            if (isExpanded) {
                // Collapse
                section.classList.remove('expanded');
                content.style.maxHeight = '120px';
                content.style.overflowY = 'hidden';
                content.style.maskImage = 'linear-gradient(to bottom, black 60%, transparent 100%)';
                content.style.webkitMaskImage = 'linear-gradient(to bottom, black 60%, transparent 100%)';
                hint.textContent = 'Show full transcript';
                if (icon) icon.style.transform = '';
            } else {
                // Expand - show full transcript with scroll
                section.classList.add('expanded');
                content.style.maxHeight = 'none';
                content.style.overflowY = 'auto';
                content.style.maskImage = 'none';
                content.style.webkitMaskImage = 'none';
                hint.textContent = 'Show less';
                if (icon) icon.style.transform = 'rotate(180deg)';
            }
        }

        function closeTranscriptModal() {
            document.getElementById('transcriptModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function copyTranscriptFromModal() {
            const btn = document.getElementById('transcriptCopyBtn');
            if (!currentTranscriptText) return;

            try {
                await navigator.clipboard.writeText(currentTranscriptText);
                btn.classList.add('copied');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy';
                }, 2000);
            } catch {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = currentTranscriptText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 2000);
            }
        }

        // =============================================
        // STATS MODAL
        // =============================================
        function toggleStatsModal() {
            const overlay = document.getElementById('statsModalOverlay');
            if (overlay.classList.contains('active')) {
                closeStatsModal();
            } else {
                openStatsModal();
            }
        }

        function openStatsModal() {
            const overlay = document.getElementById('statsModalOverlay');
            overlay.classList.add('active');
            updateStatsModal();
        }

        function closeStatsModal() {
            document.getElementById('statsModalOverlay').classList.remove('active');
        }

        function updateStatsModal() {
            // Copy values from hidden stats bar
            document.getElementById('statsModalCPU').textContent = document.getElementById('statCPU')?.textContent || '0%';
            document.getElementById('statsModalDisk').textContent = document.getElementById('statDisk')?.textContent || '--';
            document.getElementById('statsModalTweets').textContent = document.getElementById('statTweets')?.textContent || '--';
            document.getElementById('statsModalVideos').textContent = document.getElementById('statVideos')?.textContent || '--';
            document.getElementById('statsModalImages').textContent = document.getElementById('statImages')?.textContent || '--';
            document.getElementById('statsModalStorage').textContent = document.getElementById('statStorage')?.textContent || '--';

            const diskBar = document.getElementById('statDiskBar');
            const modalDiskBar = document.getElementById('statsModalDiskBar');
            if (diskBar && modalDiskBar) {
                modalDiskBar.style.width = diskBar.style.width;
            }
        }

        async function copyTranscript(btnId, text) {
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.getElementById(btnId);
                if (btn) {
                    const old = btn.textContent;
                    btn.textContent = 'Copied';
                    setTimeout(() => { btn.textContent = old; }, 1000);
                }
            } catch {
                prompt('Copy transcript:', text);
            }
        }

        // Copy transcript from detail panel with visual feedback
        async function copyDetailTranscript(btn, tweetId) {
            if (!currentTweetDetail || !currentTweetDetail.media) return;

            // Find the first video with transcript
            const videoWithTranscript = currentTweetDetail.media.find(m =>
                (m.type === 'video' || m.content_type?.startsWith('video/')) && m.transcript && m.transcript.trim().length > 0
            );

            if (!videoWithTranscript?.transcript) {
                return;
            }

            try {
                await navigator.clipboard.writeText(videoWithTranscript.transcript);
                // Visual feedback
                btn.classList.add('copied');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy';
                }, 1500);
            } catch {
                prompt('Copy transcript:', videoWithTranscript.transcript);
            }
        }

        async function regenerateAI(tweetId) {
            const btn = document.getElementById(`regenAiBtn-${tweetId}`);
            if (!btn) return;

            // Check if already in progress
            const inProgress = await checkAIAnalysisStatus(tweetId);
            if (inProgress) {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Already analyzing...';
                // Start polling for status
                setTimeout(() => updateRegenerateButtonState(tweetId), 2000);
                return;
            }

            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Analyzing...';
            btn.classList.add('btn-processing');

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/regenerate-ai`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.status === 409) {
                    // Already in progress
                    const result = await response.json();
                    if (result.in_progress) {
                        btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Already analyzing...';
                        // Start polling for status
                        setTimeout(() => updateRegenerateButtonState(tweetId), 2000);
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error('Failed to regenerate AI metadata');
                }

                // Accepted: regeneration runs asynchronously. Poll status until complete.
                setTimeout(() => updateRegenerateButtonState(tweetId), 1500);

            } catch (error) {
                console.error('Regenerate AI error:', error);
                btn.innerHTML = 'Failed - Retry';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                }, 3000);
            }
        }

        // Resync tweet - re-fetch from Twitter to get updated/full text
        async function resyncTweet(tweetId) {
            if (!tweetId) return;

            const btn = document.getElementById('detailResync');
            if (!btn) return;

            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Resyncing...';

            try {
                const response = await fetch(`/api/v1/tweets/${tweetId}/resync`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.status === 409) {
                    // Already in progress
                    const result = await response.json();
                    if (result.in_progress) {
                        btn.innerHTML = '<div class="spinner" style="width: 14px; height: 14px; border-width: 2px; display: inline-block; margin-right: 6px;"></div> Already syncing...';
                        // Poll for completion
                        pollResyncStatus(tweetId, originalContent);
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error('Failed to resync tweet');
                }

                // Accepted: resync runs asynchronously. Poll status until complete.
                pollResyncStatus(tweetId, originalContent);

            } catch (error) {
                console.error('Resync error:', error);
                btn.innerHTML = 'Failed - Retry';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                }, 3000);
            }
        }

        async function pollResyncStatus(tweetId, originalBtnContent) {
            const btn = document.getElementById('detailResync');

            try {
                const statusResponse = await fetch(`/api/v1/tweets/${tweetId}/ai-status`, {
                    headers: { 'X-API-Key': API_KEY }
                });

                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    if (status.in_progress) {
                        // Still processing, poll again
                        setTimeout(() => pollResyncStatus(tweetId, originalBtnContent), 2000);
                        return;
                    }
                }

                // Complete - refresh detail panel
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                }

                // Reload the detail panel to show updated data
                if (currentTweetDetail?.tweet_id === tweetId) {
                    await openTweetDetail(tweetId);
                }

                // Refresh the main list too
                await loadTweets();

            } catch (error) {
                console.error('Poll resync status error:', error);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                }
            }
        }

        function showDeleteModal(tweetId) {
            deleteTarget = tweetId;
            document.getElementById('deleteModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteModal() {
            deleteTarget = null;
            document.getElementById('deleteModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteTarget) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Deleting...';

            try {
                const response = await fetch(`/api/v1/tweets/${deleteTarget}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.ok) {
                    tweets = tweets.filter(t => t.tweet_id !== deleteTarget);
                    renderTweets(tweets);
                    updateStats();
                } else {
                    alert('Failed to delete tweet');
                }
            } catch (error) {
                console.error('Failed to delete:', error);
                alert('Failed to delete tweet');
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                    <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                </svg>
                Delete
            `;
            closeDeleteModal();
        });

        // ========================
        // Backfill Truncated Tweets
        // ========================

        let truncatedTweetsCache = null;

        async function checkTruncatedTweets() {
            try {
                const response = await fetch('/api/v1/tweets/truncated', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (response.ok) {
                    const data = await response.json();
                    truncatedTweetsCache = data.tweets;
                    const count = data.total || 0;
                    const pill = document.getElementById('backfillPill');
                    const countEl = document.getElementById('statTruncated');

                    if (count > 0) {
                        pill.style.display = 'flex';
                        countEl.textContent = count;
                    } else {
                        pill.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to check truncated tweets:', error);
            }
        }

        function showBackfillModal() {
            const count = truncatedTweetsCache ? truncatedTweetsCache.length : 0;
            document.getElementById('backfillCount').textContent = count;
            document.getElementById('backfillModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBackfillModal() {
            document.getElementById('backfillModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function startBackfill() {
            const btn = document.getElementById('startBackfillBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Starting...';

            try {
                const response = await fetch('/api/v1/tweets/backfill-truncated', {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                if (response.ok) {
                    const data = await response.json();
                    btn.innerHTML = `Started ${data.started} resyncs`;

                    // Hide the pill since backfill is in progress
                    document.getElementById('backfillPill').style.display = 'none';

                    setTimeout(() => {
                        closeBackfillModal();
                        // Refresh the tweet list after a delay
                        setTimeout(loadTweets, 3000);
                    }, 2000);
                } else {
                    const err = await response.json();
                    alert('Failed to start backfill: ' + (err.error || 'Unknown error'));
                    btn.innerHTML = 'Start Backfill';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Failed to start backfill:', error);
                alert('Failed to start backfill');
                btn.innerHTML = 'Start Backfill';
                btn.disabled = false;
            }
        }

        // Search functionality with debouncing
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            // Toggle clear button
            searchClear.classList.toggle('visible', query.length > 0);

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 150);
        });

        searchClear.addEventListener('click', async () => {
            searchInput.value = '';
            searchClear.classList.remove('visible');
            searchResultsInfo.classList.remove('visible');
            // Reset pagination and reload full tweet list from server
            paginationState.searchQuery = '';
            await loadTweets({ preserveScroll: false, keepSearch: false, reset: true });
        });

        // Server-side search with infinite scroll support
        async function performSearch(query) {
            if (!query) {
                searchResultsInfo.classList.remove('visible');
                // Reset to browsing all tweets
                paginationState.searchQuery = '';
                await loadTweets({ preserveScroll: false, keepSearch: false, reset: true });
                return;
            }

            // Reset pagination for new search
            paginationState.offset = 0;
            paginationState.searchQuery = query;
            paginationState.isLoading = true;

            const result = await fetchTweetsPage(0, paginationState.limit, query);

            if (!result) {
                paginationState.isLoading = false;
                return;
            }

            tweets = result.tweets;
            paginationState.total = result.total;
            paginationState.hasMore = result.hasMore;
            paginationState.offset = tweets.length;
            paginationState.isLoading = false;

            // Update search results info
            searchResultCount.textContent = result.total;
            searchQuerySpan.textContent = query;
            searchResultsInfo.classList.add('visible');

            renderTweets(tweets, query);
            updateLoadMoreIndicator();
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    if (overlay.id === 'deleteModal') {
                        closeDeleteModal();
                    } else if (overlay.id === 'tweetDetailModal') {
                        closeTweetDetailModal();
                    } else {
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const theater = document.getElementById('mediaTheater');
            const lightbox = document.getElementById('lightbox');
            const detailPanel = document.getElementById('detailPanelOverlay');
            const deleteModal = document.getElementById('deleteModal');

            // Escape to close modals (priority: theater > lightbox > delete > detail panel)
            if (e.key === 'Escape') {
                if (theater.classList.contains('active')) {
                    closeTheater();
                } else if (lightbox.classList.contains('active')) {
                    closeLightbox();
                } else if (deleteModal.classList.contains('active')) {
                    closeDeleteModal();
                } else if (detailPanel.classList.contains('active')) {
                    closeDetailPanel();
                }
            }

            // Slash to focus search (when not in input)
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }

            // Arrow keys for theater navigation
            if (theater.classList.contains('active')) {
                if (e.key === 'ArrowLeft') navigateTheater(-1);
                if (e.key === 'ArrowRight') navigateTheater(1);
                if (e.key === 'i' || e.key === 'I') toggleTheaterAI();
            }

            // Arrow keys for lightbox navigation
            if (lightbox.classList.contains('active')) {
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
            }
        });

        // Touch gestures for theater
        (function initTouchGestures() {
            const theater = document.getElementById('mediaTheater');
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;

            theater.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            }, { passive: true });

            theater.addEventListener('touchend', (e) => {
                if (!theater.classList.contains('active')) return;

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const touchDuration = Date.now() - touchStartTime;

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const absX = Math.abs(deltaX);
                const absY = Math.abs(deltaY);

                // Minimum swipe distance and max time for swipe
                const minSwipeDistance = 50;
                const maxSwipeTime = 500;

                // Horizontal swipe for navigation
                if (absX > minSwipeDistance && absX > absY && touchDuration < maxSwipeTime) {
                    if (deltaX > 0) {
                        navigateTheater(-1); // Swipe right = previous
                    } else {
                        navigateTheater(1); // Swipe left = next
                    }
                }

                // Vertical swipe down to close (only if not interacting with video controls)
                if (absY > 100 && absY > absX * 2 && deltaY > 0 && touchDuration < maxSwipeTime) {
                    const target = e.target;
                    if (!target.closest('video') && !target.closest('.theater-ai-panel')) {
                        closeTheater();
                    }
                }

                // Tap to toggle controls (quick tap with minimal movement)
                if (absX < 10 && absY < 10 && touchDuration < 200) {
                    const target = e.target;
                    if (!target.closest('button') && !target.closest('a') && !target.closest('video') && !target.closest('.theater-ai-panel')) {
                        theater.classList.toggle('controls-visible');
                    }
                }
            }, { passive: true });
        })();

        // Scroll to top button
        window.addEventListener('scroll', () => {
            scrollTopBtn.classList.toggle('visible', window.scrollY > 400);
        });

        scrollTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Show keyboard hint briefly on load
        setTimeout(() => {
            keyboardHint.classList.add('visible');
            setTimeout(() => {
                keyboardHint.classList.remove('visible');
            }, 3000);
        }, 1000);

        // Initialize
        fetchTweets().then(() => {
            // Check if we should auto-open a specific tweet (from extension popup link)
            const tweetParam = params.get('tweet');
            if (tweetParam) {
                // Clean URL and open detail
                window.history.replaceState({}, '', window.location.pathname + (API_KEY && !params.get('key') ? '' : ''));
                openTweetDetail(tweetParam);
            }

            // Online mode only features
            if (!OFFLINE_MODE) {
                // Check for truncated tweets after initial load
                checkTruncatedTweets();

                // Start polling for new entries
                startNewEntriesPolling();
            }
        });

        // Online mode only: polling and stats
        if (!OFFLINE_MODE) {
            // Keep the list responsive: update AI progress badges without requiring a full reload.
            startAIPolling();

            // Start system stats polling
            startSystemStatsPolling();
        }

        // Hide server-only features in offline mode
        if (OFFLINE_MODE) {
            // Hide action buttons that require server
            const serverOnlyElements = [
                'detailRegenAI',      // Regenerate AI button
                'detailResync',       // Resync button
                'deleteModal',        // Delete modal
                'backfillModal',      // Backfill truncated tweets modal
                'bookmarksBtn',       // Bookmarks button in header
                'bookmarksModal',     // Bookmarks modal
            ];
            serverOnlyElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Hide stats pills that show server metrics
            document.querySelectorAll('.stat-pill.archive-stat').forEach(el => {
                if (el.textContent.includes('CPU') || el.textContent.includes('Disk') ||
                    el.textContent.includes('Running') || el.textContent.includes('Analyzing')) {
                    el.style.display = 'none';
                }
            });

            // Update title to indicate offline mode
            document.title = 'XGrabba Archive (Offline)';

            // Display export metadata if available
            const metadata = window.OFFLINE_DATA?.metadata;
            if (metadata) {
                // Update the stats bar with offline metadata
                const statTweets = document.getElementById('statTweets');
                if (statTweets) statTweets.textContent = metadata.tweet_count || OFFLINE_TWEETS.length;

                const statVideos = document.getElementById('statVideos');
                const statImages = document.getElementById('statImages');
                if (statVideos && statImages && metadata.media_count !== undefined) {
                    // Count videos vs images from OFFLINE_TWEETS
                    let videoCount = 0, imageCount = 0;
                    OFFLINE_TWEETS.forEach(t => {
                        (t.media || []).forEach(m => {
                            if (m.type === 'video' || m.type === 'gif') videoCount++;
                            else if (m.type === 'image') imageCount++;
                        });
                    });
                    statVideos.textContent = videoCount;
                    statImages.textContent = imageCount;
                }

                // Show export info in header or create info banner
                const exportDate = metadata.exported_at ? new Date(metadata.exported_at) : null;
                const exportDateStr = exportDate ? exportDate.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                }) : '';

                // Add offline info banner below header
                const header = document.querySelector('.header');
                if (header && exportDateStr) {
                    const infoBanner = document.createElement('div');
                    infoBanner.className = 'offline-info-banner';
                    infoBanner.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                            <path d="M12 3v10.586l3.293-3.293 1.414 1.414L12 16.414l-4.707-4.707 1.414-1.414L12 13.586V3h2z"/>
                            <path d="M5 17v4h14v-4h2v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4h2z"/>
                        </svg>
                        <span>Exported ${exportDateStr}</span>
                        <span class="offline-meta-sep"></span>
                        <span>${metadata.tweet_count || OFFLINE_TWEETS.length} tweets</span>
                        <span class="offline-meta-sep"></span>
                        <span>${metadata.media_count || 0} media files</span>
                        ${metadata.encrypted ? `
                            <span class="offline-meta-sep"></span>
                            <span class="offline-encrypted">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12">
                                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                                </svg>
                                Encrypted
                            </span>
                        ` : ''}
                    `;
                    header.parentNode.insertBefore(infoBanner, header.nextSibling);
                }
            }
        }

        // Bookmarks state
        let bookmarksState = {
            connected: false,
            authMode: 'oauth',
            monitorState: 'idle',
            userId: null,
            lastPoll: null,
            lastError: null,
            browserCredentials: null
        };

        async function refreshBookmarksStatus() {
            const statusSpan = document.getElementById('bookmarksStatus');
            const openBtn = document.getElementById('bookmarksBtn');
            if (!statusSpan) return;

            try {
                const resp = await fetch('/api/v1/bookmarks/status', { headers: { 'X-API-Key': API_KEY } });
                if (!resp.ok) return;
                const data = await resp.json();

                bookmarksState.connected = data.connected;
                bookmarksState.authMode = data.auth_mode || 'oauth';
                bookmarksState.monitorState = data.monitor_state || 'idle';
                bookmarksState.userId = data.user_id || null;
                bookmarksState.lastPoll = data.last_poll ? new Date(data.last_poll) : null;
                bookmarksState.lastError = data.last_error || null;
                bookmarksState.browserCredentials = data.browser_credentials || null;

                if (data.connected) {
                    if (openBtn) openBtn.classList.add('connected');
                    if (data.monitor_state === 'running') {
                        statusSpan.textContent = 'Running';
                        statusSpan.className = 'bookmarks-status connected';
                    } else if (data.monitor_state === 'paused') {
                        statusSpan.textContent = 'Paused';
                        statusSpan.className = 'bookmarks-status';
                    } else {
                        statusSpan.textContent = 'Connected';
                        statusSpan.className = 'bookmarks-status connected';
                    }
                } else {
                    if (openBtn) openBtn.classList.remove('connected');
                    if (bookmarksState.authMode === 'browser') {
                        statusSpan.textContent = 'Needs browser session';
                    } else {
                        statusSpan.textContent = 'Disconnected';
                    }
                    statusSpan.className = 'bookmarks-status disconnected';
                }
            } catch {
                // Silent fail
            }
        }

        function updateBookmarksModalUI() {
            const dot = document.getElementById('bookmarksConnectionDot');
            const label = document.getElementById('bookmarksConnectionLabel');
            const details = document.getElementById('bookmarksConnectionDetails');
            const pauseBtn = document.getElementById('bookmarksPauseBtn');
            const checkNowBtn = document.getElementById('bookmarksCheckNowBtn');
            const connectBtn = document.getElementById('bookmarksConnectBtn');
            const disconnectBtn = document.getElementById('bookmarksDisconnectBtn');

            if (bookmarksState.connected) {
                dot.classList.add('connected');
                if (bookmarksState.monitorState === 'running') {
                    label.textContent = 'Connected & Running';
                    pauseBtn.textContent = 'Pause';
                    pauseBtn.disabled = false;
                    checkNowBtn.disabled = false;
                } else if (bookmarksState.monitorState === 'paused') {
                    label.textContent = 'Connected (Paused)';
                    pauseBtn.textContent = 'Resume';
                    pauseBtn.disabled = false;
                    checkNowBtn.disabled = true;
                } else {
                    label.textContent = 'Connected';
                    pauseBtn.disabled = true;
                    checkNowBtn.disabled = true;
                }

                let detailsText = bookmarksState.authMode === 'browser'
                    ? 'Auth: Browser session'
                    : `User ID: ${bookmarksState.userId || 'Unknown'}`;
                if (bookmarksState.lastPoll) {
                    detailsText += ` | Last poll: ${formatRelativeTime(bookmarksState.lastPoll)}`;
                }
                if (bookmarksState.lastError) {
                    detailsText += ` | Error: ${bookmarksState.lastError}`;
                }
                details.textContent = detailsText;

                if (bookmarksState.authMode === 'browser') {
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                } else {
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-flex';
                }
            } else {
                dot.classList.remove('connected');
                label.textContent = 'Disconnected';
                details.textContent = bookmarksState.authMode === 'browser'
                    ? 'Waiting for forwarded browser session credentials'
                    : 'Not connected to X Bookmarks';
                pauseBtn.disabled = true;
                checkNowBtn.disabled = true;
                if (bookmarksState.authMode === 'browser') {
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                } else {
                    connectBtn.style.display = 'inline-flex';
                    disconnectBtn.style.display = 'none';
                }
            }
        }

        async function loadBookmarksActivity() {
            const list = document.getElementById('bookmarksActivityList');
            try {
                const resp = await fetch('/api/v1/bookmarks/activity', { headers: { 'X-API-Key': API_KEY } });
                if (!resp.ok) return;
                const data = await resp.json();

                if (!data.events || data.events.length === 0) {
                    list.innerHTML = '<div class="bookmarks-activity-empty">No activity yet</div>';
                    return;
                }

                list.innerHTML = data.events.map(event => {
                    let title = event.status;
                    let details = '';

                    switch (event.status) {
                        case 'success':
                            title = 'Poll completed';
                            details = `${event.total_bookmarks || 0} bookmarks, ${event.new_bookmarks || 0} new`;
                            if (event.archived_ids && event.archived_ids.length > 0) {
                                details += ` (archived: ${event.archived_ids.join(', ')})`;
                            }
                            break;
                        case 'rate_limited':
                            title = 'Rate limited';
                            details = event.error || 'Waiting for rate limit reset';
                            break;
                        case 'failed':
                            title = 'Poll failed';
                            details = event.error || 'Unknown error';
                            break;
                        case 'paused':
                            title = 'Monitor paused';
                            break;
                        case 'resumed':
                            title = 'Monitor resumed';
                            break;
                        case 'check_now':
                            title = 'Manual check triggered';
                            break;
                    }

                    const time = event.timestamp ? formatRelativeTime(new Date(event.timestamp)) : '';

                    return `
                        <div class="bookmarks-activity-item">
                            <div class="activity-dot ${event.status}"></div>
                            <div class="activity-content">
                                <div class="activity-title">${title}</div>
                                ${details ? `<div class="activity-details">${escapeHtml(details)}</div>` : ''}
                            </div>
                            <div class="activity-time">${time}</div>
                        </div>
                    `;
                }).join('');
            } catch {
                list.innerHTML = '<div class="bookmarks-activity-empty">Failed to load activity</div>';
            }
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSecs < 60) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        async function openBookmarksModal() {
            await refreshBookmarksStatus();
            updateBookmarksModalUI();
            loadBookmarksActivity();

            const modal = document.getElementById('bookmarksModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBookmarksModal() {
            const modal = document.getElementById('bookmarksModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function toggleBookmarksPause() {
            const endpoint = bookmarksState.monitorState === 'paused'
                ? '/api/v1/bookmarks/resume'
                : '/api/v1/bookmarks/pause';

            try {
                await fetch(endpoint, { method: 'POST', headers: { 'X-API-Key': API_KEY } });
                await refreshBookmarksStatus();
                updateBookmarksModalUI();
                loadBookmarksActivity();
            } catch (err) {
                console.error('Failed to toggle pause:', err);
            }
        }

        async function bookmarksCheckNow() {
            try {
                await fetch('/api/v1/bookmarks/check-now', { method: 'POST', headers: { 'X-API-Key': API_KEY } });
                // Refresh after a short delay to show the result
                setTimeout(() => {
                    refreshBookmarksStatus();
                    loadBookmarksActivity();
                }, 2000);
            } catch (err) {
                console.error('Failed to trigger check:', err);
            }
        }

        function openBookmarksConnect(e) {
            if (e) e.preventDefault();
            if (!API_KEY) {
                alert('Set your xgrabba API key first.');
                return;
            }
            const userId = prompt('Enter your numeric X user id (recommended; avoids extra API calls). Leave blank to auto-detect once:');
            let url = `/bookmarks/oauth/start?key=${encodeURIComponent(API_KEY)}`;
            if (userId && userId.trim()) {
                const trimmed = userId.trim();
                if (!/^[0-9]+$/.test(trimmed)) {
                    alert('User id must be numeric.');
                    return;
                }
                url += `&user_id=${encodeURIComponent(trimmed)}`;
            } else {
                if (!confirm('Auto-detect user id using X API once during connect?')) return;
                url += `&infer_user_id=1`;
            }
            window.open(url, '_blank');
            // Refresh status after the user completes OAuth in the other window.
            setTimeout(() => {
                refreshBookmarksStatus();
                updateBookmarksModalUI();
                loadBookmarksActivity();
            }, 3000);
        }

        async function disconnectBookmarks(e) {
            if (e) e.preventDefault();
            if (!confirm('Disconnect bookmarks monitoring? Your archives will remain.')) return;
            try {
                await fetch('/api/v1/bookmarks/oauth/disconnect', { method: 'POST', headers: { 'X-API-Key': API_KEY } });
            } catch {}
            await refreshBookmarksStatus();
            updateBookmarksModalUI();
            loadBookmarksActivity();
        }

        // Close bookmarks modal on overlay click
        document.getElementById('bookmarksModal').addEventListener('click', (e) => {
            if (e.target.id === 'bookmarksModal') {
                closeBookmarksModal();
            }
        });

        // =============================================
        // EXPORT FUNCTIONS
        // =============================================
        let exportPollInterval = null;
        let exportInProgress = false;
        let exportEstimatedBytes = 0;
        let usbDrives = [];
        let selectedUSBDrive = null;
        let usbAvailable = false;
        let usbEventSource = null;
        let formatPollInterval = null;

        // =============================================
        // USB REAL-TIME DETECTION (SSE)
        // =============================================
        function initUSBEventStream() {
            if (usbEventSource) {
                usbEventSource.close();
            }

            usbEventSource = new EventSource(`/api/v1/usb/drives/events?key=${API_KEY}`);

            usbEventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'init') {
                        // Initial drive list
                        usbDrives = data.drives || [];
                        usbAvailable = true;
                        renderUSBDrives();
                    } else if (data.type === 'added') {
                        // Drive added - refresh list
                        loadUSBDrives();
                        showNotification('USB drive connected', 'success');
                    } else if (data.type === 'removed') {
                        // Drive removed
                        usbDrives = usbDrives.filter(d => d.device !== data.device);
                        if (selectedUSBDrive && selectedUSBDrive.device === data.device) {
                            selectedUSBDrive = null;
                        }
                        renderUSBDrives();
                        showNotification('USB drive disconnected', 'info');
                    }
                } catch (e) {
                    console.warn('SSE parse error:', e);
                }
            };

            usbEventSource.onerror = () => {
                // Fall back to polling on SSE failure
                console.warn('SSE connection failed, falling back to polling');
                usbEventSource.close();
                usbEventSource = null;
            };
        }

        function closeUSBEventStream() {
            if (usbEventSource) {
                usbEventSource.close();
                usbEventSource = null;
            }
        }

        async function loadUSBDrives() {
            const driveList = document.getElementById('usbDriveList');
            const unavailable = document.getElementById('usbUnavailable');

            driveList.innerHTML = `
                <div class="usb-loading">
                    <div class="spinner" style="width: 24px; height: 24px;"></div>
                    <span>Scanning for USB drives...</span>
                </div>
            `;
            unavailable.style.display = 'none';

            try {
                // Add timeout to prevent endless spinning
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const resp = await fetch('/api/v1/usb/drives', {
                    headers: { 'X-API-Key': API_KEY },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!resp.ok) throw new Error('Failed to fetch USB drives');
                const data = await resp.json();

                usbAvailable = data.available;
                usbDrives = data.drives || [];

                const encryptionOpts = document.getElementById('encryptionOptions');

                if (!usbAvailable) {
                    driveList.innerHTML = '';
                    unavailable.style.display = 'block';
                    encryptionOpts.style.display = 'none';
                    return;
                }

                if (usbDrives.length === 0) {
                    driveList.innerHTML = `
                        <div class="usb-no-drives">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15 7v4h1v2h-3V5h2l-3-4-3 4h2v8H8v-2.07c.7-.37 1.2-1.08 1.2-1.93 0-1.21-.99-2.2-2.2-2.2-1.21 0-2.2.99-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37-1.2 1.1-1.2 1.95a2.2 2.2 0 0 0 4.4 0c0-.85-.49-1.58-1.2-1.95V15h3c1.11 0 2-.89 2-2v-2h1V7h-4z"/>
                            </svg>
                            <p>No USB drives detected</p>
                            <p style="font-size: 11px; margin-top: 4px;">Connect a USB drive to the server</p>
                        </div>
                    `;
                    encryptionOpts.style.display = 'none';
                    return;
                }

                encryptionOpts.style.display = 'block';
                renderUSBDrives();
            } catch (err) {
                console.error('USB drives error:', err);
                if (err.name === 'AbortError') {
                    driveList.innerHTML = `
                        <div class="usb-no-drives">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <p>USB service timeout</p>
                            <p style="font-size: 11px; margin-top: 4px;">The USB manager is not responding. Try closing and reopening this dialog.</p>
                        </div>
                    `;
                } else {
                    driveList.innerHTML = '';
                    unavailable.style.display = 'block';
                }
            }
        }

        function renderUSBDrives() {
            const driveList = document.getElementById('usbDriveList');
            driveList.innerHTML = usbDrives.map(drive => {
                const deviceName = drive.device.replace('/dev/', '');
                const label = drive.label || deviceName;
                const size = formatExportBytes(drive.size_bytes);
                const free = formatExportBytes(drive.free_bytes);
                const isSelected = selectedUSBDrive && selectedUSBDrive.device === drive.device;
                const driveDescription = `${drive.vendor || ''} ${drive.model || ''}`.trim() || 'USB Drive';

                return `
                    <div class="usb-drive-item ${isSelected ? 'selected' : ''}" onclick="selectUSBDrive('${drive.device}')">
                        <div class="usb-drive-header">
                            <div class="usb-drive-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15 7v4h1v2h-3V5h2l-3-4-3 4h2v8H8v-2.07c.7-.37 1.2-1.08 1.2-1.93 0-1.21-.99-2.2-2.2-2.2-1.21 0-2.2.99-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37-1.2 1.1-1.2 1.95a2.2 2.2 0 0 0 4.4 0c0-.85-.49-1.58-1.2-1.95V15h3c1.11 0 2-.89 2-2v-2h1V7h-4z"/>
                                </svg>
                            </div>
                            <div class="usb-drive-info">
                                <div class="usb-drive-name">
                                    ${label}
                                    ${drive.is_mounted ? '<span class="usb-mounted-badge">MOUNTED</span>' : ''}
                                </div>
                                <div class="usb-drive-meta">
                                    ${driveDescription}  ${size}${drive.is_mounted ? `  ${free} free` : ''}
                                </div>
                            </div>
                            <div class="usb-drive-actions" onclick="event.stopPropagation()">
                                ${drive.is_mounted
                                    ? `<button class="usb-drive-action" onclick="ejectUSBDrive('${drive.device}')">Eject</button>`
                                    : `<button class="usb-drive-action" onclick="mountUSBDrive('${drive.device}')">Mount</button>`
                                }
                                <button class="usb-drive-action" onclick="showRenameDialog('${drive.device}', '${deviceName}', '${(drive.label || '').replace(/'/g, "\\'")}')">Rename</button>
                                <button class="usb-drive-action danger" onclick="showFormatConfirm(usbDrives.find(d => d.device === '${drive.device}'))">Format</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectUSBDrive(device) {
            selectedUSBDrive = usbDrives.find(d => d.device === device);
            renderUSBDrives();

            const startBtn = document.getElementById('exportStartBtn');
            startBtn.disabled = !selectedUSBDrive || !selectedUSBDrive.is_mounted;
        }

        async function mountUSBDrive(device) {
            const deviceName = device.replace('/dev/', '');
            showNotification('Mounting drive...', 'info');

            try {
                const resp = await fetch(`/api/v1/usb/drives/${deviceName}/mount`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.message || 'Failed to mount drive');
                }
                await loadUSBDrives();
                selectUSBDrive(device);
                showNotification('Drive mounted successfully', 'success');
            } catch (err) {
                showNotification('Failed to mount drive: ' + err.message, 'error');
                await loadUSBDrives();
            }
        }

        async function ejectUSBDrive(device) {
            const deviceName = device.replace('/dev/', '');
            showNotification('Ejecting drive...', 'info');

            try {
                const resp = await fetch(`/api/v1/usb/drives/${deviceName}/unmount`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.message || 'Failed to eject drive');
                }
                if (selectedUSBDrive && selectedUSBDrive.device === device) {
                    selectedUSBDrive = null;
                }
                await loadUSBDrives();
                showNotification('Drive safely ejected. You can now remove it.', 'success');
            } catch (err) {
                showNotification('Failed to eject drive: ' + err.message, 'error');
                // Refresh drives to show current state
                await loadUSBDrives();
            }
        }

        let formatConfirmDevice = null;
        function showFormatConfirm(drive) {
            const deviceName = drive.device.replace('/dev/', '');
            const label = drive.label || deviceName;
            const size = formatExportBytes(drive.size_bytes);
            const vendor = drive.vendor || '';
            const model = drive.model || '';
            const driveDescription = `${vendor} ${model}`.trim() || 'USB Drive';

            formatConfirmDevice = { device: drive.device, deviceName };
            const html = `
                <div class="usb-format-confirm" id="formatConfirmOverlay" onclick="if(event.target===this)closeFormatConfirm()">
                    <div class="usb-format-confirm-box">
                        <h4 style="margin: 0 0 16px; font-size: 16px;">Format USB Drive</h4>

                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${label}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${driveDescription}</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${size}  /dev/${deviceName}</div>
                        </div>

                        <div class="usb-format-warning">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <p>This will <strong>ERASE ALL DATA</strong> on this drive. This cannot be undone.</p>
                        </div>
                        <div class="usb-format-input">
                            <label>Type "FORMAT" to confirm:</label>
                            <input type="text" id="formatConfirmInput" placeholder="FORMAT" autocomplete="off" style="text-transform: uppercase;">
                        </div>
                        <div class="usb-format-input">
                            <label>New drive label:</label>
                            <input type="text" id="formatLabelInput" placeholder="XGRABBA" value="XGRABBA" maxlength="11">
                        </div>
                        <div class="usb-format-actions">
                            <button class="export-btn-secondary" onclick="closeFormatConfirm()">Cancel</button>
                            <button class="export-btn-primary" style="background: var(--danger);" onclick="confirmFormat()">Format Drive</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('formatConfirmInput').focus();
        }

        function closeFormatConfirm() {
            const overlay = document.getElementById('formatConfirmOverlay');
            if (overlay) overlay.remove();
            formatConfirmDevice = null;
        }

        async function confirmFormat() {
            const input = document.getElementById('formatConfirmInput');
            const labelInput = document.getElementById('formatLabelInput');
            if (!formatConfirmDevice || input.value.toUpperCase() !== 'FORMAT') {
                alert('Please type FORMAT to confirm.');
                return;
            }

            const label = labelInput.value.trim() || 'XGRABBA';
            const deviceName = formatConfirmDevice.deviceName;
            const confirmToken = 'FORMAT';

            closeFormatConfirm();
            showFormatProgress(deviceName, label);

            try {
                // Start async format
                const resp = await fetch(`/api/v1/usb/drives/${deviceName}/format/async`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        filesystem: 'exfat',
                        label: label,
                        confirm_token: confirmToken
                    })
                });
                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.message || 'Failed to start format');
                }
                const result = await resp.json();

                // Poll for progress
                await pollFormatProgress(result.operation_id);
            } catch (err) {
                closeFormatProgress();
                showNotification('Failed to format drive: ' + err.message, 'error');
            }
        }

        function showFormatProgress(deviceName, label) {
            const html = `
                <div class="usb-format-confirm" id="formatProgressOverlay">
                    <div class="usb-format-confirm-box">
                        <h4 style="margin: 0 0 16px; font-size: 16px;">Formatting ${deviceName}</h4>
                        <div style="margin-bottom: 16px;">
                            <div style="background: var(--bg-tertiary); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="formatProgressBar" style="background: var(--accent-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="formatProgressText" style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                Starting format...
                            </div>
                        </div>
                        <p style="font-size: 11px; color: var(--text-muted);">New label: ${label}</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeFormatProgress() {
            const overlay = document.getElementById('formatProgressOverlay');
            if (overlay) overlay.remove();
        }

        async function pollFormatProgress(operationId) {
            const progressBar = document.getElementById('formatProgressBar');
            const progressText = document.getElementById('formatProgressText');

            while (true) {
                try {
                    const resp = await fetch(`/api/v1/usb/format/${operationId}`, {
                        headers: { 'X-API-Key': API_KEY }
                    });
                    if (!resp.ok) throw new Error('Failed to get format progress');

                    const data = await resp.json();

                    if (progressBar) progressBar.style.width = `${data.progress}%`;
                    if (progressText) progressText.textContent = data.phase || `${data.progress}% complete`;

                    if (data.phase === 'completed') {
                        closeFormatProgress();
                        showNotification('Drive formatted successfully', 'success');
                        await loadUSBDrives();
                        return;
                    } else if (data.phase === 'failed') {
                        closeFormatProgress();
                        showNotification('Format failed: ' + (data.error || 'Unknown error'), 'error');
                        return;
                    }

                    await new Promise(r => setTimeout(r, 500));
                } catch (err) {
                    closeFormatProgress();
                    showNotification('Format failed: ' + err.message, 'error');
                    return;
                }
            }
        }

        // =============================================
        // TOAST NOTIFICATIONS
        // =============================================
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.usb-notification');
            if (existing) existing.remove();

            const iconSvg = {
                success: '<svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;color:var(--success)"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
                error: '<svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;color:var(--danger)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
                info: '<svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;color:var(--accent-primary)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'
            };

            const notification = document.createElement('div');
            notification.className = `usb-notification ${type}`;
            notification.innerHTML = `${iconSvg[type] || iconSvg.info}<span>${message}</span>`;
            document.body.appendChild(notification);

            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(30px)';
                notification.style.transition = 'all 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // =============================================
        // DRIVE RENAME
        // =============================================
        function showRenameDialog(device, deviceName, currentLabel) {
            const html = `
                <div class="usb-rename-overlay" id="renameOverlay" onclick="if(event.target===this)closeRenameDialog()">
                    <div class="usb-rename-modal">
                        <h4>Rename Drive</h4>
                        <div class="usb-rename-input">
                            <label>Drive Label:</label>
                            <input type="text" id="renameInput" value="${currentLabel || ''}"
                                   maxlength="32" placeholder="Enter new label" autocomplete="off">
                        </div>
                        <div class="usb-rename-actions">
                            <button class="export-btn-secondary" onclick="closeRenameDialog()">Cancel</button>
                            <button class="export-btn-primary" onclick="confirmRename('${device}', '${deviceName}')">Rename</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);

            const input = document.getElementById('renameInput');
            input.focus();
            input.select();
        }

        function closeRenameDialog() {
            const overlay = document.getElementById('renameOverlay');
            if (overlay) overlay.remove();
        }

        async function confirmRename(device, deviceName) {
            const input = document.getElementById('renameInput');
            const newLabel = input.value.trim();

            if (!newLabel) {
                showNotification('Please enter a label', 'error');
                return;
            }

            closeRenameDialog();

            try {
                const resp = await fetch(`/api/v1/usb/drives/${deviceName}/rename`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({ label: newLabel })
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.message || data.error || 'Failed to rename drive');
                }

                showNotification(`Drive renamed to "${newLabel}"`, 'success');
                await loadUSBDrives();

            } catch (err) {
                showNotification('Rename failed: ' + err.message, 'error');
            }
        }

        async function startUSBExport() {
            if (!selectedUSBDrive || !selectedUSBDrive.is_mounted) {
                alert('Please select a mounted USB drive first.');
                return;
            }

            // Validate encryption settings
            const encryptionResult = validateEncryption();
            if (!encryptionResult.valid) {
                return;
            }

            try {
                const requestBody = {
                    download: false,
                    dest_path: selectedUSBDrive.mount_point,
                    include_viewers: true
                };

                if (encryptionResult.encrypt) {
                    requestBody.encrypt = true;
                    requestBody.password = encryptionResult.password;
                }

                const resp = await fetch('/api/v1/export/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify(requestBody)
                });

                if (resp.status === 409) {
                    alert('An export is already in progress.');
                    return;
                }

                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.error || 'Failed to start export');
                }

                exportInProgress = true;
                showExportView('progress');
                updateExportBtn(true);
                startExportPolling();
            } catch (err) {
                console.error('Start USB export error:', err);
                document.getElementById('exportErrorMessage').textContent = err.message;
                showExportView('error');
            }
        }

        async function openExportModal() {
            if (OFFLINE_MODE) {
                alert('Export is not available in offline mode.');
                return;
            }

            const overlay = document.getElementById('exportModalOverlay');
            overlay.classList.add('active');

            // Reset state
            selectedUSBDrive = null;
            showExportView('usb');

            // Fetch estimate
            try {
                const resp = await fetch('/api/v1/export/estimate', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!resp.ok) throw new Error('Failed to fetch estimate');
                const data = await resp.json();

                document.getElementById('exportUSBTweetCount').textContent = data.tweet_count.toLocaleString();
                document.getElementById('exportUSBMediaCount').textContent = data.media_count.toLocaleString();
                document.getElementById('exportUSBSize').textContent = formatExportBytes(data.estimated_size_bytes);
                exportEstimatedBytes = data.estimated_size_bytes || 0;
            } catch (err) {
                console.error('Export estimate error:', err);
            }

            // Initialize SSE for real-time USB detection
            initUSBEventStream();

            // Load USB drives
            await loadUSBDrives();

            // Check if there's already an export in progress
            try {
                const statusResp = await fetch('/api/v1/export/status', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (statusResp.ok) {
                    const status = await statusResp.json();
                    if (status.active) {
                        exportInProgress = true;
                        showExportView('progress');
                        updateExportProgress(status);
                        startExportPolling();
                    }
                }
            } catch {}
        }

        function closeExportModal() {
            document.getElementById('exportModalOverlay').classList.remove('active');
            stopExportPolling();
            closeUSBEventStream();

            // If export is in progress, switch to slower background polling
            // so the header progress indicator stays updated
            if (exportInProgress) {
                startBackgroundExportPolling();
            }

            // Reset encryption fields
            document.getElementById('encryptExport').checked = false;
            document.getElementById('encryptPassword').value = '';
            document.getElementById('encryptPasswordConfirm').value = '';
            document.getElementById('encryptionFields').style.display = 'none';
            document.getElementById('encryptionWarning').style.display = 'none';
        }

        function toggleEncryptionFields() {
            const checkbox = document.getElementById('encryptExport');
            const fields = document.getElementById('encryptionFields');
            fields.style.display = checkbox.checked ? 'block' : 'none';
            if (!checkbox.checked) {
                document.getElementById('encryptPassword').value = '';
                document.getElementById('encryptPasswordConfirm').value = '';
                document.getElementById('encryptionWarning').style.display = 'none';
            }
        }

        function validateEncryption() {
            const checkbox = document.getElementById('encryptExport');
            if (!checkbox.checked) return { valid: true, encrypt: false, password: '' };

            const password = document.getElementById('encryptPassword').value;
            const confirm = document.getElementById('encryptPasswordConfirm').value;
            const warning = document.getElementById('encryptionWarning');

            if (password.length < 8) {
                warning.textContent = 'Password must be at least 8 characters';
                warning.style.display = 'block';
                return { valid: false };
            }

            if (password !== confirm) {
                warning.textContent = 'Passwords do not match';
                warning.style.display = 'block';
                return { valid: false };
            }

            warning.style.display = 'none';
            return { valid: true, encrypt: true, password: password };
        }

        function showExportView(view) {
            const usbView = document.getElementById('exportUSBView');
            const progressView = document.getElementById('exportProgressView');
            const completedView = document.getElementById('exportCompletedView');
            const errorView = document.getElementById('exportErrorView');

            // Hide all views first
            usbView.style.display = 'none';
            progressView.style.display = 'none';
            completedView.style.display = 'none';
            errorView.style.display = 'none';

            // Show the appropriate view
            if (view === 'usb') {
                usbView.style.display = 'block';
            } else if (view === 'progress') {
                progressView.style.display = 'block';
            } else if (view === 'completed') {
                completedView.style.display = 'block';
            } else if (view === 'error') {
                errorView.style.display = 'block';
            }

            const footer = document.getElementById('exportModalFooter');
            const cancelBtn = document.getElementById('exportCancelBtn');
            const startBtn = document.getElementById('exportStartBtn');

            // Reset buttons to default state
            footer.style.display = 'flex';
            cancelBtn.style.display = 'inline-flex';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = closeExportModal;
            startBtn.style.display = 'inline-flex';
            startBtn.disabled = false;

            if (view === 'usb') {
                startBtn.disabled = !selectedUSBDrive || !selectedUSBDrive.is_mounted;
                startBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15 7v4h1v2h-3V5h2l-3-4-3 4h2v8H8v-2.07c.7-.37 1.2-1.08 1.2-1.93 0-1.21-.99-2.2-2.2-2.2-1.21 0-2.2.99-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37-1.2 1.1-1.2 1.95a2.2 2.2 0 0 0 4.4 0c0-.85-.49-1.58-1.2-1.95V15h3c1.11 0 2-.89 2-2v-2h1V7h-4z"/>
                    </svg>
                    Export to USB
                `;
                startBtn.onclick = startUSBExport;
            } else if (view === 'progress') {
                cancelBtn.style.display = 'none';
                startBtn.innerHTML = 'Cancel Export';
                startBtn.onclick = cancelExport;
            } else if (view === 'completed') {
                cancelBtn.style.display = 'none';
                startBtn.innerHTML = 'Close';
                startBtn.onclick = closeExportModal;
            } else if (view === 'error') {
                cancelBtn.textContent = 'Close';
                startBtn.innerHTML = 'Try Again';
                startBtn.onclick = function() {
                    showExportView('usb');
                };
            }
        }

        // Background polling interval (slower, for when modal is closed)
        let backgroundExportPollInterval = null;

        function startExportPolling() {
            // Stop any background polling first
            stopBackgroundExportPolling();
            if (exportPollInterval) return;
            exportPollInterval = setInterval(pollExportStatus, 500);
        }

        function stopExportPolling() {
            if (exportPollInterval) {
                clearInterval(exportPollInterval);
                exportPollInterval = null;
            }
        }

        // Background polling keeps progress indicator updated when modal is closed
        function startBackgroundExportPolling() {
            if (backgroundExportPollInterval) return;
            backgroundExportPollInterval = setInterval(pollExportStatus, 2000); // Slower when modal closed
        }

        function stopBackgroundExportPolling() {
            if (backgroundExportPollInterval) {
                clearInterval(backgroundExportPollInterval);
                backgroundExportPollInterval = null;
            }
        }

        async function pollExportStatus() {
            try {
                const resp = await fetch('/api/v1/export/status', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!resp.ok) return;

                const status = await resp.json();
                updateExportProgress(status);

                if (!status.active) {
                    stopExportPolling();
                    exportInProgress = false;
                    updateExportBtn(false);

                    if (status.phase === 'completed') {
                        const wasEncrypted = document.getElementById('encryptExport').checked;
                        const encryptedNote = wasEncrypted ? ' (encrypted)' : '';
                        document.getElementById('exportCompletedSummary').textContent =
                            `Exported ${status.exported_tweets} tweets (${formatExportBytes(status.bytes_written)})${encryptedNote}`;

                        // Show completed view FIRST, before auto-eject
                        showExportView('completed');

                        // Auto-eject the USB drive (fire and forget, don't block UI)
                        if (selectedUSBDrive) {
                            const deviceName = selectedUSBDrive.device.replace('/dev/', '');
                            fetch(`/api/v1/usb/drives/${deviceName}/unmount`, {
                                method: 'POST',
                                headers: { 'X-API-Key': API_KEY }
                            }).catch(err => console.error('Auto-eject failed:', err));
                            selectedUSBDrive = null;
                        }
                    } else if (status.phase === 'failed') {
                        document.getElementById('exportErrorMessage').textContent = status.error || 'Export failed';
                        showExportView('error');
                    } else if (status.phase === 'cancelled') {
                        document.getElementById('exportErrorMessage').textContent = 'Export was cancelled.';
                        showExportView('error');
                    }
                }
            } catch (err) {
                console.error('Poll export status error:', err);
            }
        }

        function updateExportProgress(status) {
            const percent = status.total_tweets > 0
                ? Math.round((status.exported_tweets / status.total_tweets) * 100)
                : 0;

            const phaseLabels = {
                preparing: 'Preparing...',
                exporting: 'Exporting...',
                encrypting: 'Encrypting...',
                finalizing: 'Finalizing...',
                completed: 'Complete!'
            };

            document.getElementById('exportPhase').textContent = phaseLabels[status.phase] || status.phase;
            document.getElementById('exportPercent').textContent = percent + '%';
            document.getElementById('exportProgressBar').style.width = percent + '%';
            document.getElementById('exportedTweets').textContent = `${status.exported_tweets} / ${status.total_tweets}`;

            // Show bytes written as "X / Y GB" format
            const writtenStr = formatExportBytes(status.bytes_written);
            const totalStr = exportEstimatedBytes > 0 ? formatExportBytes(exportEstimatedBytes) : '--';
            document.getElementById('exportBytesWritten').textContent = `${writtenStr} / ${totalStr}`;

            // Calculate transfer rate
            if (status.started_at && status.bytes_written > 0) {
                const elapsedSecs = (Date.now() / 1000) - status.started_at;
                if (elapsedSecs > 0) {
                    const bytesPerSec = status.bytes_written / elapsedSecs;
                    document.getElementById('exportTransferRate').textContent = formatExportBytes(bytesPerSec) + '/s';
                }
            } else {
                document.getElementById('exportTransferRate').textContent = '--';
            }

            const progressContainer = document.querySelector('.export-progress-container');
            if (progressContainer) {
                progressContainer.setAttribute('aria-valuenow', percent);
            }

            const currentFileEl = document.getElementById('exportCurrentFile');
            const currentFileNameEl = document.getElementById('exportCurrentFileName');
            if (status.current_file) {
                currentFileEl.style.display = 'block';
                currentFileNameEl.textContent = status.current_file;
            } else {
                currentFileEl.style.display = 'none';
            }

            // Update header button with phase info
            updateExportBtn(true, percent, status.phase);
        }

        function updateExportBtn(exporting, percent = 0, phase = '') {
            const btn = document.getElementById('exportBtn');
            const progressRing = document.getElementById('headerExportProgressRing');
            const tooltip = document.getElementById('exportProgressTooltip');

            if (exporting) {
                btn.classList.add('exporting');

                // Update progress ring - circumference = 2 * PI * 20 = 125.6
                const circumference = 125.6;
                const offset = circumference - (percent / 100) * circumference;
                progressRing.style.strokeDashoffset = offset;

                // Update tooltip with phase info
                const phaseLabels = {
                    preparing: 'Preparing',
                    exporting: 'Exporting',
                    encrypting: 'Encrypting',
                    finalizing: 'Finalizing'
                };
                const phaseLabel = phaseLabels[phase] || 'Exporting';
                tooltip.textContent = `${phaseLabel}: ${percent}%`;
                btn.title = `${phaseLabel}: ${percent}%`;

                // Show indeterminate spinner for preparing/finalizing phases
                if (phase === 'preparing' || phase === 'finalizing') {
                    btn.classList.add('indeterminate');
                    progressRing.style.strokeDashoffset = circumference * 0.75;
                } else {
                    btn.classList.remove('indeterminate');
                }
            } else {
                btn.classList.remove('exporting', 'indeterminate');
                progressRing.style.strokeDashoffset = 125.6;
                btn.title = 'Export Archive';
                // Stop background polling when export completes
                stopBackgroundExportPolling();
            }
        }

        async function cancelExport() {
            if (!confirm('Are you sure you want to cancel the export?')) {
                return;
            }

            try {
                await fetch('/api/v1/export/cancel', {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });
            } catch (err) {
                console.error('Cancel export error:', err);
            }
        }

        function formatExportBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Initial bookmarks status
        refreshBookmarksStatus();

        // Check for active export on page load
        async function checkActiveExport() {
            if (OFFLINE_MODE) return;
            try {
                const resp = await fetch('/api/v1/export/status', {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (resp.ok) {
                    const status = await resp.json();
                    if (status.active) {
                        exportInProgress = true;
                        const percent = status.total_tweets > 0
                            ? Math.round((status.exported_tweets / status.total_tweets) * 100)
                            : 0;
                        updateExportBtn(true, percent, status.phase);
                        // Start background polling to keep indicator updated
                        startBackgroundExportPolling();
                    }
                }
            } catch (err) {
                console.error('Check active export error:', err);
            }
        }
        checkActiveExport();
    </script>
</body>
</html>
